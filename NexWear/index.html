<!doctype html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WexWear.PK ‚Äî Print On Demand Store</title>
  <meta name="description" content="WexWear.PK ‚Äî Print on demand products, WhatsApp orders, admin dashboard, coupon, themes." />
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <style>
    :root{
      --accent:#10b981;
      --accent2:#064e3b;

      --bg:#070a12;
      --surface:#0b1220;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.04);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --border: rgba(148,163,184,.18);
      --ring: rgba(16,185,129,.30);
      --shadow: 0 18px 55px rgba(0,0,0,.45);

      --bgImage: none;
      --bgOverlayColor: rgba(0,0,0,0);
      --fontScale: 1;

      --heroTitleSize: 56px;
      --heroSubtitleSize: 18px;
      --heroTitleColor: var(--text);
      --heroSubtitleColor: var(--muted);
      --heroTitleWeight: 900;
      --heroTitleStyle: normal;
      --heroSubtitleStyle: normal;
    }
    html.light{
      --bg:#f8fafc;
      --surface:#ffffff;
      --card: rgba(2,6,23,.04);
      --card2: rgba(2,6,23,.03);
      --text:#0f172a;
      --muted:#475569;
      --border: rgba(15,23,42,.12);
      --ring: rgba(16,185,129,.22);
      --shadow: 0 18px 55px rgba(2,6,23,.12);
    }

    body{
      background-color: var(--bg);
      color: var(--text);
      background-image: linear-gradient(var(--bgOverlayColor), var(--bgOverlayColor)), var(--bgImage);
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      font-size: calc(16px * var(--fontScale));
    }

    .bg-surface{background:var(--surface);} 
    .bg-card{background:var(--card);} 
    .bg-card2{background:var(--card2);} 
    .text-muted{color:var(--muted);} 
    .border-soft{border-color:var(--border);} 
    .shadow-soft{box-shadow:var(--shadow);} 
    .ring-soft{box-shadow:0 0 0 4px var(--ring);} 
    .glass{background:var(--card); backdrop-filter: blur(10px); border:1px solid var(--border);} 
    .btn-accent{background:var(--accent); color:white;} 
    .btn-accent:hover{filter: brightness(.95);} 
    .btn-accent:active{transform: translateY(1px);} 
    .text-accent{color:var(--accent);} 
    .bg-accent{background:var(--accent);} 
    .bg-accent2{background:var(--accent2);} 
    .focus-ring:focus{outline:none; box-shadow:0 0 0 4px var(--ring);} 
    .modal-backdrop{background: rgba(2,6,23,.72);} 
    .no-scrollbar::-webkit-scrollbar{width:0;height:0;}
    .no-scrollbar{scrollbar-width:none;}

    .hero-title{
      font-size: var(--heroTitleSize) !important;
      color: var(--heroTitleColor) !important;
      font-weight: var(--heroTitleWeight) !important;
      font-style: var(--heroTitleStyle) !important;
      letter-spacing: -0.02em;
      line-height: 1.05;
    }
    .hero-subtitle{
      font-size: var(--heroSubtitleSize) !important;
      color: var(--heroSubtitleColor) !important;
      font-style: var(--heroSubtitleStyle) !important;
    }

    @media (max-width: 640px){
      :root{ --heroTitleSize: 40px; }
    }

    @media (prefers-reduced-motion: reduce){
      *{scroll-behavior:auto !important; transition:none !important; animation:none !important;}
    }
  </style>
</head>
<body class="min-h-full">

  <!-- ROUTED APPS -->
  <div id="storeApp" class="min-h-screen"></div>
  <div id="adminApp" class="min-h-screen hidden"></div>

  <!-- TOAST -->
  <div id="toast" class="fixed z-[100] left-1/2 -translate-x-1/2 bottom-5 hidden">
    <div class="glass shadow-soft rounded-2xl px-4 py-3 flex items-center gap-3">
      <div id="toastDot" class="h-2.5 w-2.5 rounded-full bg-accent"></div>
      <div>
        <div id="toastTitle" class="font-semibold">Info</div>
        <div id="toastMsg" class="text-sm text-muted"></div>
      </div>
      <button data-action="toast-close" class="ml-2 px-2 py-1 rounded-lg border border-soft hover:bg-card2">Close</button>
    </div>
  </div>

  <!-- CART DRAWER -->
  <div id="cartOverlay" class="fixed inset-0 z-[80] hidden">
    <div class="absolute inset-0 modal-backdrop" data-action="cart-close"></div>
    <aside class="absolute right-0 top-0 h-full w-full sm:w-[460px] bg-surface border-l border-soft shadow-soft">
      <div class="p-4 border-b border-soft flex items-center justify-between">
        <div>
          <div class="text-lg font-bold">Your Cart</div>
          <div class="text-sm text-muted">Review custom prints & checkout</div>
        </div>
        <button data-action="cart-close" class="px-3 py-2 rounded-xl border border-soft hover:bg-card2">‚úï</button>
      </div>
      <div class="p-4 overflow-y-auto h-[calc(100%-180px)] no-scrollbar" id="cartItems"></div>
      <div class="p-4 border-t border-soft">
        <div class="flex items-center justify-between">
          <div class="text-sm text-muted">Subtotal</div>
          <div id="cartSubtotal" class="font-semibold">Rs 0</div>
        </div>
        <button data-action="checkout-open" class="mt-3 w-full btn-accent rounded-2xl px-4 py-3 font-semibold">Checkout on WhatsApp</button>
        <button data-action="cart-clear" class="mt-2 w-full rounded-2xl px-4 py-3 border border-soft hover:bg-card2">Clear cart</button>
      </div>
    </aside>
  </div>

  <!-- CHECKOUT MODAL -->
  <div id="checkoutOverlay" class="fixed inset-0 z-[90] hidden">
    <div class="absolute inset-0 modal-backdrop" data-action="checkout-close"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="w-full max-w-3xl bg-surface border border-soft shadow-soft rounded-3xl overflow-hidden">
        <div class="p-5 border-b border-soft flex items-start justify-between gap-4">
          <div>
            <div class="text-xl font-bold">Checkout</div>
            <div class="text-sm text-muted">Order will be sent directly to your WhatsApp.</div>
          </div>
          <button data-action="checkout-close" class="px-3 py-2 rounded-xl border border-soft hover:bg-card2">‚úï</button>
        </div>
        <div class="grid md:grid-cols-2 gap-0">
          <div class="p-5 border-b md:border-b-0 md:border-r border-soft">
            <form id="checkoutForm" data-form="checkout" class="space-y-4">
              <div class="grid sm:grid-cols-2 gap-3">
                <div>
                  <label class="text-sm text-muted">Name</label>
                  <input required class="mt-1 w-full rounded-2xl bg-card2 border border-soft px-4 py-3 focus-ring" name="name" placeholder="Your name" />
                </div>
                <div>
                  <label class="text-sm text-muted">Phone</label>
                  <input required class="mt-1 w-full rounded-2xl bg-card2 border border-soft px-4 py-3 focus-ring" name="phone" placeholder="03xx..." />
                </div>
              </div>
              <div class="grid sm:grid-cols-2 gap-3">
                <div>
                  <label class="text-sm text-muted">City</label>
                  <input required class="mt-1 w-full rounded-2xl bg-card2 border border-soft px-4 py-3 focus-ring" name="city" placeholder="Karachi / Lahore..." />
                </div>
                <div>
                  <label class="text-sm text-muted">Delivery Note (optional)</label>
                  <input class="mt-1 w-full rounded-2xl bg-card2 border border-soft px-4 py-3 focus-ring" name="deliveryNote" placeholder="e.g. call before delivery" />
                </div>
              </div>
              <div>
                <label class="text-sm text-muted">Address</label>
                <textarea required class="mt-1 w-full rounded-2xl bg-card2 border border-soft px-4 py-3 focus-ring" name="address" rows="3" placeholder="House, street, area"></textarea>
              </div>
              <div>
                <label class="text-sm text-muted">Coupon code</label>
                <div class="mt-1 flex gap-2">
                  <input class="flex-1 rounded-2xl bg-card2 border border-soft px-4 py-3 focus-ring" id="couponInput" placeholder="e.g. WEX10" />
                  <button type="button" data-action="coupon-apply" class="px-4 py-3 rounded-2xl border border-soft hover:bg-card2">Apply</button>
                </div>
                <div id="couponStatus" class="mt-2 text-sm text-muted"></div>
              </div>
              <div>
                <label class="text-sm text-muted">Notes (optional)</label>
                <textarea class="mt-1 w-full rounded-2xl bg-card2 border border-soft px-4 py-3 focus-ring" name="notes" rows="2" placeholder="Any extra info"></textarea>
              </div>
              <button class="w-full btn-accent rounded-2xl px-4 py-3 font-semibold">Place Order ‚Üí WhatsApp</button>
              <div class="text-xs text-muted">
                Note: This demo saves products/orders in <b>your browser</b> (localStorage). For real multi-device admin, backend hosting is needed.
              </div>
            </form>
          </div>
          <div class="p-5">
            <div class="flex items-center justify-between">
              <div class="font-semibold">Order summary</div>
              <button data-action="cart-open" class="text-sm text-accent hover:underline">Edit cart</button>
            </div>
            <div id="checkoutSummary" class="mt-3 space-y-3"></div>
            <div class="mt-4 pt-4 border-t border-soft space-y-2">
              <div class="flex items-center justify-between"><span class="text-sm text-muted">Subtotal</span><span id="sumSubtotal" class="font-semibold">Rs 0</span></div>
              <div class="flex items-center justify-between"><span class="text-sm text-muted">Discount</span><span id="sumDiscount" class="font-semibold">- Rs 0</span></div>
              <div class="flex items-center justify-between text-lg"><span class="font-semibold">Total</span><span id="sumTotal" class="font-extrabold">Rs 0</span></div>
              <div class="mt-2 text-xs text-muted">Payment method: Cash on Delivery (customizable later)</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- CUSTOMIZER MODAL (PRINT TEXT) -->
  <div id="customOverlay" class="fixed inset-0 z-[85] hidden">
    <div class="absolute inset-0 modal-backdrop" data-action="custom-close"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="w-full max-w-4xl bg-surface border border-soft shadow-soft rounded-3xl overflow-hidden">
        <div class="p-5 border-b border-soft flex items-start justify-between gap-4">
          <div>
            <div class="text-xl font-bold">Customize Print</div>
            <div id="customSub" class="text-sm text-muted">Add your text and styling.</div>
          </div>
          <button data-action="custom-close" class="px-3 py-2 rounded-xl border border-soft hover:bg-card2">‚úï</button>
        </div>
        <div class="grid md:grid-cols-2 gap-0">
          <div class="p-5 border-b md:border-b-0 md:border-r border-soft">
            <div class="rounded-3xl border border-soft overflow-hidden bg-card2">
              <div id="customPreview" class="relative aspect-square w-full"></div>
            </div>
            <div class="mt-3 text-xs text-muted">Preview is for demo; final print may vary slightly.</div>
          </div>
          <div class="p-5">
            <form id="customForm" data-form="custom" class="space-y-4">
              <div>
                <label class="text-sm text-muted">Print text</label>
                <input id="customText" class="mt-1 w-full rounded-2xl bg-card2 border border-soft px-4 py-3 focus-ring" placeholder="e.g. WexWear" maxlength="80" />
              </div>
              <div class="grid grid-cols-2 gap-3">
                <div>
                  <label class="text-sm text-muted">Text color</label>
                  <input id="customColor" type="color" class="mt-1 h-12 w-full rounded-2xl border border-soft bg-surface" value="#ffffff" />
                </div>
                <div>
                  <label class="text-sm text-muted">Font size</label>
                  <input id="customSize" type="range" min="14" max="72" value="42" class="mt-3 w-full" />
                  <div class="mt-1 text-xs text-muted"><span id="customSizeVal">42</span> px</div>
                </div>
              </div>
              <div class="flex flex-wrap gap-3">
                <label class="inline-flex items-center gap-2 text-sm text-muted"><input id="customBold" type="checkbox" checked /> Bold</label>
                <label class="inline-flex items-center gap-2 text-sm text-muted"><input id="customItalic" type="checkbox" /> Italic</label>
              </div>
              <div class="pt-2 border-t border-soft flex flex-col gap-2">
                <button class="w-full btn-accent rounded-2xl px-4 py-3 font-semibold">Save & Add to Cart</button>
                <button type="button" data-action="custom-close" class="w-full rounded-2xl px-4 py-3 border border-soft hover:bg-card2">Cancel</button>
              </div>
              <div class="text-xs text-muted">
                Tip: Cart ⁄©€í ÿßŸÜÿØÿ± ÿ®⁄æ€å "Customize" ÿ≥€í ÿ¢Ÿæ design update ⁄©ÿ± ÿ≥⁄©ÿ™€í €Å€å⁄∫€î
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ADMIN ORDER DETAILS MODAL -->
  <div id="orderOverlay" class="fixed inset-0 z-[90] hidden">
    <div class="absolute inset-0 modal-backdrop" data-action="order-close"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="w-full max-w-4xl bg-surface border border-soft shadow-soft rounded-3xl overflow-hidden">
        <div class="p-5 border-b border-soft flex items-start justify-between gap-4">
          <div>
            <div id="orderModalTitle" class="text-xl font-bold">Order</div>
            <div id="orderModalSub" class="text-sm text-muted">Details</div>
          </div>
          <button data-action="order-close" class="px-3 py-2 rounded-xl border border-soft hover:bg-card2">‚úï</button>
        </div>
        <div class="p-5 grid md:grid-cols-2 gap-4">
          <div class="glass rounded-2xl p-4 border border-soft">
            <div class="font-semibold">Customer</div>
            <div id="orderCustomer" class="mt-2 text-sm text-muted"></div>
            <div class="mt-4 font-semibold">Delivery</div>
            <div id="orderDelivery" class="mt-2 text-sm text-muted"></div>
            <div class="mt-4 font-semibold">Actions</div>
            <div class="mt-2 flex flex-wrap gap-2">
              <button data-action="order-status" data-status="Pending" class="px-3 py-2 rounded-xl border border-soft hover:bg-card2">Mark Pending</button>
              <button data-action="order-status" data-status="Delivered" class="px-3 py-2 rounded-xl bg-accent text-white">Mark Delivered</button>
              <button data-action="order-status" data-status="Cancelled" class="px-3 py-2 rounded-xl border border-soft hover:bg-card2">Cancel</button>
              <button data-action="order-open-wa" class="px-3 py-2 rounded-xl border border-soft hover:bg-card2">Open WhatsApp</button>
            </div>
          </div>
          <div class="glass rounded-2xl p-4 border border-soft">
            <div class="font-semibold">Items</div>
            <div id="orderItems" class="mt-3 space-y-3"></div>
            <div class="mt-4 pt-4 border-t border-soft space-y-2">
              <div class="flex items-center justify-between"><span class="text-sm text-muted">Subtotal</span><span id="orderSubtotal" class="font-semibold"></span></div>
              <div class="flex items-center justify-between"><span class="text-sm text-muted">Discount</span><span id="orderDiscount" class="font-semibold"></span></div>
              <div class="flex items-center justify-between text-lg"><span class="font-semibold">Total</span><span id="orderTotal" class="font-extrabold"></span></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    (()=>{
      const LS_KEY = 'wexwear_state_v1';
      const LS_CART = 'wexwear_cart_v1';
      const SS_ADMIN = 'wexwear_admin_authed_v1';

      const THEMES = {
        emerald: { name:'Emerald', accent:'#10b981', accent2:'#064e3b' },
        indigo:  { name:'Indigo',  accent:'#6366f1', accent2:'#312e81' },
        rose:    { name:'Rose',    accent:'#f43f5e', accent2:'#881337' },
        amber:   { name:'Amber',   accent:'#f59e0b', accent2:'#78350f' },
        sky:     { name:'Sky',     accent:'#0ea5e9', accent2:'#0c4a6e' },
        violet:  { name:'Violet',  accent:'#8b5cf6', accent2:'#4c1d95' },
      };

      const DEFAULT_STATE = {
        version: 1,
        updatedAt: 0, // used for cloud sync conflict resolution
        settings: {
          storeName: 'WexWear.PK',
          whatsappNumber: '923102155721',
          announcement: 'WexWear.PK ‚Äî Print-on-Demand | WhatsApp Orders (Demo)',
          heroTitle: 'WexWear.PK ‚Äî Your Text, Your Style',
          heroSubtitle: 'T-shirts, hoodies, mugs aur caps par apna custom text print karwayein. Order WhatsApp par bhejein.',
          currencyLabel: 'Rs',
          coupon: { enabled: true, code: 'WEX10', percent: 10 },
          mode: 'dark',
          themeId: 'violet',
          customAccent: '',
          logoDataUrl: '',
          showFloatingWhatsApp: true,
          headerLinks: [
            { label:'Home', href:'#home' },
            { label:'Products', href:'#products' },
            { label:'How it works', href:'#how' },
          ],
          footerLinks: [
            { label:'Shipping', href:'#how' },
            { label:'Returns', href:'#how' },
            { label:'Contact', href:'#footer' },
          ],
          footerText: '¬© ' + new Date().getFullYear() + ' WexWear.PK. All rights reserved.',

          // NEW
          security: {
            passwordHash: ''
          },
          backend: {
            // Cloud sync (optional). Works even if you only run this HTML file.
            // provider:
            //  - 'firebase'  => Firebase Realtime Database URL (no server)
            //  - 'jsonblob'  => https://jsonblob.com blob URL (public)
            provider: 'firebase',
            enabled: false,
            baseUrl: '',
            token: '',
            path: 'wexwear_state_v1',
            autoSync: false,
          },
          design: {
            backgroundDataUrl: '',
            fontScale: 1,
            heroTitleSize: 56,
            heroSubtitleSize: 18,
            heroTitleColor: '',
            heroSubtitleColor: '',
            heroTitleBold: true,
            heroTitleItalic: false,
            heroSubtitleItalic: false,
          }
        },
        products: [
          {
            id:'p_tshirt',
            title:'Custom T‚ÄëShirt (Unisex)',
            price: 1299,
            compareAt: 1599,
            inStock: true,
            badge: 'Best Seller',
            emoji: 'üëï',
            imageDataUrl: '',
            description: 'Add your text, choose color & styling. (Demo)',
            customizable: true,
          },
          {
            id:'p_hoodie',
            title:'Premium Hoodie',
            price: 2599,
            compareAt: 2999,
            inStock: true,
            badge: 'Winter',
            emoji: 'üß•',
            imageDataUrl: '',
            description: 'Warm hoodie with custom front print text. (Demo)',
            customizable: true,
          },
          {
            id:'p_mug',
            title:'Ceramic Mug (11oz)',
            price: 799,
            compareAt: 999,
            inStock: true,
            badge: 'Gift',
            emoji: '‚òï',
            imageDataUrl: '',
            description: 'Custom text print for your coffee mug. (Demo)',
            customizable: true,
          },
          {
            id:'p_cap',
            title:'Cap / Hat',
            price: 699,
            compareAt: 899,
            inStock: true,
            badge: 'New',
            emoji: 'üß¢',
            imageDataUrl: '',
            description: 'Minimal cap with custom text embroidery print (demo).',
            customizable: true,
          },
          {
            id:'p_totebag',
            title:'Tote Bag',
            price: 899,
            compareAt: 1099,
            inStock: true,
            badge: 'Eco',
            emoji: 'üëú',
            imageDataUrl: '',
            description: 'Carry style with your own quote/text (demo).',
            customizable: true,
          },
          {
            id:'p_sticker',
            title:'Sticker Pack',
            price: 399,
            compareAt: 499,
            inStock: true,
            badge: 'Value',
            emoji: 'üè∑Ô∏è',
            imageDataUrl: '',
            description: 'A fun sticker pack for laptop & phone (demo).',
            customizable: false,
          },
        ],
        orders: []
      };

      const ui = {
        adminTab: 'dashboard',
        editingProductId: null,
        viewingOrderId: null,
        addImageDraft: '',
        editImageDraft: '',
        logoDraft: '',
        bgDraft: '',
        couponApplied: null,

        _showAddProduct: false,
        adminAuthed: sessionStorage.getItem(SS_ADMIN) === '1',

        customDraft: null, // { productId, mode:'add'|'edit', text,color,size,bold,italic }
      };

      const $ = (sel, root=document)=>root.querySelector(sel);
      const $$ = (sel, root=document)=>Array.from(root.querySelectorAll(sel));

      function safeParse(json, fallback){
        try{ return JSON.parse(json); } catch{ return fallback; }
      }

      function migrateLoaded(parsed){
        // merge with defaults
        const merged = {
          ...structuredClone(DEFAULT_STATE),
          ...parsed,
          settings: { ...structuredClone(DEFAULT_STATE.settings), ...(parsed.settings||{}) },
          products: Array.isArray(parsed.products) ? parsed.products : structuredClone(DEFAULT_STATE.products),
          orders: Array.isArray(parsed.orders) ? parsed.orders : [],
        };

        // ensure nested
        merged.settings.security = { ...structuredClone(DEFAULT_STATE.settings.security), ...(merged.settings.security||{}) };
        merged.settings.design = { ...structuredClone(DEFAULT_STATE.settings.design), ...(merged.settings.design||{}) };
        merged.settings.backend = { ...structuredClone(DEFAULT_STATE.settings.backend), ...(merged.settings.backend||{}) };

        // ensure product fields
        merged.products = merged.products.map(p=>({
          customizable: false,
          ...p,
        }));

        // updatedAt fallback for sync conflict resolution
        merged.updatedAt = Number(merged.updatedAt||0) || 0;

        return merged;
      }

      function loadState(){
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return structuredClone(DEFAULT_STATE);
        const parsed = safeParse(raw, null);
        if(!parsed || typeof parsed !== 'object') return structuredClone(DEFAULT_STATE);
        return migrateLoaded(parsed);
      }
      function saveState(opts={}){
        const touch = opts.touch !== false;
        const sync = opts.sync !== false;
        if(touch) state.updatedAt = Date.now();
        localStorage.setItem(LS_KEY, JSON.stringify(state));
        if(sync) backendMaybeAutoSync();
      }

      function backendCfg(){
        const b = state.settings.backend || {};
        const cleanBase = String(b.baseUrl||'').trim().replace(/\/+$/,'');
        const cleanPath = String(b.path||'wexwear_state_v1').trim().replace(/^\/+|\/+$/g,'');
        return {
          provider: String(b.provider||'firebase'),
          enabled: !!b.enabled,
          baseUrl: cleanBase,
          token: String(b.token||'').trim(),
          path: cleanPath,
          autoSync: !!b.autoSync,
        };
      }

      function backendEnabled(){
        const c = backendCfg();
        return c.enabled && !!c.baseUrl;
      }

      function backendStateUrl(){
        const c = backendCfg();
        if(c.provider === 'firebase'){
          const auth = c.token ? `?auth=${encodeURIComponent(c.token)}` : '';
          const p = c.path ? `/${c.path}` : '';
          return `${c.baseUrl}${p}.json${auth}`;
        }
        if(c.provider === 'jsonblob'){
          // Expect full API URL like: https://jsonblob.com/api/jsonBlob/<id>
          return c.baseUrl;
        }
        throw new Error('Unknown cloud provider.');
      }

      async function backendTest(){
        if(!backendEnabled()) { toast('Cloud sync not configured (enable + base URL).', 'Cloud Sync'); return; }
        const url = backendStateUrl();
        const res = await fetch(url, { method:'GET', headers:{'Accept':'application/json'} });
        if(!res.ok) throw new Error(`Connection failed (HTTP ${res.status}).`);
        toast('Connection OK', 'Cloud Sync');
      }

      async function backendPull(opts={}){
        const force = !!opts.force;
        if(!backendEnabled()) { toast('Cloud sync not configured (enable + base URL).', 'Cloud Sync'); return; }
        const url = backendStateUrl();
        const res = await fetch(url, { method:'GET', headers:{'Accept':'application/json'} });
        if(!res.ok) throw new Error(`Pull failed (HTTP ${res.status}).`);
        const data = await res.json();
        if(!data){ toast('No cloud data found.', 'Cloud Sync'); return; }
        const remote = migrateLoaded(data);
        const localAt = Number(state.updatedAt||0) || 0;
        const remoteAt = Number(remote.updatedAt||0) || 0;
        if(!force && localAt && remoteAt && remoteAt < localAt){
          const ok = confirm('Cloud data is older than local data. Overwrite local anyway?');
          if(!ok) return;
        }
        state = remote;
        saveState({ touch:false, sync:false });
        applyTheme();
        route();
        toast('Pulled from cloud', 'Cloud Sync');
      }

      async function backendPush(){
        if(!backendEnabled()) { toast('Cloud sync not configured (enable + base URL).', 'Cloud Sync'); return; }
        const url = backendStateUrl();
        const payload = structuredClone(state);
        payload.updatedAt = Date.now();
        const res = await fetch(url, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        if(!res.ok) throw new Error(`Push failed (HTTP ${res.status}).`);
        state.updatedAt = payload.updatedAt;
        saveState({ touch:false, sync:false });
        toast('Pushed to cloud', 'Cloud Sync');
      }

      function backendMaybeAutoSync(){
        const c = backendCfg();
        if(!c.enabled || !c.autoSync || !c.baseUrl) return;
        clearTimeout(backendMaybeAutoSync._t);
        backendMaybeAutoSync._t = setTimeout(()=>{
          backendPush().catch(err=>toast(err.message || 'Sync failed', 'Cloud Sync'));
        }, 900);
      }

      function loadCart(){
        const raw = localStorage.getItem(LS_CART);
        const parsed = raw ? safeParse(raw, null) : null;
        if(!parsed || !Array.isArray(parsed.items)) return { items: [] };
        return {
          items: parsed.items
            .filter(it=>it && it.productId && Number.isFinite(it.qty))
            .map(it=>({
              productId: String(it.productId||''),
              qty: Math.max(1, Math.min(99, Number(it.qty)||1)),
              custom: (it.custom && typeof it.custom === 'object') ? {
                text: String(it.custom.text||'').slice(0,80),
                color: String(it.custom.color||'#ffffff'),
                size: Math.max(10, Math.min(120, Number(it.custom.size||42)||42)),
                bold: !!it.custom.bold,
                italic: !!it.custom.italic,
              } : null
            }))
        };
      }
      function saveCart(){ localStorage.setItem(LS_CART, JSON.stringify(cart)); }

      function escapeHtml(str){
        return String(str ?? '')
          .replaceAll('&','&amp;')
          .replaceAll('<','&lt;')
          .replaceAll('>','&gt;')
          .replaceAll('"','&quot;')
          .replaceAll("'",'&#039;');
      }

      function money(n){
        const num = Number(n||0);
        return `${state.settings.currencyLabel} ${Math.round(num).toLocaleString('en-PK')}`;
      }

      function uid(prefix='WEX'){
        const rand = Math.random().toString(16).slice(2,6).toUpperCase();
        const t = Date.now().toString(36).toUpperCase();
        return `${prefix}-${rand}-${t}`;
      }

      function normalizeWaNumber(num){
        return String(num||'').replaceAll('+','').replaceAll(' ','').replaceAll('-','');
      }

      async function sha256Hex(str){
        const enc = new TextEncoder();
        const buf = await crypto.subtle.digest('SHA-256', enc.encode(String(str||'')));
        return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
      }

      function toast(msg, title='Done'){
        $('#toastTitle').textContent = title;
        $('#toastMsg').textContent = msg;
        $('#toast').classList.remove('hidden');
        clearTimeout(toast._t);
        toast._t = setTimeout(()=>$('#toast').classList.add('hidden'), 3300);
      }

      function setAdminAuthed(v){
        ui.adminAuthed = !!v;
        if(ui.adminAuthed) sessionStorage.setItem(SS_ADMIN, '1');
        else sessionStorage.removeItem(SS_ADMIN);
      }

      function applyTheme(){
        const s = state.settings;
        const t = THEMES[s.themeId] || THEMES.emerald;
        const accent = (s.customAccent && /^#([0-9a-fA-F]{3}){1,2}$/.test(s.customAccent)) ? s.customAccent : t.accent;
        document.documentElement.style.setProperty('--accent', accent);
        document.documentElement.style.setProperty('--accent2', t.accent2);

        if(s.mode === 'light') document.documentElement.classList.add('light');
        else document.documentElement.classList.remove('light');

        const d = s.design || {};
        const hasBg = !!d.backgroundDataUrl;
        document.documentElement.style.setProperty('--bgImage', hasBg ? `url(${d.backgroundDataUrl})` : 'none');
        document.documentElement.style.setProperty('--bgOverlayColor', hasBg ? (s.mode==='light' ? 'rgba(248,250,252,.72)' : 'rgba(2,6,23,.74)') : 'rgba(0,0,0,0)');

        const fontScale = Number(d.fontScale||1);
        document.documentElement.style.setProperty('--fontScale', String(Math.max(0.85, Math.min(1.25, fontScale))));

        const heroTitleSize = Number(d.heroTitleSize||56);
        const heroSubtitleSize = Number(d.heroSubtitleSize||18);
        document.documentElement.style.setProperty('--heroTitleSize', `${Math.max(30, Math.min(90, heroTitleSize))}px`);
        document.documentElement.style.setProperty('--heroSubtitleSize', `${Math.max(12, Math.min(40, heroSubtitleSize))}px`);

        document.documentElement.style.setProperty('--heroTitleColor', d.heroTitleColor || 'var(--text)');
        document.documentElement.style.setProperty('--heroSubtitleColor', d.heroSubtitleColor || 'var(--muted)');
        document.documentElement.style.setProperty('--heroTitleWeight', d.heroTitleBold ? '900' : '800');
        document.documentElement.style.setProperty('--heroTitleStyle', d.heroTitleItalic ? 'italic' : 'normal');
        document.documentElement.style.setProperty('--heroSubtitleStyle', d.heroSubtitleItalic ? 'italic' : 'normal');
      }

      function productById(id){ return state.products.find(p=>p.id===id); }

      function cartCount(){ return cart.items.reduce((a,it)=>a+it.qty,0); }
      function cartSubtotal(){
        return cart.items.reduce((sum, it)=>{
          const p = productById(it.productId);
          if(!p) return sum;
          return sum + (Number(p.price)||0) * it.qty;
        }, 0);
      }

      function calcDiscount(subtotal, coupon){
        if(!coupon) return 0;
        const pct = Number(coupon.percent||0);
        if(!pct) return 0;
        return Math.round((subtotal * pct)/100);
      }

      function validateCoupon(input){
        const s = state.settings;
        if(!s.coupon?.enabled) return null;
        const code = String(input||'').trim();
        if(!code) return null;
        if(code.toUpperCase() !== String(s.coupon.code||'').trim().toUpperCase()) return null;
        return { code: s.coupon.code, percent: Number(s.coupon.percent||10) || 10 };
      }

      function ensureCustomizerDefault(productId){
        const cartItem = cart.items.find(x=>x.productId===productId);
        const existing = cartItem?.custom;
        return {
          productId,
          text: existing?.text || '',
          color: existing?.color || '#ffffff',
          size: existing?.size || 42,
          bold: existing?.bold ?? true,
          italic: existing?.italic ?? false,
        };
      }

      function openCustomizer(productId, mode='add'){
        const p = productById(productId);
        if(!p) return;
        ui.customDraft = { ...ensureCustomizerDefault(productId), mode };
        $('#customSub').textContent = `${p.title} ‚Äî customize text & styling`;

        // set UI controls
        $('#customText').value = ui.customDraft.text;
        $('#customColor').value = ui.customDraft.color;
        $('#customSize').value = String(ui.customDraft.size);
        $('#customSizeVal').textContent = String(ui.customDraft.size);
        $('#customBold').checked = !!ui.customDraft.bold;
        $('#customItalic').checked = !!ui.customDraft.italic;

        renderCustomizerPreview();
        $('#customOverlay').classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
        setTimeout(()=>$('#customText')?.focus(), 0);
      }

      function closeCustomizer(){
        $('#customOverlay').classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
        ui.customDraft = null;
      }

      function renderCustomizerPreview(){
        const draft = ui.customDraft;
        if(!draft) return;
        const p = productById(draft.productId);
        if(!p) return;

        const bg = p.imageDataUrl
          ? `<img src="${p.imageDataUrl}" alt="${escapeHtml(p.title)}" class="absolute inset-0 h-full w-full object-cover" />`
          : `<div class="absolute inset-0" style="background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.10), transparent 60%), linear-gradient(135deg, rgba(255,255,255,.06), rgba(255,255,255,.02));"></div>
             <div class="absolute inset-0 opacity-60" style="background: radial-gradient(circle at 30% 30%, var(--accent), transparent 55%);"></div>
             <div class="absolute inset-0 flex items-center justify-center text-6xl">${escapeHtml(p.emoji||'üé®')}</div>`;

        const textSafe = escapeHtml(draft.text || '');
        const fontWeight = draft.bold ? 900 : 700;
        const fontStyle = draft.italic ? 'italic' : 'normal';

        $('#customPreview').innerHTML = `
          <div class="absolute inset-0">
            ${bg}
            <div class="absolute inset-0" style="background: linear-gradient(180deg, rgba(0,0,0,.10), rgba(0,0,0,.10));"></div>
            <div class="absolute inset-0 flex items-center justify-center p-6">
              <div class="text-center break-words" style="
                color: ${escapeHtml(draft.color)};
                font-size: ${Number(draft.size)||42}px;
                font-weight: ${fontWeight};
                font-style: ${fontStyle};
                text-shadow: 0 10px 24px rgba(0,0,0,.35);
                line-height: 1.05;
              ">${textSafe || '<span style="opacity:.55">Your text</span>'}</div>
            </div>
          </div>
        `;
      }

      function addToCart(productId, qty=1, custom=null){
        const p = productById(productId);
        if(!p) return;
        if(!p.inStock){ toast('This item is out of stock.', 'Out of stock'); return; }

        if(p.customizable && !custom){
          openCustomizer(productId, 'add');
          return;
        }

        const item = cart.items.find(i=>i.productId===productId);
        if(item){
          item.qty += qty;
          if(custom) item.custom = custom;
        } else {
          cart.items.push({ productId, qty, custom: custom || null });
        }
        saveCart();
        renderStoreHeaderBadge();
        toast('Added to cart', p.title);
      }

      function setCartCustom(productId, custom){
        const item = cart.items.find(i=>i.productId===productId);
        if(!item) return;
        item.custom = custom;
        saveCart();
        renderCart();
        renderCheckoutSummary();
        toast('Design updated', 'Customization');
      }

      function setQty(productId, qty){
        const item = cart.items.find(i=>i.productId===productId);
        if(!item) return;
        item.qty = Math.max(1, Math.min(99, Number(qty)||1));
        saveCart();
        renderCart();
        renderCheckoutSummary();
        renderStoreHeaderBadge();
      }

      function removeFromCart(productId){
        cart.items = cart.items.filter(i=>i.productId!==productId);
        saveCart();
        renderCart();
        renderCheckoutSummary();
        renderStoreHeaderBadge();
      }

      function clearCart(){
        cart.items = [];
        ui.couponApplied = null;
        saveCart();
        renderCart();
        renderCheckoutSummary();
        renderStoreHeaderBadge();
      }

      function openCart(){
        renderCart();
        $('#cartOverlay').classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
      }
      function closeCart(){
        $('#cartOverlay').classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
      }

      function openCheckout(){
        if(cart.items.length===0){ toast('Cart is empty.', 'Checkout'); return; }
        renderCheckoutSummary();
        $('#checkoutOverlay').classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
        $('#couponStatus').textContent = ui.couponApplied ? `Applied: ${ui.couponApplied.code} (${ui.couponApplied.percent}% off)` : '';
        $('#couponInput').value = ui.couponApplied?.code || '';
      }
      function closeCheckout(){
        $('#checkoutOverlay').classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
      }

      function waMessageForOrder(order){
        const s = state.settings;
        const lines = [];
        lines.push(`*${s.storeName} ‚Äî New Print Order*`);
        lines.push(`Order ID: *${order.id}*`);
        lines.push(`Date: ${new Date(order.createdAt).toLocaleString()}`);
        lines.push('');
        lines.push('*Customer*');
        lines.push(`Name: ${order.customer.name}`);
        lines.push(`Phone: ${order.customer.phone}`);
        lines.push(`City: ${order.customer.city}`);
        lines.push(`Address: ${order.customer.address}`);
        if(order.customer.deliveryNote) lines.push(`Delivery: ${order.customer.deliveryNote}`);
        if(order.customer.notes) lines.push(`Notes: ${order.customer.notes}`);
        lines.push('');
        lines.push('*Items*');
        (order.items||[]).forEach((it, idx)=>{
          lines.push(`${idx+1}) ${it.title} ‚Äî ${money(it.price)} x ${it.qty} = ${money(it.price*it.qty)}`);
          if(it.custom?.text){
            lines.push(`   ‚Ä¢ Print text: "${it.custom.text}"`);
            lines.push(`   ‚Ä¢ Style: ${it.custom.size}px, ${it.custom.color}${it.custom.bold?' bold':''}${it.custom.italic?' italic':''}`);
          }
        });
        lines.push('');
        lines.push(`Subtotal: ${money(order.subtotal)}`);
        if(order.coupon){
          lines.push(`Discount (${order.coupon.code} -${order.coupon.percent}%): -${money(order.discount)}`);
        }
        lines.push(`Total: *${money(order.total)}*`);
        lines.push('');
        lines.push('Please confirm print details & delivery time.');
        return lines.join('\n');
      }

      function openWhatsAppWithText(text){
        const wa = normalizeWaNumber(state.settings.whatsappNumber);
        const url = `https://wa.me/${wa}?text=${encodeURIComponent(text)}`;
        window.open(url, '_blank', 'noopener,noreferrer');
      }

      function placeOrder(form){
        const fd = new FormData(form);
        const customer = {
          name: String(fd.get('name')||'').trim(),
          phone: String(fd.get('phone')||'').trim(),
          city: String(fd.get('city')||'').trim(),
          address: String(fd.get('address')||'').trim(),
          deliveryNote: String(fd.get('deliveryNote')||'').trim(),
          notes: String(fd.get('notes')||'').trim(),
        };
        if(!customer.name || !customer.phone || !customer.city || !customer.address){
          toast('Please fill all required fields.', 'Checkout');
          return;
        }

        const items = cart.items.map(it=>{
          const p = productById(it.productId);
          return {
            productId: it.productId,
            title: p?.title || it.productId,
            price: Number(p?.price||0),
            qty: it.qty,
            custom: it.custom || null,
          };
        }).filter(it=>it.title);

        const subtotal = cartSubtotal();
        const applied = ui.couponApplied;
        const discount = calcDiscount(subtotal, applied);
        const total = Math.max(0, subtotal - discount);

        const order = {
          id: uid('WEX'),
          createdAt: Date.now(),
          status: 'Pending',
          customer,
          items,
          subtotal,
          discount,
          total,
          coupon: applied,
        };

        state.orders.unshift(order);
        saveState();

        const msg = waMessageForOrder(order);
        closeCheckout();
        clearCart();

        toast(`Order created: ${order.id}`, 'Success');
        openWhatsAppWithText(msg);

        if(location.hash==='#admin' && ui.adminAuthed){
          renderAdmin();
          wireAdminOrdersFilter();
        }
      }

      function renderStore(){
        const s = state.settings;
        const store = $('#storeApp');

        store.innerHTML = `
          <div id="home" class="relative">
            <div class="absolute inset-0 pointer-events-none">
              <div class="absolute -top-24 -left-24 h-72 w-72 rounded-full blur-3xl opacity-30" style="background: radial-gradient(circle at 30% 30%, var(--accent), transparent 60%);"></div>
              <div class="absolute -bottom-28 -right-24 h-80 w-80 rounded-full blur-3xl opacity-25" style="background: radial-gradient(circle at 30% 30%, var(--accent2), transparent 60%);"></div>
            </div>

            ${s.announcement ? `
              <div class="relative z-10 border-b border-soft bg-card2">
                <div class="mx-auto max-w-6xl px-4 py-2 text-sm text-muted flex items-center justify-between gap-3">
                  <div class="truncate">${escapeHtml(s.announcement)}</div>
                  <a class="text-accent hover:underline text-sm" href="#products">Shop now</a>
                </div>
              </div>
            `:''}

            <header class="relative z-10">
              <div class="mx-auto max-w-6xl px-4 py-4 flex items-center justify-between gap-3">
                <div class="flex items-center gap-3">
                  <a href="#home" class="flex items-center gap-3">
                    ${s.logoDataUrl ? `<img src="${s.logoDataUrl}" alt="logo" class="h-10 w-10 rounded-2xl object-cover border border-soft"/>` : `
                      <div class="h-10 w-10 rounded-2xl bg-accent text-white flex items-center justify-center font-black">WW</div>
                    `}
                    <div>
                      <div class="font-extrabold tracking-tight text-lg">${escapeHtml(s.storeName)}</div>
                      <div class="text-xs text-muted -mt-0.5">Print‚Äëon‚ÄëDemand ‚Ä¢ WhatsApp Orders</div>
                    </div>
                  </a>
                </div>

                <nav class="hidden md:flex items-center gap-2">
                  ${(s.headerLinks||[]).map(l=>`
                    <a class="px-3 py-2 rounded-xl hover:bg-card2 text-sm" href="${escapeHtml(l.href)}">${escapeHtml(l.label)}</a>
                  `).join('')}
                  <a class="px-3 py-2 rounded-xl hover:bg-card2 text-sm" href="#admin" title="Admin">Admin</a>
                </nav>

                <div class="flex items-center gap-2">
                  <button data-action="toggle-mode" class="hidden sm:inline-flex px-3 py-2 rounded-xl border border-soft hover:bg-card2 text-sm" title="Toggle light/dark">
                    <span class="text-muted">${s.mode==='light' ? 'Light' : 'Dark'}</span>
                  </button>
                  <button data-action="cart-open" class="relative px-4 py-2 rounded-2xl border border-soft hover:bg-card2">
                    <span class="font-semibold">Cart</span>
                    <span id="cartBadge" class="absolute -top-2 -right-2 h-6 min-w-6 px-2 rounded-full bg-accent text-white text-xs flex items-center justify-center">0</span>
                  </button>
                  <button class="md:hidden px-3 py-2 rounded-xl border border-soft hover:bg-card2" data-action="mobile-menu">‚ò∞</button>
                </div>
              </div>

              <div id="mobileMenu" class="md:hidden hidden border-t border-soft bg-surface">
                <div class="mx-auto max-w-6xl px-4 py-3 flex flex-col gap-2">
                  ${(s.headerLinks||[]).map(l=>`
                    <a class="px-3 py-2 rounded-xl hover:bg-card2 text-sm" href="${escapeHtml(l.href)}">${escapeHtml(l.label)}</a>
                  `).join('')}
                  <a class="px-3 py-2 rounded-xl hover:bg-card2 text-sm" href="#admin">Admin Dashboard</a>
                </div>
              </div>
            </header>

            <section class="relative z-10">
              <div class="mx-auto max-w-6xl px-4 pt-10 pb-8">
                <div class="grid lg:grid-cols-2 gap-8 items-center">
                  <div>
                    <div class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full border border-soft bg-card2 text-sm text-muted">
                      <span class="h-2 w-2 rounded-full bg-accent"></span>
                      Custom Print Text Enabled
                    </div>
                    <h1 class="mt-4 hero-title">${escapeHtml(s.heroTitle)}</h1>
                    <p class="mt-4 hero-subtitle">${escapeHtml(s.heroSubtitle)}</p>
                    <div class="mt-6 flex flex-col sm:flex-row gap-3">
                      <a href="#products" class="btn-accent rounded-2xl px-5 py-3 font-semibold inline-flex items-center justify-center">Browse Products</a>
                      <button data-action="open-whatsapp" class="rounded-2xl px-5 py-3 border border-soft hover:bg-card2 font-semibold inline-flex items-center justify-center">Chat on WhatsApp</button>
                    </div>
                    <div class="mt-6 grid grid-cols-3 gap-3">
                      <div class="glass rounded-2xl p-3">
                        <div class="text-sm text-muted">Coupon</div>
                        <div class="font-bold">${s.coupon?.enabled ? (escapeHtml(s.coupon.code) + ` (-${Number(s.coupon.percent||10)}%)`) : 'Disabled'}</div>
                      </div>
                      <div class="glass rounded-2xl p-3">
                        <div class="text-sm text-muted">Print</div>
                        <div class="font-bold">Text Styling</div>
                      </div>
                      <div class="glass rounded-2xl p-3">
                        <div class="text-sm text-muted">Admin</div>
                        <div class="font-bold">Password</div>
                      </div>
                    </div>
                  </div>

                  <div class="relative">
                    <div class="glass rounded-3xl p-4 border border-soft shadow-soft">
                      <div class="flex items-center justify-between">
                        <div>
                          <div class="font-bold">Featured</div>
                          <div class="text-sm text-muted">Popular picks from ${escapeHtml(s.storeName)}</div>
                        </div>
                        <span class="text-xs px-2 py-1 rounded-full border border-soft text-muted">Live preview</span>
                      </div>
                      <div class="mt-4 grid grid-cols-2 gap-3">
                        ${state.products.slice(0,4).map(p=>featuredCard(p)).join('')}
                      </div>
                    </div>
                    <div class="absolute -z-10 -bottom-10 -left-10 h-40 w-40 blur-3xl opacity-30" style="background: radial-gradient(circle at 30% 30%, var(--accent), transparent 60%);"></div>
                  </div>
                </div>
              </div>
            </section>
          </div>

          <section id="products" class="relative">
            <div class="mx-auto max-w-6xl px-4 py-10">
              <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3">
                <div>
                  <div class="text-sm text-muted">Print Shop</div>
                  <h2 class="text-2xl sm:text-3xl font-extrabold">Products</h2>
                </div>
                <div class="flex gap-2">
                  <div class="relative">
                    <input id="productSearch" class="w-full sm:w-72 rounded-2xl bg-card2 border border-soft px-4 py-3 focus-ring" placeholder="Search products..." />
                  </div>
                  <button data-action="refresh-store" class="px-4 py-3 rounded-2xl border border-soft hover:bg-card2">Refresh</button>
                </div>
              </div>

              <div id="productGrid" class="mt-6 grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
                ${state.products.map(p=>productCard(p)).join('')}
              </div>
            </div>
          </section>

          <section id="how" class="relative">
            <div class="mx-auto max-w-6xl px-4 py-10">
              <div class="glass rounded-3xl p-6 border border-soft">
                <div class="grid md:grid-cols-3 gap-4">
                  <div class="p-4 rounded-2xl bg-card2 border border-soft">
                    <div class="font-bold">1) Customize</div>
                    <div class="text-sm text-muted mt-1">Apna text likhein, color/size/bold/italic select karein.</div>
                  </div>
                  <div class="p-4 rounded-2xl bg-card2 border border-soft">
                    <div class="font-bold">2) Add to cart</div>
                    <div class="text-sm text-muted mt-1">Cart banayein aur coupon (optional) apply karein.</div>
                  </div>
                  <div class="p-4 rounded-2xl bg-card2 border border-soft">
                    <div class="font-bold">3) WhatsApp order</div>
                    <div class="text-sm text-muted mt-1">Checkout par click karte hi order WhatsApp me open hojayega.</div>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <footer id="footer" class="border-t border-soft">
            <div class="mx-auto max-w-6xl px-4 py-10">
              <div class="grid md:grid-cols-3 gap-6">
                <div>
                  <div class="font-extrabold text-xl">${escapeHtml(s.storeName)}</div>
                  <div class="text-sm text-muted mt-2">Order direct WhatsApp: <span class="text-accent">+${escapeHtml(s.whatsappNumber)}</span></div>
                  <div class="mt-4 flex gap-2">
                    <button data-action="open-whatsapp" class="px-4 py-2 rounded-2xl btn-accent font-semibold">WhatsApp</button>
                    <a href="#admin" class="px-4 py-2 rounded-2xl border border-soft hover:bg-card2 font-semibold">Admin</a>
                  </div>
                </div>
                <div>
                  <div class="font-semibold">Links</div>
                  <div class="mt-3 flex flex-col gap-2">
                    ${(s.footerLinks||[]).map(l=>`<a class="text-sm text-muted hover:text-accent" href="${escapeHtml(l.href)}">${escapeHtml(l.label)}</a>`).join('')}
                  </div>
                </div>
                <div>
                  <div class="font-semibold">Trust</div>
                  <div class="mt-3 grid grid-cols-2 gap-2">
                    <div class="p-3 rounded-2xl bg-card2 border border-soft text-sm text-muted">Custom Print</div>
                    <div class="p-3 rounded-2xl bg-card2 border border-soft text-sm text-muted">Quality Material</div>
                    <div class="p-3 rounded-2xl bg-card2 border border-soft text-sm text-muted">Fast Dispatch</div>
                    <div class="p-3 rounded-2xl bg-card2 border border-soft text-sm text-muted">Support</div>
                  </div>
                </div>
              </div>
              <div class="mt-8 pt-6 border-t border-soft text-sm text-muted flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
                <div>${escapeHtml(s.footerText)}</div>
                <div class="flex items-center gap-2">
                  <button data-action="reset-demo" class="px-3 py-2 rounded-xl border border-soft hover:bg-card2">Reset demo</button>
                  <button data-action="toggle-mode" class="px-3 py-2 rounded-xl border border-soft hover:bg-card2">Toggle mode</button>
                </div>
              </div>
            </div>
          </footer>

          ${s.showFloatingWhatsApp ? `
            <button data-action="open-whatsapp" class="fixed z-[70] bottom-5 right-5 btn-accent shadow-soft rounded-full px-4 py-3 font-semibold">
              WhatsApp
            </button>
          `:''}
        `;

        renderStoreHeaderBadge();
      }

      function featuredCard(p){
        const img = productImage(p, true);
        const btnLabel = p.customizable ? 'Customize' : 'Add';
        const btnAction = p.customizable ? 'customize' : 'add';
        return `
          <div class="rounded-2xl border border-soft bg-card2 overflow-hidden">
            ${img}
            <div class="p-3">
              <div class="font-semibold text-sm line-clamp-1">${escapeHtml(p.title)}</div>
              <div class="mt-1 flex items-center justify-between">
                <div class="font-extrabold">${money(p.price)}</div>
                <button data-action="${btnAction}" data-id="${escapeHtml(p.id)}" class="px-3 py-2 rounded-xl btn-accent text-sm font-semibold">${btnLabel}</button>
              </div>
            </div>
          </div>
        `;
      }

      function productImage(p, compact=false){
        if(p.imageDataUrl){
          return `<div class="${compact?'h-24':'h-44'} w-full bg-card2"><img class="h-full w-full object-cover" src="${p.imageDataUrl}" alt="${escapeHtml(p.title)}" /></div>`;
        }
        const em = escapeHtml(p.emoji || 'üõçÔ∏è');
        return `
          <div class="${compact?'h-24':'h-44'} w-full relative overflow-hidden" style="background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.12), transparent 60%), linear-gradient(135deg, rgba(255,255,255,.06), rgba(255,255,255,.02));">
            <div class="absolute inset-0 opacity-60" style="background: radial-gradient(circle at 30% 30%, var(--accent), transparent 55%);"></div>
            <div class="absolute inset-0 flex items-center justify-center text-4xl">${em}</div>
          </div>
        `;
      }

      function productCard(p){
        const badge = p.badge ? `<span class="absolute top-3 left-3 text-xs px-2 py-1 rounded-full bg-surface border border-soft">${escapeHtml(p.badge)}</span>` : '';
        const stock = p.inStock ? `<span class="text-xs px-2 py-1 rounded-full border border-soft text-muted">In stock</span>` : `<span class="text-xs px-2 py-1 rounded-full border border-soft text-muted">Out of stock</span>`;
        const compare = p.compareAt && p.compareAt > p.price ? `<span class="text-sm text-muted line-through">${money(p.compareAt)}</span>` : '';

        const primaryLabel = p.customizable ? 'Customize' : 'Add';
        const primaryAction = p.customizable ? 'customize' : 'add';

        return `
          <div class="group rounded-3xl border border-soft bg-card overflow-hidden shadow-soft">
            <div class="relative">
              ${productImage(p)}
              ${badge}
              ${p.customizable ? `<span class="absolute bottom-3 left-3 text-xs px-2 py-1 rounded-full bg-surface border border-soft">Custom text</span>` : ''}
            </div>
            <div class="p-4">
              <div>
                <div class="font-bold text-lg leading-snug">${escapeHtml(p.title)}</div>
                <div class="mt-1 text-sm text-muted line-clamp-2">${escapeHtml(p.description||'')}</div>
              </div>

              <div class="mt-4 flex items-center justify-between">
                <div>
                  <div class="font-extrabold text-xl">${money(p.price)}</div>
                  <div class="mt-1 flex items-center gap-2">${compare}${stock}</div>
                </div>
                <div class="flex flex-col gap-2">
                  <button data-action="${primaryAction}" data-id="${escapeHtml(p.id)}" class="px-4 py-2.5 rounded-2xl btn-accent font-semibold disabled:opacity-50" ${p.inStock? '' : 'disabled'}>
                    ${primaryLabel}
                  </button>
                  <button data-action="buy-wa" data-id="${escapeHtml(p.id)}" class="px-4 py-2.5 rounded-2xl border border-soft hover:bg-card2 font-semibold">
                    WhatsApp
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      function renderStoreHeaderBadge(){
        const el = $('#cartBadge');
        if(!el) return;
        el.textContent = String(cartCount());
        el.style.display = cartCount() ? 'flex' : 'none';
      }

      function renderCart(){
        const root = $('#cartItems');
        if(!root) return;
        if(cart.items.length===0){
          root.innerHTML = `
            <div class="p-6 rounded-3xl border border-soft bg-card2 text-center">
              <div class="text-4xl">üõí</div>
              <div class="mt-2 font-bold">Cart is empty</div>
              <div class="mt-1 text-sm text-muted">Customize a product to continue.</div>
              <button data-action="cart-close" class="mt-4 px-4 py-3 rounded-2xl border border-soft hover:bg-card2">Browse products</button>
            </div>
          `;
          $('#cartSubtotal').textContent = money(0);
          return;
        }

        root.innerHTML = cart.items.map(it=>{
          const p = productById(it.productId);
          if(!p) return '';

          const customLine = it.custom?.text ? `
            <div class="mt-1 text-xs text-muted">Print: <span class="text-accent font-semibold">${escapeHtml(it.custom.text)}</span> ‚Ä¢ ${escapeHtml(it.custom.color)} ‚Ä¢ ${it.custom.size}px${it.custom.bold?' ‚Ä¢ bold':''}${it.custom.italic?' ‚Ä¢ italic':''}</div>
          ` : (p.customizable ? `<div class="mt-1 text-xs text-muted">No custom text set</div>` : '');

          return `
            <div class="flex gap-3 p-3 rounded-2xl border border-soft bg-card2">
              <div class="h-16 w-16 rounded-2xl overflow-hidden border border-soft shrink-0">
                ${p.imageDataUrl ? `<img src="${p.imageDataUrl}" class="h-full w-full object-cover" alt="${escapeHtml(p.title)}"/>` : `<div class="h-full w-full flex items-center justify-center" style="background: radial-gradient(circle at 30% 30%, var(--accent), transparent 65%), linear-gradient(135deg, rgba(255,255,255,.06), rgba(255,255,255,.02));">${escapeHtml(p.emoji||'üõçÔ∏è')}</div>`}
              </div>
              <div class="flex-1">
                <div class="flex items-start justify-between gap-2">
                  <div>
                    <div class="font-semibold">${escapeHtml(p.title)}</div>
                    <div class="text-sm text-muted">${money(p.price)}</div>
                    ${customLine}
                  </div>
                  <button data-action="remove" data-id="${escapeHtml(p.id)}" class="px-3 py-1.5 rounded-xl border border-soft hover:bg-card">Remove</button>
                </div>

                <div class="mt-3 flex items-center justify-between">
                  <div class="flex items-center gap-2">
                    <div class="inline-flex items-center gap-2 rounded-2xl border border-soft bg-card px-2 py-1">
                      <button data-action="qty" data-id="${escapeHtml(p.id)}" data-delta="-1" class="h-8 w-8 rounded-xl hover:bg-card2">‚àí</button>
                      <span class="min-w-8 text-center font-semibold">${it.qty}</span>
                      <button data-action="qty" data-id="${escapeHtml(p.id)}" data-delta="1" class="h-8 w-8 rounded-xl hover:bg-card2">+</button>
                    </div>
                    ${p.customizable ? `<button data-action="customize-edit" data-id="${escapeHtml(p.id)}" class="px-3 py-2 rounded-xl border border-soft hover:bg-card">Customize</button>` : ''}
                  </div>
                  <div class="font-extrabold">${money(p.price*it.qty)}</div>
                </div>
              </div>
            </div>
          `;
        }).join('');

        $('#cartSubtotal').textContent = money(cartSubtotal());
      }

      function renderCheckoutSummary(){
        const sumRoot = $('#checkoutSummary');
        if(!sumRoot) return;

        const itemsHtml = cart.items.map(it=>{
          const p = productById(it.productId);
          if(!p) return '';
          const custom = it.custom?.text ? `<div class="text-xs text-muted mt-0.5">Print: <span class="text-accent font-semibold">${escapeHtml(it.custom.text)}</span> ‚Ä¢ ${escapeHtml(it.custom.color)} ‚Ä¢ ${it.custom.size}px${it.custom.bold?' ‚Ä¢ bold':''}${it.custom.italic?' ‚Ä¢ italic':''}</div>` : '';
          return `
            <div class="p-3 rounded-2xl border border-soft bg-card2">
              <div class="flex items-start justify-between gap-3">
                <div class="flex items-center gap-3 min-w-0">
                  <div class="h-12 w-12 rounded-2xl overflow-hidden border border-soft shrink-0">
                    ${p.imageDataUrl ? `<img src="${p.imageDataUrl}" class="h-full w-full object-cover" alt="${escapeHtml(p.title)}"/>` : `<div class="h-full w-full flex items-center justify-center" style="background: radial-gradient(circle at 30% 30%, var(--accent), transparent 65%), linear-gradient(135deg, rgba(255,255,255,.06), rgba(255,255,255,.02));">${escapeHtml(p.emoji||'üõçÔ∏è')}</div>`}
                  </div>
                  <div class="min-w-0">
                    <div class="font-semibold truncate">${escapeHtml(p.title)}</div>
                    <div class="text-sm text-muted">${money(p.price)} √ó ${it.qty}</div>
                    ${custom}
                  </div>
                </div>
                <div class="font-extrabold">${money(p.price*it.qty)}</div>
              </div>
            </div>
          `;
        }).join('');

        sumRoot.innerHTML = itemsHtml || '<div class="text-sm text-muted">No items</div>';

        const subtotal = cartSubtotal();
        const discount = calcDiscount(subtotal, ui.couponApplied);
        const total = Math.max(0, subtotal - discount);

        $('#sumSubtotal').textContent = money(subtotal);
        $('#sumDiscount').textContent = `- ${money(discount)}`;
        $('#sumTotal').textContent = money(total);
      }

      // ---------- ADMIN GATE (LOGIN/SETUP) ----------
      function renderAdminLogin(){
        const s = state.settings;
        const root = $('#adminApp');
        root.innerHTML = `
          <div class="min-h-screen flex items-center justify-center p-4">
            <div class="w-full max-w-lg bg-surface border border-soft shadow-soft rounded-3xl overflow-hidden">
              <div class="p-6 border-b border-soft">
                <div class="flex items-center gap-3">
                  ${s.logoDataUrl ? `<img src="${s.logoDataUrl}" alt="logo" class="h-11 w-11 rounded-2xl object-cover border border-soft"/>` : `<div class="h-11 w-11 rounded-2xl bg-accent text-white flex items-center justify-center font-black">WW</div>`}
                  <div>
                    <div class="text-xl font-extrabold">Admin Login</div>
                    <div class="text-sm text-muted">${escapeHtml(s.storeName)} ‚Ä¢ Password protected</div>
                  </div>
                </div>
              </div>
              <div class="p-6">
                <form data-form="admin-login" class="space-y-4">
                  <div>
                    <label class="text-sm text-muted">Password</label>
                    <input required type="password" name="password" class="mt-1 w-full rounded-2xl bg-card2 border border-soft px-4 py-3 focus-ring" placeholder="Enter admin password" />
                  </div>
                  <button class="w-full btn-accent rounded-2xl px-4 py-3 font-semibold">Login</button>
                  <a href="#home" class="block text-center text-sm text-muted hover:text-accent">‚Üê Back to Store</a>
                </form>
                <div class="mt-4 text-xs text-muted">
                  Note: This is a client-side demo lock (localStorage). For real security, backend auth is required.
                </div>
              </div>
            </div>
          </div>
        `;
      }

      function renderAdminSetup(){
        const s = state.settings;
        const root = $('#adminApp');
        root.innerHTML = `
          <div class="min-h-screen flex items-center justify-center p-4">
            <div class="w-full max-w-lg bg-surface border border-soft shadow-soft rounded-3xl overflow-hidden">
              <div class="p-6 border-b border-soft">
                <div class="flex items-center gap-3">
                  ${s.logoDataUrl ? `<img src="${s.logoDataUrl}" alt="logo" class="h-11 w-11 rounded-2xl object-cover border border-soft"/>` : `<div class="h-11 w-11 rounded-2xl bg-accent text-white flex items-center justify-center font-black">WW</div>`}
                  <div>
                    <div class="text-xl font-extrabold">Setup Admin Password</div>
                    <div class="text-sm text-muted">First time security setup for ${escapeHtml(s.storeName)}</div>
                  </div>
                </div>
              </div>
              <div class="p-6">
                <form data-form="admin-setup" class="space-y-4">
                  <div>
                    <label class="text-sm text-muted">New password</label>
                    <input required type="password" name="newPassword" class="mt-1 w-full rounded-2xl bg-card2 border border-soft px-4 py-3 focus-ring" placeholder="Set a strong password" />
                  </div>
                  <div>
                    <label class="text-sm text-muted">Confirm password</label>
                    <input required type="password" name="confirmPassword" class="mt-1 w-full rounded-2xl bg-card2 border border-soft px-4 py-3 focus-ring" placeholder="Re-enter password" />
                  </div>
                  <button class="w-full btn-accent rounded-2xl px-4 py-3 font-semibold">Save & Continue</button>
                  <a href="#home" class="block text-center text-sm text-muted hover:text-accent">‚Üê Back to Store</a>
                </form>
                <div class="mt-4 text-xs text-muted">
                  Note: This password is stored locally in your browser (hashed). For real security + multi-user access, backend auth is required.
                </div>
              </div>
            </div>
          </div>
        `;
      }

      function renderAdminGate(){
        const hasPw = !!state.settings.security?.passwordHash;
        if(!hasPw) return renderAdminSetup();
        if(!ui.adminAuthed) return renderAdminLogin();
        renderAdmin();
      }

      // ---------- ADMIN ----------
      function renderAdmin(){
        const s = state.settings;
        const root = $('#adminApp');

        const stats = orderStats();

        root.innerHTML = `
          <div class="min-h-screen">
            <div class="border-b border-soft bg-surface">
              <div class="mx-auto max-w-7xl px-4 py-4 flex items-center justify-between gap-3">
                <div class="flex items-center gap-3">
                  ${s.logoDataUrl ? `<img src="${s.logoDataUrl}" alt="logo" class="h-10 w-10 rounded-2xl object-cover border border-soft"/>` : `<div class="h-10 w-10 rounded-2xl bg-accent text-white flex items-center justify-center font-black">WW</div>`}
                  <div>
                    <div class="font-extrabold text-lg">Admin Dashboard</div>
                    <div class="text-sm text-muted">${escapeHtml(s.storeName)} ‚Ä¢ localStorage</div>
                  </div>
                </div>
                <div class="flex items-center gap-2">
                  <button data-action="toggle-mode" class="px-3 py-2 rounded-xl border border-soft hover:bg-card2">Toggle mode</button>
                  <button data-action="admin-logout" class="px-3 py-2 rounded-xl border border-soft hover:bg-card2">Logout</button>
                  <a href="#home" class="px-4 py-2 rounded-2xl btn-accent font-semibold">‚Üê Back to Store</a>
                </div>
              </div>
            </div>

            <div class="mx-auto max-w-7xl px-4 py-6 grid lg:grid-cols-[260px_1fr] gap-4">
              <aside class="bg-surface border border-soft rounded-3xl p-3 h-fit lg:sticky lg:top-4">
                <div class="px-3 py-2 text-xs text-muted">MENU</div>
                ${adminNavItem('dashboard','Dashboard')}
                ${adminNavItem('products','Products')}
                ${adminNavItem('orders','Orders')}
                ${adminNavItem('header','Header & Footer')}
                ${adminNavItem('theme','Theme')}
                ${adminNavItem('design','Design & Typography')}
                ${adminNavItem('coupon','Coupon')}
                ${adminNavItem('security','Security')}
                ${adminNavItem('data','Backup / Reset')}

                <div class="mt-3 p-3 rounded-2xl bg-card2 border border-soft">
                  <div class="text-sm text-muted">Quick stats</div>
                  <div class="mt-1 font-extrabold">${stats.total} Orders</div>
                  <div class="mt-1 text-sm text-muted">Pending: ${stats.pending} ‚Ä¢ Delivered: ${stats.delivered}</div>
                </div>
              </aside>

              <main class="space-y-4">
                ${renderAdminPanel()}
              </main>
            </div>
          </div>
        `;
      }

      function adminNavItem(key, label){
        const active = ui.adminTab === key;
        return `
          <button data-action="admin-tab" data-tab="${key}" class="w-full flex items-center justify-between px-3 py-2.5 rounded-2xl ${active ? 'bg-card2 border border-soft' : 'hover:bg-card2'}">
            <span class="font-semibold">${label}</span>
            <span class="text-xs text-muted">‚Üí</span>
          </button>
        `;
      }

      function orderStats(){
        const orders = state.orders || [];
        const stats = { total: orders.length, pending:0, delivered:0, cancelled:0, revenueDelivered:0, revenueAll:0 };
        for(const o of orders){
          const st = String(o.status||'Pending');
          if(st==='Delivered') { stats.delivered++; stats.revenueDelivered += Number(o.total||0); }
          else if(st==='Cancelled') stats.cancelled++;
          else stats.pending++;
          stats.revenueAll += Number(o.total||0);
        }
        return stats;
      }

      function renderAdminPanel(){
        switch(ui.adminTab){
          case 'products': return adminProductsPanel();
          case 'orders': return adminOrdersPanel();
          case 'header': return adminHeaderFooterPanel();
          case 'theme': return adminThemePanel();
          case 'design': return adminDesignPanel();
          case 'coupon': return adminCouponPanel();
          case 'security': return adminSecurityPanel();
          case 'data': return adminDataPanel();
          default: return adminDashboardPanel();
        }
      }

      function adminDashboardPanel(){
        const stats = orderStats();
        return `
          <section class="grid md:grid-cols-2 lg:grid-cols-4 gap-4">
            ${statCard('Total Orders', stats.total)}
            ${statCard('Pending', stats.pending)}
            ${statCard('Delivered', stats.delivered)}
            ${statCard('Delivered Revenue', money(stats.revenueDelivered))}
          </section>

          <section class="bg-surface border border-soft rounded-3xl p-5">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="text-xl font-extrabold">Quick Actions</div>
                <div class="text-sm text-muted">Manage products, coupon, theme, background, and typography.</div>
              </div>
              <div class="flex gap-2">
                <button data-action="admin-tab" data-tab="products" class="px-4 py-2 rounded-2xl btn-accent font-semibold">Manage Products</button>
                <button data-action="admin-tab" data-tab="orders" class="px-4 py-2 rounded-2xl border border-soft hover:bg-card2 font-semibold">View Orders</button>
              </div>
            </div>
            <div class="mt-4 grid md:grid-cols-2 gap-4">
              <div class="p-4 rounded-2xl bg-card2 border border-soft">
                <div class="font-semibold">WhatsApp number</div>
                <div class="text-sm text-muted mt-1">+${escapeHtml(state.settings.whatsappNumber)}</div>
                <button data-action="admin-tab" data-tab="header" class="mt-3 px-4 py-2 rounded-2xl border border-soft hover:bg-card font-semibold">Edit store settings</button>
              </div>
              <div class="p-4 rounded-2xl bg-card2 border border-soft">
                <div class="font-semibold">Coupon</div>
                <div class="text-sm text-muted mt-1">${state.settings.coupon?.enabled ? `Code: ${escapeHtml(state.settings.coupon.code)} (${Number(state.settings.coupon.percent||10)}% off)` : 'Disabled'}</div>
                <button data-action="admin-tab" data-tab="coupon" class="mt-3 px-4 py-2 rounded-2xl border border-soft hover:bg-card font-semibold">Change coupon</button>
              </div>
            </div>

            <div class="mt-4 p-4 rounded-2xl bg-card2 border border-soft text-sm text-muted">
              <b>Note:</b> Admin portal password lock is client-side (localStorage). Production use ke liye backend auth recommended hai.
            </div>
          </section>
        `;
      }

      function statCard(label, value){
        return `
          <div class="bg-surface border border-soft rounded-3xl p-5">
            <div class="text-sm text-muted">${escapeHtml(label)}</div>
            <div class="mt-2 text-2xl font-extrabold">${escapeHtml(value)}</div>
          </div>
        `;
      }

      function adminProductsPanel(){
        const editing = ui.editingProductId ? productById(ui.editingProductId) : null;
        return `
          <section class="bg-surface border border-soft rounded-3xl p-5">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="text-xl font-extrabold">Products</div>
                <div class="text-sm text-muted">Direct image upload supported (no URL needed). Mark products as customizable for print text.</div>
              </div>
              <button data-action="product-add-toggle" class="px-4 py-2 rounded-2xl btn-accent font-semibold">Add product</button>
            </div>

            <div id="addProductBox" class="mt-4 ${ui._showAddProduct ? '' : 'hidden'}">
              <div class="p-4 rounded-2xl bg-card2 border border-soft">
                <form data-form="add-product" class="grid md:grid-cols-2 gap-4">
                  <div class="space-y-3">
                    <div>
                      <label class="text-sm text-muted">Title</label>
                      <input required name="title" class="mt-1 w-full rounded-2xl bg-surface border border-soft px-4 py-3 focus-ring" placeholder="Product name" />
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                      <div>
                        <label class="text-sm text-muted">Price (Rs)</label>
                        <input required name="price" type="number" class="mt-1 w-full rounded-2xl bg-surface border border-soft px-4 py-3 focus-ring" placeholder="1299" />
                      </div>
                      <div>
                        <label class="text-sm text-muted">Compare at (optional)</label>
                        <input name="compareAt" type="number" class="mt-1 w-full rounded-2xl bg-surface border border-soft px-4 py-3 focus-ring" placeholder="1599" />
                      </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                      <div>
                        <label class="text-sm text-muted">Badge (optional)</label>
                        <input name="badge" class="mt-1 w-full rounded-2xl bg-surface border border-soft px-4 py-3 focus-ring" placeholder="Best Seller" />
                      </div>
                      <div>
                        <label class="text-sm text-muted">Emoji (optional)</label>
                        <input name="emoji" class="mt-1 w-full rounded-2xl bg-surface border border-soft px-4 py-3 focus-ring" placeholder="üëï" />
                      </div>
                    </div>
                    <div class="flex flex-col gap-2">
                      <label class="inline-flex items-center gap-2 text-sm text-muted">
                        <input name="inStock" type="checkbox" checked /> In stock
                      </label>
                      <label class="inline-flex items-center gap-2 text-sm text-muted">
                        <input name="customizable" type="checkbox" checked /> Print text customizable
                      </label>
                    </div>
                    <div>
                      <label class="text-sm text-muted">Description</label>
                      <textarea name="description" rows="3" class="mt-1 w-full rounded-2xl bg-surface border border-soft px-4 py-3 focus-ring" placeholder="Short description"></textarea>
                    </div>
                  </div>
                  <div class="space-y-3">
                    <div>
                      <label class="text-sm text-muted">Product Image (Upload)</label>
                      <input id="addProductImage" type="file" accept="image/*" class="mt-2 w-full" />
                      <div class="mt-3 rounded-2xl border border-soft bg-surface overflow-hidden">
                        ${ui.addImageDraft ? `<img src="${ui.addImageDraft}" class="h-44 w-full object-cover" alt="preview"/>` : `<div class="h-44 flex items-center justify-center text-muted">No image selected</div>`}
                      </div>
                      <div class="mt-2 text-xs text-muted">Image will be saved in browser storage.</div>
                    </div>
                    <button class="w-full btn-accent rounded-2xl px-4 py-3 font-semibold">Save product</button>
                    <button type="button" data-action="product-add-cancel" class="w-full rounded-2xl px-4 py-3 border border-soft hover:bg-card">Cancel</button>
                  </div>
                </form>
              </div>
            </div>

            ${editing ? `
              <div class="mt-4">
                <div class="p-4 rounded-2xl bg-card2 border border-soft">
                  <div class="flex items-start justify-between gap-3">
                    <div>
                      <div class="font-extrabold">Edit: ${escapeHtml(editing.title)}</div>
                      <div class="text-sm text-muted">Update product & image</div>
                    </div>
                    <button data-action="product-edit-cancel" class="px-3 py-2 rounded-xl border border-soft hover:bg-card">Close</button>
                  </div>

                  <form data-form="edit-product" data-id="${escapeHtml(editing.id)}" class="mt-4 grid md:grid-cols-2 gap-4">
                    <div class="space-y-3">
                      <div>
                        <label class="text-sm text-muted">Title</label>
                        <input required name="title" value="${escapeHtml(editing.title)}" class="mt-1 w-full rounded-2xl bg-surface border border-soft px-4 py-3 focus-ring" />
                      </div>
                      <div class="grid grid-cols-2 gap-3">
                        <div>
                          <label class="text-sm text-muted">Price (Rs)</label>
                          <input required name="price" type="number" value="${escapeHtml(editing.price)}" class="mt-1 w-full rounded-2xl bg-surface border border-soft px-4 py-3 focus-ring" />
                        </div>
                        <div>
                          <label class="text-sm text-muted">Compare at</label>
                          <input name="compareAt" type="number" value="${escapeHtml(editing.compareAt||'')}" class="mt-1 w-full rounded-2xl bg-surface border border-soft px-4 py-3 focus-ring" />
                        </div>
                      </div>
                      <div class="grid grid-cols-2 gap-3">
                        <div>
                          <label class="text-sm text-muted">Badge</label>
                          <input name="badge" value="${escapeHtml(editing.badge||'')}" class="mt-1 w-full rounded-2xl bg-surface border border-soft px-4 py-3 focus-ring" />
                        </div>
                        <div>
                          <label class="text-sm text-muted">Emoji</label>
                          <input name="emoji" value="${escapeHtml(editing.emoji||'')}" class="mt-1 w-full rounded-2xl bg-surface border border-soft px-4 py-3 focus-ring" />
                        </div>
                      </div>
                      <div class="flex flex-col gap-2">
                        <label class="inline-flex items-center gap-2 text-sm text-muted">
                          <input name="inStock" type="checkbox" ${editing.inStock ? 'checked' : ''} /> In stock
                        </label>
                        <label class="inline-flex items-center gap-2 text-sm text-muted">
                          <input name="customizable" type="checkbox" ${editing.customizable ? 'checked' : ''} /> Print text customizable
                        </label>
                      </div>
                      <div>
                        <label class="text-sm text-muted">Description</label>
                        <textarea name="description" rows="3" class="mt-1 w-full rounded-2xl bg-surface border border-soft px-4 py-3 focus-ring">${escapeHtml(editing.description||'')}</textarea>
                      </div>
                    </div>
                    <div class="space-y-3">
                      <div>
                        <label class="text-sm text-muted">Replace Image (Upload)</label>
                        <input id="editProductImage" type="file" accept="image/*" class="mt-2 w-full" />
                        <div class="mt-3 rounded-2xl border border-soft bg-surface overflow-hidden">
                          ${(ui.editImageDraft || editing.imageDataUrl) ? `<img src="${ui.editImageDraft || editing.imageDataUrl}" class="h-44 w-full object-cover" alt="preview"/>` : `<div class="h-44 flex items-center justify-center text-muted">No image</div>`}
                        </div>
                      </div>
                      <button class="w-full btn-accent rounded-2xl px-4 py-3 font-semibold">Save changes</button>
                      <button type="button" data-action="product-delete" data-id="${escapeHtml(editing.id)}" class="w-full rounded-2xl px-4 py-3 border border-soft hover:bg-card">Delete product</button>
                    </div>
                  </form>
                </div>
              </div>
            `:''}

            <div class="mt-5 overflow-x-auto">
              <table class="w-full text-sm">
                <thead>
                  <tr class="text-left text-muted">
                    <th class="py-2">Product</th>
                    <th class="py-2">Price</th>
                    <th class="py-2">Custom</th>
                    <th class="py-2">Stock</th>
                    <th class="py-2">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  ${state.products.map(p=>`
                    <tr class="border-t border-soft">
                      <td class="py-3">
                        <div class="flex items-center gap-3">
                          <div class="h-10 w-10 rounded-2xl overflow-hidden border border-soft bg-card2 shrink-0">
                            ${p.imageDataUrl ? `<img src="${p.imageDataUrl}" class="h-full w-full object-cover" alt="${escapeHtml(p.title)}"/>` : `<div class="h-full w-full flex items-center justify-center">${escapeHtml(p.emoji||'üõçÔ∏è')}</div>`}
                          </div>
                          <div>
                            <div class="font-semibold">${escapeHtml(p.title)}</div>
                            <div class="text-xs text-muted">ID: ${escapeHtml(p.id)}</div>
                          </div>
                        </div>
                      </td>
                      <td class="py-3 font-semibold">${money(p.price)}</td>
                      <td class="py-3"><span class="px-2 py-1 rounded-full border border-soft ${p.customizable ? '' : 'opacity-60'}">${p.customizable ? 'Yes' : 'No'}</span></td>
                      <td class="py-3"><span class="px-2 py-1 rounded-full border border-soft ${p.inStock ? '' : 'opacity-60'}">${p.inStock ? 'In stock' : 'Out'}</span></td>
                      <td class="py-3">
                        <div class="flex gap-2">
                          <button data-action="product-edit" data-id="${escapeHtml(p.id)}" class="px-3 py-2 rounded-xl border border-soft hover:bg-card2">Edit</button>
                          <button data-action="product-duplicate" data-id="${escapeHtml(p.id)}" class="px-3 py-2 rounded-xl border border-soft hover:bg-card2">Duplicate</button>
                        </div>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </section>
        `;
      }

      function adminOrdersPanel(){
        const stats = orderStats();
        const orders = state.orders || [];
        return `
          <section class="grid md:grid-cols-4 gap-4">
            ${statCard('Total', stats.total)}
            ${statCard('Pending', stats.pending)}
            ${statCard('Delivered', stats.delivered)}
            ${statCard('Cancelled', stats.cancelled)}
          </section>

          <section class="bg-surface border border-soft rounded-3xl p-5">
            <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-3">
              <div>
                <div class="text-xl font-extrabold">Orders</div>
                <div class="text-sm text-muted">View, mark delivered, and open WhatsApp message.</div>
              </div>
              <div class="flex flex-col sm:flex-row gap-2">
                <input id="adminOrderSearch" class="rounded-2xl bg-card2 border border-soft px-4 py-3 focus-ring" placeholder="Search by ID / name / phone" />
                <select id="adminOrderFilter" class="rounded-2xl bg-card2 border border-soft px-4 py-3 focus-ring">
                  <option value="">All</option>
                  <option value="Pending">Pending</option>
                  <option value="Delivered">Delivered</option>
                  <option value="Cancelled">Cancelled</option>
                </select>
                <button data-action="orders-export" class="px-4 py-3 rounded-2xl border border-soft hover:bg-card2">Export CSV</button>
              </div>
            </div>

            <div class="mt-4 overflow-x-auto">
              <table class="w-full text-sm">
                <thead>
                  <tr class="text-left text-muted">
                    <th class="py-2">Order</th>
                    <th class="py-2">Customer</th>
                    <th class="py-2">Total</th>
                    <th class="py-2">Status</th>
                    <th class="py-2">Action</th>
                  </tr>
                </thead>
                <tbody id="ordersTableBody">
                  ${orders.length ? orders.map(o=>orderRow(o)).join('') : `
                    <tr class="border-t border-soft">
                      <td class="py-6 text-muted" colspan="5">No orders yet. Place one from storefront to test.</td>
                    </tr>
                  `}
                </tbody>
              </table>
            </div>

            <div class="mt-4 flex flex-wrap gap-2">
              <button data-action="orders-clear" class="px-4 py-2 rounded-2xl border border-soft hover:bg-card2">Clear all orders</button>
              <button data-action="refresh-admin" class="px-4 py-2 rounded-2xl btn-accent font-semibold">Refresh</button>
            </div>
          </section>
        `;
      }

      function orderRow(o){
        const date = new Date(o.createdAt).toLocaleString();
        const statusPill = statusBadge(o.status);
        return `
          <tr class="border-t border-soft" data-order-row="1" data-id="${escapeHtml(o.id)}">
            <td class="py-3">
              <div class="font-semibold">${escapeHtml(o.id)}</div>
              <div class="text-xs text-muted">${escapeHtml(date)}</div>
            </td>
            <td class="py-3">
              <div class="font-semibold">${escapeHtml(o.customer?.name||'')}</div>
              <div class="text-xs text-muted">${escapeHtml(o.customer?.phone||'')}</div>
            </td>
            <td class="py-3 font-extrabold">${money(o.total||0)}</td>
            <td class="py-3">${statusPill}</td>
            <td class="py-3">
              <div class="flex gap-2">
                <button data-action="order-view" data-id="${escapeHtml(o.id)}" class="px-3 py-2 rounded-xl border border-soft hover:bg-card2">View</button>
                <button data-action="order-quick" data-id="${escapeHtml(o.id)}" data-status="Delivered" class="px-3 py-2 rounded-xl btn-accent font-semibold">Delivered</button>
              </div>
            </td>
          </tr>
        `;
      }

      function statusBadge(status){
        const st = String(status||'Pending');
        const map = {
          Pending: 'border-soft text-muted',
          Delivered: 'bg-accent text-white border-transparent',
          Cancelled: 'border-soft text-muted opacity-70',
        };
        const cls = map[st] || map.Pending;
        return `<span class="inline-flex items-center px-2 py-1 rounded-full border ${cls}">${escapeHtml(st)}</span>`;
      }

      function adminHeaderFooterPanel(){
        const s = state.settings;
        return `
          <section class="bg-surface border border-soft rounded-3xl p-5">
            <div class="text-xl font-extrabold">Header & Footer / Store Settings</div>
            <div class="text-sm text-muted mt-1">Logo upload, store name, WhatsApp, links, and texts.</div>

            <form data-form="store-settings" class="mt-5 grid lg:grid-cols-2 gap-4">
              <div class="space-y-3">
                <div class="grid sm:grid-cols-2 gap-3">
                  <div>
                    <label class="text-sm text-muted">Store Name</label>
                    <input name="storeName" value="${escapeHtml(s.storeName)}" class="mt-1 w-full rounded-2xl bg-card2 border border-soft px-4 py-3 focus-ring" />
                  </div>
                  <div>
                    <label class="text-sm text-muted">WhatsApp Number</label>
                    <input name="whatsappNumber" value="${escapeHtml(s.whatsappNumber)}" class="mt-1 w-full rounded-2xl bg-card2 border border-soft px-4 py-3 focus-ring" placeholder="923..." />
                  </div>
                </div>

                <div>
                  <label class="text-sm text-muted">Announcement bar text</label>
                  <input name="announcement" value="${escapeHtml(s.announcement)}" class="mt-1 w-full rounded-2xl bg-card2 border border-soft px-4 py-3 focus-ring" />
                </div>

                <div>
                  <label class="text-sm text-muted">Hero Title</label>
                  <input name="heroTitle" value="${escapeHtml(s.heroTitle)}" class="mt-1 w-full rounded-2xl bg-card2 border border-soft px-4 py-3 focus-ring" />
                </div>

                <div>
                  <label class="text-sm text-muted">Hero Subtitle</label>
                  <textarea name="heroSubtitle" rows="3" class="mt-1 w-full rounded-2xl bg-card2 border border-soft px-4 py-3 focus-ring">${escapeHtml(s.heroSubtitle)}</textarea>
                </div>

                <label class="inline-flex items-center gap-2 text-sm text-muted">
                  <input type="checkbox" name="showFloatingWhatsApp" ${s.showFloatingWhatsApp ? 'checked' : ''} /> Show floating WhatsApp button
                </label>
              </div>

              <div class="space-y-4">
                <div class="p-4 rounded-2xl bg-card2 border border-soft">
                  <div class="font-semibold">Logo (Upload)</div>
                  <input id="logoUpload" type="file" accept="image/*" class="mt-2 w-full" />
                  <div class="mt-3 rounded-2xl border border-soft bg-surface overflow-hidden">
                    ${(ui.logoDraft || s.logoDataUrl) ? `<img src="${ui.logoDraft || s.logoDataUrl}" class="h-32 w-full object-cover" alt="logo preview"/>` : `<div class="h-32 flex items-center justify-center text-muted">No logo</div>`}
                  </div>
                  <div class="mt-2 flex gap-2">
                    <button type="button" data-action="logo-clear" class="px-4 py-2 rounded-2xl border border-soft hover:bg-card">Remove logo</button>
                    <button type="button" data-action="logo-use-draft" class="px-4 py-2 rounded-2xl btn-accent font-semibold">Use uploaded</button>
                  </div>
                </div>

                <div class="p-4 rounded-2xl bg-card2 border border-soft">
                  <div class="flex items-center justify-between">
                    <div class="font-semibold">Header links</div>
                    <button type="button" data-action="link-add" data-kind="header" class="px-3 py-2 rounded-xl border border-soft hover:bg-card">+ Add</button>
                  </div>
                  <div class="mt-3 space-y-2" id="headerLinksEditor">
                    ${(s.headerLinks||[]).map((l,i)=>linkRow('header', i, l)).join('')}
                  </div>
                </div>

                <div class="p-4 rounded-2xl bg-card2 border border-soft">
                  <div class="flex items-center justify-between">
                    <div class="font-semibold">Footer links</div>
                    <button type="button" data-action="link-add" data-kind="footer" class="px-3 py-2 rounded-xl border border-soft hover:bg-card">+ Add</button>
                  </div>
                  <div class="mt-3 space-y-2" id="footerLinksEditor">
                    ${(s.footerLinks||[]).map((l,i)=>linkRow('footer', i, l)).join('')}
                  </div>
                </div>

                <div>
                  <label class="text-sm text-muted">Footer text</label>
                  <input name="footerText" value="${escapeHtml(s.footerText)}" class="mt-1 w-full rounded-2xl bg-card2 border border-soft px-4 py-3 focus-ring" />
                </div>

                <button class="w-full btn-accent rounded-2xl px-4 py-3 font-semibold">Save settings</button>
              </div>
            </form>
          </section>
        `;
      }

      function linkRow(kind, i, l){
        const label = escapeHtml(l?.label||'');
        const href = escapeHtml(l?.href||'');
        return `
          <div class="grid grid-cols-12 gap-2" data-link-row="${kind}" data-index="${i}">
            <input class="col-span-5 rounded-2xl bg-surface border border-soft px-3 py-2 focus-ring" placeholder="Label" value="${label}" data-field="label" />
            <input class="col-span-6 rounded-2xl bg-surface border border-soft px-3 py-2 focus-ring" placeholder="#section €åÿß https://" value="${href}" data-field="href" />
            <button type="button" data-action="link-remove" data-kind="${kind}" data-index="${i}" class="col-span-1 rounded-2xl border border-soft hover:bg-card">‚úï</button>
          </div>
        `;
      }

      function adminThemePanel(){
        const s = state.settings;
        const themeCards = Object.entries(THEMES).map(([id,t])=>{
          const active = s.themeId === id;
          return `
            <button data-action="theme-set" data-id="${id}" class="text-left p-4 rounded-3xl border ${active ? 'border-transparent bg-card2 ring-2 ring-[color:var(--ring)]' : 'border-soft bg-surface hover:bg-card2'}">
              <div class="flex items-center justify-between">
                <div class="font-extrabold">${escapeHtml(t.name)}</div>
                ${active ? `<span class="text-xs px-2 py-1 rounded-full bg-accent text-white">Active</span>` : `<span class="text-xs px-2 py-1 rounded-full border border-soft text-muted">Select</span>`}
              </div>
              <div class="mt-3 flex gap-2">
                <span class="h-8 w-8 rounded-2xl" style="background:${t.accent}"></span>
                <span class="h-8 w-8 rounded-2xl" style="background:${t.accent2}"></span>
              </div>
            </button>
          `;
        }).join('');

        return `
          <section class="bg-surface border border-soft rounded-3xl p-5">
            <div class="text-xl font-extrabold">Theme</div>
            <div class="text-sm text-muted mt-1">Change store look instantly.</div>

            <div class="mt-4 grid md:grid-cols-2 xl:grid-cols-3 gap-4">
              ${themeCards}
            </div>

            <div class="mt-6 grid lg:grid-cols-2 gap-4">
              <div class="p-4 rounded-2xl bg-card2 border border-soft">
                <div class="font-semibold">Mode</div>
                <div class="mt-3 flex gap-2">
                  <button data-action="mode-set" data-mode="dark" class="px-4 py-2 rounded-2xl ${s.mode==='dark'?'btn-accent':'border border-soft hover:bg-card'}">Dark</button>
                  <button data-action="mode-set" data-mode="light" class="px-4 py-2 rounded-2xl ${s.mode==='light'?'btn-accent':'border border-soft hover:bg-card'}">Light</button>
                </div>
                <div class="mt-3 text-xs text-muted">Tip: Light mode works great for catalogs.</div>
              </div>

              <div class="p-4 rounded-2xl bg-card2 border border-soft">
                <div class="font-semibold">Custom Accent (optional)</div>
                <div class="text-sm text-muted mt-1">Set your own primary color</div>
                <div class="mt-3 flex items-center gap-3">
                  <input id="customAccent" type="color" value="${escapeHtml(state.settings.customAccent || (THEMES[state.settings.themeId]?.accent || '#10b981'))}" class="h-12 w-16 rounded-2xl border border-soft bg-surface" />
                  <button data-action="custom-accent-use" class="px-4 py-2 rounded-2xl btn-accent font-semibold">Use</button>
                  <button data-action="custom-accent-clear" class="px-4 py-2 rounded-2xl border border-soft hover:bg-card">Reset</button>
                </div>
              </div>
            </div>
          </section>
        `;
      }

      function adminDesignPanel(){
        const d = state.settings.design || structuredClone(DEFAULT_STATE.settings.design);
        const bgPreview = ui.bgDraft || d.backgroundDataUrl;

        return `
          <section class="bg-surface border border-soft rounded-3xl p-5">
            <div class="text-xl font-extrabold">Design & Typography</div>
            <div class="text-sm text-muted mt-1">Background image upload + hero text styling (size/bold/italic/color) + overall font scale.</div>

            <form data-form="design" class="mt-5 grid lg:grid-cols-2 gap-4">
              <div class="space-y-4">
                <div class="p-4 rounded-2xl bg-card2 border border-soft">
                  <div class="font-semibold">Background Image (Upload)</div>
                  <input id="bgUpload" type="file" accept="image/*" class="mt-2 w-full" />
                  <div class="mt-3 rounded-2xl border border-soft bg-surface overflow-hidden">
                    ${bgPreview ? `<img src="${bgPreview}" class="h-40 w-full object-cover" alt="bg preview"/>` : `<div class="h-40 flex items-center justify-center text-muted">No background image</div>`}
                  </div>
                  <div class="mt-2 flex flex-wrap gap-2">
                    <button type="button" data-action="bg-use-draft" class="px-4 py-2 rounded-2xl btn-accent font-semibold">Use uploaded</button>
                    <button type="button" data-action="bg-clear" class="px-4 py-2 rounded-2xl border border-soft hover:bg-card">Remove background</button>
                  </div>
                  <div class="mt-2 text-xs text-muted">Background is saved locally in browser storage.</div>
                </div>

                <div class="p-4 rounded-2xl bg-card2 border border-soft">
                  <div class="font-semibold">Overall text size (Font Scale)</div>
                  <div class="mt-3">
                    <input type="range" name="fontScale" min="0.85" max="1.25" step="0.05" value="${escapeHtml(d.fontScale||1)}" class="w-full" />
                    <div class="mt-1 text-xs text-muted">Current: <b>${escapeHtml(String(d.fontScale||1))}</b></div>
                  </div>
                </div>
              </div>

              <div class="space-y-4">
                <div class="p-4 rounded-2xl bg-card2 border border-soft">
                  <div class="font-semibold">Hero Title Styling</div>
                  <div class="mt-3 grid sm:grid-cols-2 gap-3">
                    <div>
                      <label class="text-sm text-muted">Title size</label>
                      <input class="mt-2 w-full" type="range" name="heroTitleSize" min="30" max="90" step="1" value="${escapeHtml(d.heroTitleSize||56)}" />
                      <div class="mt-1 text-xs text-muted">${escapeHtml(d.heroTitleSize||56)} px</div>
                    </div>
                    <div>
                      <label class="text-sm text-muted">Title color</label>
                      <input class="mt-2 h-12 w-full rounded-2xl border border-soft bg-surface" type="color" name="heroTitleColor" value="${escapeHtml(d.heroTitleColor || (state.settings.mode==='light' ? '#0f172a' : '#e5e7eb'))}" />
                    </div>
                  </div>
                  <div class="mt-3 flex flex-wrap gap-4">
                    <label class="inline-flex items-center gap-2 text-sm text-muted">
                      <input type="checkbox" name="heroTitleBold" ${d.heroTitleBold ? 'checked' : ''} /> Bold
                    </label>
                    <label class="inline-flex items-center gap-2 text-sm text-muted">
                      <input type="checkbox" name="heroTitleItalic" ${d.heroTitleItalic ? 'checked' : ''} /> Italic
                    </label>
                  </div>
                </div>

                <div class="p-4 rounded-2xl bg-card2 border border-soft">
                  <div class="font-semibold">Hero Subtitle Styling</div>
                  <div class="mt-3 grid sm:grid-cols-2 gap-3">
                    <div>
                      <label class="text-sm text-muted">Subtitle size</label>
                      <input class="mt-2 w-full" type="range" name="heroSubtitleSize" min="12" max="40" step="1" value="${escapeHtml(d.heroSubtitleSize||18)}" />
                      <div class="mt-1 text-xs text-muted">${escapeHtml(d.heroSubtitleSize||18)} px</div>
                    </div>
                    <div>
                      <label class="text-sm text-muted">Subtitle color</label>
                      <input class="mt-2 h-12 w-full rounded-2xl border border-soft bg-surface" type="color" name="heroSubtitleColor" value="${escapeHtml(d.heroSubtitleColor || (state.settings.mode==='light' ? '#475569' : '#94a3b8'))}" />
                    </div>
                  </div>
                  <div class="mt-3 flex flex-wrap gap-4">
                    <label class="inline-flex items-center gap-2 text-sm text-muted">
                      <input type="checkbox" name="heroSubtitleItalic" ${d.heroSubtitleItalic ? 'checked' : ''} /> Italic
                    </label>
                  </div>
                </div>

                <button class="w-full btn-accent rounded-2xl px-4 py-3 font-semibold">Save design settings</button>
              </div>
            </form>
          </section>
        `;
      }

      function adminCouponPanel(){
        const c = state.settings.coupon || { enabled:true, code:'WEX10', percent:10 };
        return `
          <section class="bg-surface border border-soft rounded-3xl p-5">
            <div class="text-xl font-extrabold">Coupon</div>
            <div class="text-sm text-muted mt-1">Set coupon code and discount percent.</div>

            <form data-form="coupon" class="mt-5 grid lg:grid-cols-2 gap-4">
              <div class="p-4 rounded-2xl bg-card2 border border-soft space-y-3">
                <label class="inline-flex items-center gap-2 text-sm text-muted">
                  <input type="checkbox" name="enabled" ${c.enabled ? 'checked' : ''} /> Enable coupon
                </label>
                <div>
                  <label class="text-sm text-muted">Coupon Code</label>
                  <input required name="code" value="${escapeHtml(c.code)}" class="mt-1 w-full rounded-2xl bg-surface border border-soft px-4 py-3 focus-ring" />
                </div>
                <div>
                  <label class="text-sm text-muted">Discount Percent</label>
                  <input required name="percent" type="number" min="1" max="90" value="${escapeHtml(c.percent)}" class="mt-1 w-full rounded-2xl bg-surface border border-soft px-4 py-3 focus-ring" />
                </div>
                <button class="w-full btn-accent rounded-2xl px-4 py-3 font-semibold">Save coupon</button>
              </div>

              <div class="p-4 rounded-2xl bg-card2 border border-soft">
                <div class="font-semibold">Preview</div>
                <div class="mt-2 text-sm text-muted">
                  Customer checkout par code <b>${escapeHtml(c.code)}</b> dalega to <b>${Number(c.percent||10)}%</b> discount apply ho ga.
                </div>
                <div class="mt-4 p-4 rounded-2xl bg-surface border border-soft">
                  <div class="text-sm text-muted">Example subtotal</div>
                  <div class="mt-1 text-2xl font-extrabold">${money(5000)}</div>
                  <div class="mt-2 text-sm text-muted">Discount (${Number(c.percent||10)}%)</div>
                  <div class="mt-1 font-bold">-${money(Math.round(5000*(Number(c.percent||10))/100))}</div>
                </div>
              </div>
            </form>
          </section>
        `;
      }

      function adminSecurityPanel(){
        return `
          <section class="bg-surface border border-soft rounded-3xl p-5">
            <div class="text-xl font-extrabold">Security</div>
            <div class="text-sm text-muted mt-1">Change admin password & logout.</div>

            <div class="mt-5 grid lg:grid-cols-2 gap-4">
              <div class="p-4 rounded-2xl bg-card2 border border-soft">
                <div class="font-semibold">Change password</div>
                <form data-form="admin-password" class="mt-4 space-y-3">
                  <div>
                    <label class="text-sm text-muted">Current password</label>
                    <input required type="password" name="currentPassword" class="mt-1 w-full rounded-2xl bg-surface border border-soft px-4 py-3 focus-ring" placeholder="Current password" />
                  </div>
                  <div>
                    <label class="text-sm text-muted">New password</label>
                    <input required type="password" name="newPassword" class="mt-1 w-full rounded-2xl bg-surface border border-soft px-4 py-3 focus-ring" placeholder="New password" />
                  </div>
                  <div>
                    <label class="text-sm text-muted">Confirm new password</label>
                    <input required type="password" name="confirmPassword" class="mt-1 w-full rounded-2xl bg-surface border border-soft px-4 py-3 focus-ring" placeholder="Confirm" />
                  </div>
                  <button class="w-full btn-accent rounded-2xl px-4 py-3 font-semibold">Update password</button>
                </form>
              </div>

              <div class="p-4 rounded-2xl bg-card2 border border-soft">
                <div class="font-semibold">Session</div>
                <div class="mt-2 text-sm text-muted">Logout will close admin access until you login again.</div>
                <button data-action="admin-logout" class="mt-4 w-full px-4 py-3 rounded-2xl border border-soft hover:bg-card font-semibold">Logout</button>
                <div class="mt-4 text-xs text-muted">
                  Security note: This is a local demo lock. For real deployments, implement server-side authentication.
                </div>
              </div>
            </div>
          </section>
        `;
      }

      function adminDataPanel(){
        const b = backendCfg();
        const localUpdated = state.updatedAt ? new Date(state.updatedAt).toLocaleString() : '‚Äî';
        return `
          <section class="bg-surface border border-soft rounded-3xl p-5">
            <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3">
              <div>
                <div class="text-xl font-extrabold">Cloud Sync (Firebase)</div>
                <div class="text-sm text-muted mt-1">Sirf HTML file se multiple devices par products/orders/settings sync karne ke liye Firebase Realtime Database use karein.</div>
              </div>
              <div class="text-xs text-muted">Local updated: <span class="font-semibold">${escapeHtml(localUpdated)}</span></div>
            </div>

            <form data-form="backend" class="mt-5 grid lg:grid-cols-2 gap-4">
              <div class="p-4 rounded-2xl bg-card2 border border-soft space-y-3">
                <input type="hidden" name="provider" value="firebase" />

                <label class="inline-flex items-center gap-2 text-sm text-muted">
                  <input type="checkbox" name="enabled" ${b.enabled ? 'checked' : ''} /> Enable cloud sync
                </label>

                <div>
                  <label class="text-sm text-muted">Firebase Database URL (base)</label>
                  <input name="baseUrl" value="${escapeHtml(b.baseUrl)}" class="mt-1 w-full rounded-2xl bg-surface border border-soft px-4 py-3 focus-ring" placeholder="https://YOUR-PROJECT-default-rtdb.firebaseio.com" />
                  <div class="mt-1 text-xs text-muted">Firebase Console ‚Üí Realtime Database ‚Üí copy database URL. (Trailing / mat lagayen.)</div>
                </div>

                <div class="grid sm:grid-cols-2 gap-3">
                  <div>
                    <label class="text-sm text-muted">Path (node)</label>
                    <input name="path" value="${escapeHtml(b.path)}" class="mt-1 w-full rounded-2xl bg-surface border border-soft px-4 py-3 focus-ring" placeholder="wexwear_state_v1" />
                    <div class="mt-1 text-xs text-muted">Example: <code class="px-1.5 py-0.5 rounded bg-card border border-soft">wexwear_state_v1</code></div>
                  </div>
                  <div>
                    <label class="text-sm text-muted">Auth token (optional)</label>
                    <input name="token" value="${escapeHtml(b.token)}" class="mt-1 w-full rounded-2xl bg-surface border border-soft px-4 py-3 focus-ring" placeholder="Database secret / auth token" />
                    <div class="mt-1 text-xs text-muted">Agar rules public hain to blank rehne dein.</div>
                  </div>
                </div>

                <label class="inline-flex items-center gap-2 text-sm text-muted">
                  <input type="checkbox" name="autoSync" ${b.autoSync ? 'checked' : ''} /> Auto push on changes
                </label>

                <button class="w-full btn-accent rounded-2xl px-4 py-3 font-semibold">Save cloud settings</button>
              </div>

              <div class="p-4 rounded-2xl bg-card2 border border-soft">
                <div class="font-semibold">Actions</div>
                <div class="mt-3 flex flex-wrap gap-2">
                  <button type="button" data-action="cloud-test" class="px-4 py-2 rounded-2xl border border-soft hover:bg-card">Test</button>
                  <button type="button" data-action="cloud-pull" class="px-4 py-2 rounded-2xl border border-soft hover:bg-card">Pull</button>
                  <button type="button" data-action="cloud-pull-force" class="px-4 py-2 rounded-2xl border border-soft hover:bg-card">Force Pull</button>
                  <button type="button" data-action="cloud-push" class="px-4 py-2 rounded-2xl btn-accent font-semibold">Push</button>
                </div>

                <div class="mt-4 text-sm text-muted">
                  <div class="font-semibold text-[color:var(--text)]">Firebase setup (quick)</div>
                  <ol class="list-decimal pl-5 mt-2 space-y-1">
                    <li>Firebase Console ‚Üí Build ‚Üí Realtime Database ‚Üí <b>Create Database</b></li>
                    <li><b>Rules (demo only)</b>: <code class="px-1.5 py-0.5 rounded bg-card border border-soft">{"rules":{ ".read":true, ".write":true }}</code></li>
                    <li>Database URL copy kar ke upar paste karein.</li>
                    <li>Save ‚Üí phir <b>Push</b> (apna local data cloud par bhejne ke liye) €åÿß <b>Pull</b> (cloud se local overwrite).</li>
                  </ol>
                  <div class="mt-3 text-xs">
                    Security note: Public rules production ke liye safe nahi. Real deployment me Firebase Auth + rules required.
                  </div>
                </div>
              </div>
            </form>
          </section>

          <section class="bg-surface border border-soft rounded-3xl p-5">
            <div class="text-xl font-extrabold">Backup / Reset</div>
            <div class="text-sm text-muted mt-1">Export state as JSON, restore, or reset everything.</div>

            <div class="mt-5 grid lg:grid-cols-2 gap-4">
              <div class="p-4 rounded-2xl bg-card2 border border-soft">
                <div class="font-semibold">Backup (JSON)</div>
                <textarea id="backupJson" class="mt-3 w-full h-56 rounded-2xl bg-surface border border-soft px-4 py-3 focus-ring text-xs" spellcheck="false">${escapeHtml(JSON.stringify(state, null, 2))}</textarea>
                <div class="mt-3 flex flex-wrap gap-2">
                  <button data-action="backup-copy" class="px-4 py-2 rounded-2xl btn-accent font-semibold">Copy</button>
                  <button data-action="backup-download" class="px-4 py-2 rounded-2xl border border-soft hover:bg-card">Download</button>
                  <button data-action="refresh-admin" class="px-4 py-2 rounded-2xl border border-soft hover:bg-card">Refresh</button>
                </div>
              </div>
              <div class="p-4 rounded-2xl bg-card2 border border-soft">
                <div class="font-semibold">Restore</div>
                <div class="text-sm text-muted mt-1">Paste JSON and restore (overwrites current).</div>
                <textarea id="restoreJson" class="mt-3 w-full h-40 rounded-2xl bg-surface border border-soft px-4 py-3 focus-ring text-xs" spellcheck="false" placeholder="Paste JSON here..."></textarea>
                <div class="mt-3 flex flex-wrap gap-2">
                  <button data-action="restore" class="px-4 py-2 rounded-2xl btn-accent font-semibold">Restore</button>
                  <button data-action="reset-all" class="px-4 py-2 rounded-2xl border border-soft hover:bg-card">Reset to default</button>
                  <button data-action="cart-reset" class="px-4 py-2 rounded-2xl border border-soft hover:bg-card">Clear cart</button>
                </div>
              </div>
            </div>
          </section>
        `;
      }

      // ---------- ROUTER ----------
      function route(){
        const isAdmin = location.hash === '#admin';
        $('#storeApp').classList.toggle('hidden', isAdmin);
        $('#adminApp').classList.toggle('hidden', !isAdmin);
        if(isAdmin) renderAdminGate();
        else renderStore();
      }

      // ---------- ORDER MODAL ----------
      function openOrderModal(orderId){
        const o = state.orders.find(x=>x.id===orderId);
        if(!o){ toast('Order not found', 'Orders'); return; }
        ui.viewingOrderId = orderId;
        $('#orderModalTitle').textContent = `Order: ${o.id}`;
        $('#orderModalSub').textContent = `${new Date(o.createdAt).toLocaleString()} ‚Ä¢ ${o.status}`;
        $('#orderCustomer').innerHTML = `
          <div><b>Name:</b> ${escapeHtml(o.customer?.name||'')}</div>
          <div><b>Phone:</b> ${escapeHtml(o.customer?.phone||'')}</div>
          <div><b>City:</b> ${escapeHtml(o.customer?.city||'')}</div>
        `;
        $('#orderDelivery').innerHTML = `
          <div><b>Address:</b> ${escapeHtml(o.customer?.address||'')}</div>
          ${o.customer?.deliveryNote ? `<div><b>Delivery:</b> ${escapeHtml(o.customer.deliveryNote)}</div>`:''}
          ${o.customer?.notes ? `<div><b>Notes:</b> ${escapeHtml(o.customer.notes)}</div>`:''}
          <div class="mt-2"><b>Status:</b> ${escapeHtml(o.status)}</div>
        `;

        $('#orderItems').innerHTML = (o.items||[]).map(it=>{
          const custom = it.custom?.text ? `
            <div class="text-xs text-muted mt-0.5">Print: <span class="text-accent font-semibold">${escapeHtml(it.custom.text)}</span> ‚Ä¢ ${escapeHtml(it.custom.color)} ‚Ä¢ ${it.custom.size}px${it.custom.bold?' ‚Ä¢ bold':''}${it.custom.italic?' ‚Ä¢ italic':''}</div>
          ` : '';
          return `
            <div class="p-3 rounded-2xl border border-soft bg-card2">
              <div class="flex items-start justify-between gap-3">
                <div>
                  <div class="font-semibold">${escapeHtml(it.title)}</div>
                  <div class="text-sm text-muted">${money(it.price)} √ó ${it.qty}</div>
                  ${custom}
                </div>
                <div class="font-extrabold">${money(Number(it.price||0)*Number(it.qty||0))}</div>
              </div>
            </div>
          `;
        }).join('');

        $('#orderSubtotal').textContent = money(o.subtotal||0);
        $('#orderDiscount').textContent = `- ${money(o.discount||0)}`;
        $('#orderTotal').textContent = money(o.total||0);

        $('#orderOverlay').classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
      }

      function closeOrderModal(){
        $('#orderOverlay').classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
        ui.viewingOrderId = null;
      }

      function updateOrderStatus(orderId, status){
        const o = state.orders.find(x=>x.id===orderId);
        if(!o) return;
        o.status = status;
        saveState();
        toast(`Order ${orderId} ‚Üí ${status}`, 'Updated');
        if(location.hash==='#admin' && ui.adminAuthed){
          renderAdmin();
          wireAdminOrdersFilter();
        }
        if($('#orderOverlay') && !$('#orderOverlay').classList.contains('hidden')) openOrderModal(orderId);
      }

      // ---------- FILE HELPERS ----------
      function fileToDataUrl(file){
        return new Promise((resolve, reject)=>{
          const reader = new FileReader();
          reader.onload = ()=> resolve(reader.result);
          reader.onerror = ()=> reject(new Error('File read failed'));
          reader.readAsDataURL(file);
        });
      }

      // ---------- SEARCH/FILTER ----------
      function wireStoreSearch(){
        const inp = $('#productSearch');
        if(!inp) return;
        inp.addEventListener('input', ()=>{
          const q = inp.value.trim().toLowerCase();
          const grid = $('#productGrid');
          if(!grid) return;
          const cards = $$('#productGrid > div');
          cards.forEach(card=>{
            const title = (card.querySelector('.font-bold')?.textContent || '').toLowerCase();
            card.style.display = title.includes(q) ? '' : 'none';
          });
        });
      }

      function wireAdminOrdersFilter(){
        const search = $('#adminOrderSearch');
        const filter = $('#adminOrderFilter');
        const body = $('#ordersTableBody');
        if(!search || !filter || !body) return;

        function apply(){
          const q = search.value.trim().toLowerCase();
          const st = filter.value;
          const rows = $$('[data-order-row="1"]', body);
          rows.forEach(r=>{
            const id = (r.querySelector('td:nth-child(1) .font-semibold')?.textContent || '').toLowerCase();
            const name = (r.querySelector('td:nth-child(2) .font-semibold')?.textContent || '').toLowerCase();
            const phone = (r.querySelector('td:nth-child(2) .text-xs')?.textContent || '').toLowerCase();
            const status = (r.querySelector('td:nth-child(4) span')?.textContent || '').trim();
            const okQ = !q || id.includes(q) || name.includes(q) || phone.includes(q);
            const okS = !st || status === st;
            r.style.display = (okQ && okS) ? '' : 'none';
          });
        }
        search.addEventListener('input', apply);
        filter.addEventListener('change', apply);
      }

      // ---------- EXPORT ----------
      function exportOrdersCsv(){
        const rows = [['id','date','status','name','phone','city','address','subtotal','discount','total','coupon']];
        for(const o of (state.orders||[])){
          rows.push([
            o.id,
            new Date(o.createdAt).toISOString(),
            o.status,
            o.customer?.name||'',
            o.customer?.phone||'',
            o.customer?.city||'',
            (o.customer?.address||'').replaceAll('\n',' '),
            o.subtotal||0,
            o.discount||0,
            o.total||0,
            o.coupon?.code||''
          ]);
        }
        const csv = rows.map(r=>r.map(v=>{
          const s = String(v ?? '');
          return /[",\n]/.test(s) ? `"${s.replaceAll('"','""')}"` : s;
        }).join(',')).join('\n');

        const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `wexwear-orders-${new Date().toISOString().slice(0,10)}.csv`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      // ---------- EVENTS (DELEGATION) ----------
      document.addEventListener('click', async (e)=>{
        const btn = e.target.closest('[data-action]');
        if(!btn) return;
        const action = btn.dataset.action;

        if(action === 'toast-close') $('#toast').classList.add('hidden');

        if(action === 'mobile-menu') $('#mobileMenu')?.classList.toggle('hidden');

        // Cart
        if(action === 'cart-open') openCart();
        if(action === 'cart-close') closeCart();
        if(action === 'cart-clear') { clearCart(); toast('Cart cleared'); }

        // Product actions
        if(action === 'add') addToCart(btn.dataset.id);
        if(action === 'customize') openCustomizer(btn.dataset.id, 'add');
        if(action === 'customize-edit') openCustomizer(btn.dataset.id, 'edit');

        if(action === 'remove') removeFromCart(btn.dataset.id);
        if(action === 'qty') setQty(btn.dataset.id, (cart.items.find(i=>i.productId===btn.dataset.id)?.qty||1) + Number(btn.dataset.delta||0));

        // Custom modal
        if(action === 'custom-close') closeCustomizer();

        // Checkout
        if(action === 'checkout-open') { closeCart(); openCheckout(); }
        if(action === 'checkout-close') closeCheckout();

        if(action === 'coupon-apply'){
          const code = $('#couponInput')?.value || '';
          const c = validateCoupon(code);
          if(!code.trim()){
            ui.couponApplied = null;
            $('#couponStatus').textContent = 'Coupon cleared.';
          } else if(!c){
            ui.couponApplied = null;
            $('#couponStatus').textContent = 'Invalid coupon code.';
          } else {
            ui.couponApplied = c;
            $('#couponStatus').textContent = `Applied: ${c.code} (${c.percent}% off)`;
          }
          renderCheckoutSummary();
        }

        if(action === 'open-whatsapp'){
          const s = state.settings;
          openWhatsAppWithText(`Assalam o Alaikum! I want to print a custom product from ${s.storeName}. Please guide.`);
        }

        if(action === 'buy-wa'){
          const p = productById(btn.dataset.id);
          if(!p) return;
          const s = state.settings;
          const msg = `*${s.storeName}*\nI want to order: *${p.title}*\nPrice: ${money(p.price)}\n\nPlease confirm print options & delivery time.`;
          openWhatsAppWithText(msg);
        }

        if(action === 'refresh-store') { renderStore(); wireStoreSearch(); toast('Store refreshed'); }
        if(action === 'refresh-admin') { renderAdmin(); wireAdminOrdersFilter(); toast('Admin refreshed'); }

        if(action === 'toggle-mode'){
          state.settings.mode = state.settings.mode === 'light' ? 'dark' : 'light';
          saveState();
          applyTheme();
          route();
        }

        if(action === 'reset-demo'){
          if(!confirm('Reset demo data? (products, orders, settings, cart)')) return;
          localStorage.removeItem(LS_KEY);
          localStorage.removeItem(LS_CART);
          sessionStorage.removeItem(SS_ADMIN);
          state = loadState();
          cart = loadCart();
          ui.adminTab = 'dashboard';
          ui.editingProductId = null;
          ui.viewingOrderId = null;
          ui.addImageDraft = '';
          ui.editImageDraft = '';
          ui.logoDraft = '';
          ui.bgDraft = '';
          ui.couponApplied = null;
          ui._showAddProduct = false;
          setAdminAuthed(false);
          applyTheme();
          route();
          toast('Demo reset');
        }

        // Admin navigation
        if(action === 'admin-tab'){
          ui.adminTab = btn.dataset.tab;
          renderAdmin();
          wireAdminOrdersFilter();
        }

        if(action === 'admin-logout'){
          setAdminAuthed(false);
          toast('Logged out', 'Admin');
          renderAdminGate();
        }

        // Products
        if(action === 'product-add-toggle'){
          ui._showAddProduct = !ui._showAddProduct;
          ui.addImageDraft = '';
          renderAdmin();
        }
        if(action === 'product-add-cancel'){
          ui._showAddProduct = false;
          ui.addImageDraft = '';
          renderAdmin();
        }
        if(action === 'product-edit'){
          ui.editingProductId = btn.dataset.id;
          ui.editImageDraft = '';
          renderAdmin();
        }
        if(action === 'product-edit-cancel'){
          ui.editingProductId = null;
          ui.editImageDraft = '';
          renderAdmin();
        }
        if(action === 'product-delete'){
          const id = btn.dataset.id;
          if(!confirm('Delete this product?')) return;
          state.products = state.products.filter(p=>p.id!==id);
          saveState();
          ui.editingProductId = null;
          ui.editImageDraft = '';
          renderAdmin();
          toast('Product deleted');
        }
        if(action === 'product-duplicate'){
          const p = productById(btn.dataset.id);
          if(!p) return;
          const copy = structuredClone(p);
          copy.id = uid('P');
          copy.title = p.title + ' (Copy)';
          state.products.unshift(copy);
          saveState();
          renderAdmin();
          toast('Product duplicated');
        }

        // Links
        if(action === 'link-add'){
          const kind = btn.dataset.kind;
          const list = (kind==='header') ? (state.settings.headerLinks||[]) : (state.settings.footerLinks||[]);
          list.push({ label:'New link', href:'#' });
          if(kind==='header') state.settings.headerLinks = list;
          else state.settings.footerLinks = list;
          saveState();
          renderAdmin();
          toast('Link added');
        }
        if(action === 'link-remove'){
          const kind = btn.dataset.kind;
          const idx = Number(btn.dataset.index);
          const list = (kind==='header') ? (state.settings.headerLinks||[]) : (state.settings.footerLinks||[]);
          list.splice(idx,1);
          if(kind==='header') state.settings.headerLinks = list;
          else state.settings.footerLinks = list;
          saveState();
          renderAdmin();
          toast('Link removed');
        }

        // Logo
        if(action === 'logo-use-draft'){
          if(!ui.logoDraft){ toast('Please upload a logo first', 'Logo'); return; }
          state.settings.logoDataUrl = ui.logoDraft;
          ui.logoDraft = '';
          saveState();
          route();
          toast('Logo updated');
        }
        if(action === 'logo-clear'){
          state.settings.logoDataUrl = '';
          ui.logoDraft = '';
          saveState();
          route();
          toast('Logo removed');
        }

        // Background
        if(action === 'bg-use-draft'){
          if(!ui.bgDraft){ toast('Please upload a background image first', 'Background'); return; }
          state.settings.design.backgroundDataUrl = ui.bgDraft;
          ui.bgDraft = '';
          saveState();
          applyTheme();
          route();
          toast('Background updated');
        }
        if(action === 'bg-clear'){
          state.settings.design.backgroundDataUrl = '';
          ui.bgDraft = '';
          saveState();
          applyTheme();
          route();
          toast('Background removed');
        }

        // Theme
        if(action === 'theme-set'){
          state.settings.themeId = btn.dataset.id;
          state.settings.customAccent = '';
          saveState();
          applyTheme();
          route();
          toast('Theme applied');
        }
        if(action === 'mode-set'){
          state.settings.mode = btn.dataset.mode;
          saveState();
          applyTheme();
          route();
          toast('Mode updated');
        }
        if(action === 'custom-accent-use'){
          const val = $('#customAccent')?.value;
          state.settings.customAccent = val || '';
          saveState();
          applyTheme();
          route();
          toast('Custom color applied');
        }
        if(action === 'custom-accent-clear'){
          state.settings.customAccent = '';
          saveState();
          applyTheme();
          route();
          toast('Custom color reset');
        }

        // Orders
        if(action === 'order-view') openOrderModal(btn.dataset.id);
        if(action === 'order-close') closeOrderModal();
        if(action === 'order-quick') updateOrderStatus(btn.dataset.id, btn.dataset.status);
        if(action === 'order-status'){
          if(!ui.viewingOrderId) return;
          updateOrderStatus(ui.viewingOrderId, btn.dataset.status);
        }
        if(action === 'order-open-wa'){
          if(!ui.viewingOrderId) return;
          const o = state.orders.find(x=>x.id===ui.viewingOrderId);
          if(!o) return;
          openWhatsAppWithText(waMessageForOrder(o));
        }

        if(action === 'orders-clear'){
          if(!confirm('Clear ALL orders?')) return;
          state.orders = [];
          saveState();
          renderAdmin();
          toast('Orders cleared');
        }
        if(action === 'orders-export') exportOrdersCsv();

        // Cloud Sync (Firebase)
        if(action === 'cloud-test') backendTest().catch(err=>toast(err.message || 'Test failed', 'Cloud Sync'));
        if(action === 'cloud-push') backendPush().catch(err=>toast(err.message || 'Push failed', 'Cloud Sync'));
        if(action === 'cloud-pull') backendPull().catch(err=>toast(err.message || 'Pull failed', 'Cloud Sync'));
        if(action === 'cloud-pull-force') backendPull({ force:true }).catch(err=>toast(err.message || 'Pull failed', 'Cloud Sync'));

        // Data
        if(action === 'backup-copy'){
          const t = $('#backupJson');
          t.select();
          document.execCommand('copy');
          toast('Copied JSON');
        }
        if(action === 'backup-download'){
          const blob = new Blob([JSON.stringify(state, null, 2)], {type:'application/json;charset=utf-8'});
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `wexwear-backup-${new Date().toISOString().slice(0,10)}.json`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        }
        if(action === 'restore'){
          const raw = $('#restoreJson')?.value || '';
          const parsed = safeParse(raw, null);
          if(!parsed){ toast('Invalid JSON', 'Restore'); return; }
          state = migrateLoaded(parsed);
          saveState();
          applyTheme();
          route();
          toast('Restored');
        }
        if(action === 'reset-all'){
          if(!confirm('Reset EVERYTHING to default?')) return;
          state = structuredClone(DEFAULT_STATE);
          saveState();
          applyTheme();
          route();
          toast('Reset to default');
        }
        if(action === 'cart-reset'){
          localStorage.removeItem(LS_CART);
          cart = loadCart();
          toast('Cart cleared');
          route();
        }
      });

      // Live preview updates for customizer
      ['input','change'].forEach(evt=>{
        document.addEventListener(evt, (e)=>{
          if(!ui.customDraft) return;
          const t = e.target;
          if(!t) return;
          if(t.id==='customText') ui.customDraft.text = t.value;
          if(t.id==='customColor') ui.customDraft.color = t.value;
          if(t.id==='customSize') { ui.customDraft.size = Number(t.value||42); $('#customSizeVal').textContent = String(ui.customDraft.size); }
          if(t.id==='customBold') ui.customDraft.bold = t.checked;
          if(t.id==='customItalic') ui.customDraft.italic = t.checked;
          if(['customText','customColor','customSize','customBold','customItalic'].includes(t.id)) renderCustomizerPreview();
        });
      });

      document.addEventListener('submit', async (e)=>{
        const form = e.target;

        if(form.matches('[data-form="checkout"]')){
          e.preventDefault();
          placeOrder(form);
        }

        if(form.matches('[data-form="custom"]')){
          e.preventDefault();
          if(!ui.customDraft) return;
          const p = productById(ui.customDraft.productId);
          if(!p) return;
          const custom = {
            text: String(ui.customDraft.text||'').trim().slice(0,80),
            color: String(ui.customDraft.color||'#ffffff'),
            size: Math.max(10, Math.min(120, Number(ui.customDraft.size||42)||42)),
            bold: !!ui.customDraft.bold,
            italic: !!ui.customDraft.italic,
          };

          if(p.customizable && !custom.text){
            toast('Please enter print text (or add a space if you really want blank).', 'Customize');
            return;
          }

          const mode = ui.customDraft.mode;
          closeCustomizer();
          if(mode==='edit') setCartCustom(p.id, custom);
          else addToCart(p.id, 1, custom);
        }

        if(form.matches('[data-form="admin-login"]')){
          e.preventDefault();
          const fd = new FormData(form);
          const pw = String(fd.get('password')||'');
          const hash = await sha256Hex(pw);
          if(hash !== state.settings.security.passwordHash){
            toast('Wrong password', 'Admin');
            return;
          }
          setAdminAuthed(true);
          toast('Welcome back', 'Admin');
          renderAdmin();
          wireAdminOrdersFilter();
        }

        if(form.matches('[data-form="admin-setup"]')){
          e.preventDefault();
          const fd = new FormData(form);
          const a = String(fd.get('newPassword')||'');
          const b = String(fd.get('confirmPassword')||'');
          if(a.length < 4){ toast('Password must be at least 4 characters.', 'Setup'); return; }
          if(a !== b){ toast('Passwords do not match.', 'Setup'); return; }
          state.settings.security.passwordHash = await sha256Hex(a);
          saveState();
          setAdminAuthed(true);
          toast('Password set', 'Admin');
          renderAdmin();
          wireAdminOrdersFilter();
        }

        if(form.matches('[data-form="admin-password"]')){
          e.preventDefault();
          const fd = new FormData(form);
          const cur = String(fd.get('currentPassword')||'');
          const next = String(fd.get('newPassword')||'');
          const confirmPw = String(fd.get('confirmPassword')||'');

          const curHash = await sha256Hex(cur);
          if(curHash !== state.settings.security.passwordHash){
            toast('Current password is incorrect.', 'Security');
            return;
          }
          if(next.length < 4){ toast('New password must be at least 4 characters.', 'Security'); return; }
          if(next !== confirmPw){ toast('New passwords do not match.', 'Security'); return; }

          state.settings.security.passwordHash = await sha256Hex(next);
          saveState();
          toast('Password updated', 'Security');
          form.reset();
        }

        if(form.matches('[data-form="add-product"]')){
          e.preventDefault();
          const fd = new FormData(form);
          const p = {
            id: uid('P'),
            title: String(fd.get('title')||'').trim(),
            price: Number(fd.get('price')||0),
            compareAt: fd.get('compareAt') ? Number(fd.get('compareAt')||0) : 0,
            inStock: !!fd.get('inStock'),
            customizable: !!fd.get('customizable'),
            badge: String(fd.get('badge')||'').trim(),
            emoji: String(fd.get('emoji')||'').trim(),
            imageDataUrl: ui.addImageDraft || '',
            description: String(fd.get('description')||'').trim(),
          };
          if(!p.title || !(p.price>0)) { toast('Title and price required', 'Products'); return; }
          state.products.unshift(p);
          saveState();
          ui._showAddProduct = false;
          ui.addImageDraft = '';
          renderAdmin();
          toast('Product added');
        }

        if(form.matches('[data-form="edit-product"]')){
          e.preventDefault();
          const id = form.dataset.id;
          const p = productById(id);
          if(!p) return;
          const fd = new FormData(form);
          p.title = String(fd.get('title')||'').trim();
          p.price = Number(fd.get('price')||0);
          p.compareAt = fd.get('compareAt') ? Number(fd.get('compareAt')||0) : 0;
          p.badge = String(fd.get('badge')||'').trim();
          p.emoji = String(fd.get('emoji')||'').trim();
          p.inStock = !!fd.get('inStock');
          p.customizable = !!fd.get('customizable');
          p.description = String(fd.get('description')||'').trim();
          if(ui.editImageDraft) p.imageDataUrl = ui.editImageDraft;

          saveState();
          ui.editImageDraft = '';
          ui.editingProductId = null;
          renderAdmin();
          toast('Product updated');
        }

        if(form.matches('[data-form="store-settings"]')){
          e.preventDefault();
          const fd = new FormData(form);
          state.settings.storeName = String(fd.get('storeName')||'').trim() || 'WexWear.PK';
          state.settings.whatsappNumber = normalizeWaNumber(String(fd.get('whatsappNumber')||'').trim()) || '923102155721';
          state.settings.announcement = String(fd.get('announcement')||'').trim();
          state.settings.heroTitle = String(fd.get('heroTitle')||'').trim();
          state.settings.heroSubtitle = String(fd.get('heroSubtitle')||'').trim();
          state.settings.showFloatingWhatsApp = !!fd.get('showFloatingWhatsApp');

          const headerRows = $$('[data-link-row="header"]');
          state.settings.headerLinks = headerRows.map(r=>({
            label: r.querySelector('[data-field="label"]')?.value.trim() || '',
            href: r.querySelector('[data-field="href"]')?.value.trim() || '#',
          })).filter(x=>x.label);

          const footerRows = $$('[data-link-row="footer"]');
          state.settings.footerLinks = footerRows.map(r=>({
            label: r.querySelector('[data-field="label"]')?.value.trim() || '',
            href: r.querySelector('[data-field="href"]')?.value.trim() || '#',
          })).filter(x=>x.label);

          state.settings.footerText = String(fd.get('footerText')||'').trim();

          saveState();
          applyTheme();
          route();
          toast('Settings saved');
        }

        if(form.matches('[data-form="coupon"]')){
          e.preventDefault();
          const fd = new FormData(form);
          const enabled = !!fd.get('enabled');
          const code = String(fd.get('code')||'').trim() || 'WEX10';
          const percent = Math.max(1, Math.min(90, Number(fd.get('percent')||10) || 10));
          state.settings.coupon = { enabled, code, percent };
          saveState();
          toast('Coupon saved');
          renderAdmin();
        }

        if(form.matches('[data-form="design"]')){
          e.preventDefault();
          const fd = new FormData(form);
          const d = state.settings.design;
          d.fontScale = Number(fd.get('fontScale')||1) || 1;
          d.heroTitleSize = Number(fd.get('heroTitleSize')||56) || 56;
          d.heroSubtitleSize = Number(fd.get('heroSubtitleSize')||18) || 18;
          d.heroTitleColor = String(fd.get('heroTitleColor')||'');
          d.heroSubtitleColor = String(fd.get('heroSubtitleColor')||'');
          d.heroTitleBold = !!fd.get('heroTitleBold');
          d.heroTitleItalic = !!fd.get('heroTitleItalic');
          d.heroSubtitleItalic = !!fd.get('heroSubtitleItalic');
          saveState();
          applyTheme();
          route();
          toast('Design saved');
        }
      });

      document.addEventListener('change', async (e)=>{
        const el = e.target;
        if(el && el.id === 'addProductImage'){
          const file = el.files?.[0];
          if(!file) return;
          ui.addImageDraft = await fileToDataUrl(file);
          renderAdmin();
          toast('Image selected');
        }
        if(el && el.id === 'editProductImage'){
          const file = el.files?.[0];
          if(!file) return;
          ui.editImageDraft = await fileToDataUrl(file);
          renderAdmin();
          toast('New image selected');
        }
        if(el && el.id === 'logoUpload'){
          const file = el.files?.[0];
          if(!file) return;
          ui.logoDraft = await fileToDataUrl(file);
          renderAdmin();
          toast('Logo selected');
        }
        if(el && el.id === 'bgUpload'){
          const file = el.files?.[0];
          if(!file) return;
          ui.bgDraft = await fileToDataUrl(file);
          renderAdmin();
          toast('Background selected');
        }
      });

      // ---------- INIT ----------
      let state = loadState();
      let cart = loadCart();
      applyTheme();

      // if someone had old ShopHub keys, we intentionally start fresh under new brand
      route();
      wireStoreSearch();
      if(location.hash==='#admin' && ui.adminAuthed) wireAdminOrdersFilter();

      window.addEventListener('hashchange', ()=>{
        route();
        setTimeout(()=>{
          wireStoreSearch();
          if(location.hash==='#admin' && ui.adminAuthed) wireAdminOrdersFilter();
        }, 0);
      });

      renderStoreHeaderBadge();

    })();
  </script>
</body>
</html><!doctype html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WexWear.PK ‚Äî Print On Demand Store</title>
  <meta name="description" content="WexWear.PK ‚Äî Print on demand products, WhatsApp orders, admin dashboard, coupon, themes." />
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <style>
    :root{
      --accent:#10b981;
      --accent2:#064e3b;

      --bg:#070a12;
      --surface:#0b1220;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.04);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --border: rgba(148,163,184,.18);
      --ring: rgba(16,185,129,.30);
      --shadow: 0 18px 55px rgba(0,0,0,.45);

      --bgImage: none;
      --bgOverlayColor: rgba(0,0,0,0);
      --fontScale: 1;

      --heroTitleSize: 56px;
      --heroSubtitleSize: 18px;
      --heroTitleColor: var(--text);
      --heroSubtitleColor: var(--muted);
      --heroTitleWeight: 900;
      --heroTitleStyle: normal;
      --heroSubtitleStyle: normal;
    }
    html.light{
      --bg:#f8fafc;
      --surface:#ffffff;
      --card: rgba(2,6,23,.04);
      --card2: rgba(2,6,23,.03);
      --text:#0f172a;
      --muted:#475569;
      --border: rgba(15,23,42,.12);
      --ring: rgba(16,185,129,.22);
      --shadow: 0 18px 55px rgba(2,6,23,.12);
    }

    body{
      background-color: var(--bg);
      color: var(--text);
      background-image: linear-gradient(var(--bgOverlayColor), var(--bgOverlayColor)), var(--bgImage);
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      font-size: calc(16px * var(--fontScale));
    }

    .bg-surface{background:var(--surface);} 
    .bg-card{background:var(--card);} 
    .bg-card2{background:var(--card2);} 
    .text-muted{color:var(--muted);} 
    .border-soft{border-color:var(--border);} 
    .shadow-soft{box-shadow:var(--shadow);} 
    .ring-soft{box-shadow:0 0 0 4px var(--ring);} 
    .glass{background:var(--card); backdrop-filter: blur(10px); border:1px solid var(--border);} 
    .btn-accent{background:var(--accent); color:white;} 
    .btn-accent:hover{filter: brightness(.95);} 
    .btn-accent:active{transform: translateY(1px);} 
    .text-accent{color:var(--accent);} 
    .bg-accent{background:var(--accent);} 
    .bg-accent2{background:var(--accent2);} 
    .focus-ring:focus{outline:none; box-shadow:0 0 0 4px var(--ring);} 
    .modal-backdrop{background: rgba(2,6,23,.72);} 
    .no-scrollbar::-webkit-scrollbar{width:0;height:0;}
    .no-scrollbar{scrollbar-width:none;}

    .hero-title{
      font-size: var(--heroTitleSize) !important;
      color: var(--heroTitleColor) !important;
      font-weight: var(--heroTitleWeight) !important;
      font-style: var(--heroTitleStyle) !important;
      letter-spacing: -0.02em;
      line-height: 1.05;
    }
    .hero-subtitle{
      font-size: var(--heroSubtitleSize) !important;
      color: var(--heroSubtitleColor) !important;
      font-style: var(--heroSubtitleStyle) !important;
    }

    @media (max-width: 640px){
      :root{ --heroTitleSize: 40px; }
    }

    @media (prefers-reduced-motion: reduce){
      *{scroll-behavior:auto !important; transition:none !important; animation:none !important;}
    }
  </style>
</head>
<body class="min-h-full">

  <!-- ROUTED APPS -->
  <div id="storeApp" class="min-h-screen"></div>
  <div id="adminApp" class="min-h-screen hidden"></div>

  <!-- TOAST -->
  <div id="toast" class="fixed z-[100] left-1/2 -translate-x-1/2 bottom-5 hidden">
    <div class="glass shadow-soft rounded-2xl px-4 py-3 flex items-center gap-3">
      <div id="toastDot" class="h-2.5 w-2.5 rounded-full bg-accent"></div>
      <div>
        <div id="toastTitle" class="font-semibold">Info</div>
        <div id="toastMsg" class="text-sm text-muted"></div>
      </div>
      <button data-action="toast-close" class="ml-2 px-2 py-1 rounded-lg border border-soft hover:bg-card2">Close</button>
    </div>
  </div>

  <!-- CART DRAWER -->
  <div id="cartOverlay" class="fixed inset-0 z-[80] hidden">
    <div class="absolute inset-0 modal-backdrop" data-action="cart-close"></div>
    <aside class="absolute right-0 top-0 h-full w-full sm:w-[460px] bg-surface border-l border-soft shadow-soft">
      <div class="p-4 border-b border-soft flex items-center justify-between">
        <div>
          <div class="text-lg font-bold">Your Cart</div>
          <div class="text-sm text-muted">Review custom prints & checkout</div>
        </div>
        <button data-action="cart-close" class="px-3 py-2 rounded-xl border border-soft hover:bg-card2">‚úï</button>
      </div>
      <div class="p-4 overflow-y-auto h-[calc(100%-180px)] no-scrollbar" id="cartItems"></div>
      <div class="p-4 border-t border-soft">
        <div class="flex items-center justify-between">
          <div class="text-sm text-muted">Subtotal</div>
          <div id="cartSubtotal" class="font-semibold">Rs 0</div>
        </div>
        <button data-action="checkout-open" class="mt-3 w-full btn-accent rounded-2xl px-4 py-3 font-semibold">Checkout on WhatsApp</button>
        <button data-action="cart-clear" class="mt-2 w-full rounded-2xl px-4 py-3 border border-soft hover:bg-card2">Clear cart</button>
      </div>
    </aside>
  </div>

  <!-- CHECKOUT MODAL -->
  <div id="checkoutOverlay" class="fixed inset-0 z-[90] hidden">
    <div class="absolute inset-0 modal-backdrop" data-action="checkout-close"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="w-full max-w-3xl bg-surface border border-soft shadow-soft rounded-3xl overflow-hidden">
        <div class="p-5 border-b border-soft flex items-start justify-between gap-4">
          <div>
            <div class="text-xl font-bold">Checkout</div>
            <div class="text-sm text-muted">Order will be sent directly to your WhatsApp.</div>
          </div>
          <button data-action="checkout-close" class="px-3 py-2 rounded-xl border border-soft hover:bg-card2">‚úï</button>
        </div>
        <div class="grid md:grid-cols-2 gap-0">
          <div class="p-5 border-b md:border-b-0 md:border-r border-soft">
            <form id="checkoutForm" data-form="checkout" class="space-y-4">
              <div class="grid sm:grid-cols-2 gap-3">
                <div>
                  <label class="text-sm text-muted">Name</label>
                  <input required class="mt-1 w-full rounded-2xl bg-card2 border border-soft px-4 py-3 focus-ring" name="name" placeholder="Your name" />
                </div>
                <div>
                  <label class="text-sm text-muted">Phone</label>
                  <input required class="mt-1 w-full rounded-2xl bg-card2 border border-soft px-4 py-3 focus-ring" name="phone" placeholder="03xx..." />
                </div>
              </div>
              <div class="grid sm:grid-cols-2 gap-3">
                <div>
                  <label class="text-sm text-muted">City</label>
                  <input required class="mt-1 w-full rounded-2xl bg-card2 border border-soft px-4 py-3 focus-ring" name="city" placeholder="Karachi / Lahore..." />
                </div>
                <div>
                  <label class="text-sm text-muted">Delivery Note (optional)</label>
                  <input class="mt-1 w-full rounded-2xl bg-card2 border border-soft px-4 py-3 focus-ring" name="deliveryNote" placeholder="e.g. call before delivery" />
                </div>
              </div>
              <div>
                <label class="text-sm text-muted">Address</label>
                <textarea required class="mt-1 w-full rounded-2xl bg-card2 border border-soft px-4 py-3 focus-ring" name="address" rows="3" placeholder="House, street, area"></textarea>
              </div>
              <div>
                <label class="text-sm text-muted">Coupon code</label>
                <div class="mt-1 flex gap-2">
                  <input class="flex-1 rounded-2xl bg-card2 border border-soft px-4 py-3 focus-ring" id="couponInput" placeholder="e.g. WEX10" />
                  <button type="button" data-action="coupon-apply" class="px-4 py-3 rounded-2xl border border-soft hover:bg-card2">Apply</button>
                </div>
                <div id="couponStatus" class="mt-2 text-sm text-muted"></div>
              </div>
              <div>
                <label class="text-sm text-muted">Notes (optional)</label>
                <textarea class="mt-1 w-full rounded-2xl bg-card2 border border-soft px-4 py-3 focus-ring" name="notes" rows="2" placeholder="Any extra info"></textarea>
              </div>
              <button class="w-full btn-accent rounded-2xl px-4 py-3 font-semibold">Place Order ‚Üí WhatsApp</button>
              <div class="text-xs text-muted">
                Note: This demo saves products/orders in <b>your browser</b> (localStorage). For real multi-device admin, backend hosting is needed.
              </div>
            </form>
          </div>
          <div class="p-5">
            <div class="flex items-center justify-between">
              <div class="font-semibold">Order summary</div>
              <button data-action="cart-open" class="text-sm text-accent hover:underline">Edit cart</button>
            </div>
            <div id="checkoutSummary" class="mt-3 space-y-3"></div>
            <div class="mt-4 pt-4 border-t border-soft space-y-2">
              <div class="flex items-center justify-between"><span class="text-sm text-muted">Subtotal</span><span id="sumSubtotal" class="font-semibold">Rs 0</span></div>
              <div class="flex items-center justify-between"><span class="text-sm text-muted">Discount</span><span id="sumDiscount" class="font-semibold">- Rs 0</span></div>
              <div class="flex items-center justify-between text-lg"><span class="font-semibold">Total</span><span id="sumTotal" class="font-extrabold">Rs 0</span></div>
              <div class="mt-2 text-xs text-muted">Payment method: Cash on Delivery (customizable later)</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- CUSTOMIZER MODAL (PRINT TEXT) -->
  <div id="customOverlay" class="fixed inset-0 z-[85] hidden">
    <div class="absolute inset-0 modal-backdrop" data-action="custom-close"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="w-full max-w-4xl bg-surface border border-soft shadow-soft rounded-3xl overflow-hidden">
        <div class="p-5 border-b border-soft flex items-start justify-between gap-4">
          <div>
            <div class="text-xl font-bold">Customize Print</div>
            <div id="customSub" class="text-sm text-muted">Add your text and styling.</div>
          </div>
          <button data-action="custom-close" class="px-3 py-2 rounded-xl border border-soft hover:bg-card2">‚úï</button>
        </div>
        <div class="grid md:grid-cols-2 gap-0">
          <div class="p-5 border-b md:border-b-0 md:border-r border-soft">
            <div class="rounded-3xl border border-soft overflow-hidden bg-card2">
              <div id="customPreview" class="relative aspect-square w-full"></div>
            </div>
            <div class="mt-3 text-xs text-muted">Preview is for demo; final print may vary slightly.</div>
          </div>
          <div class="p-5">
            <form id="customForm" data-form="custom" class="space-y-4">
              <div>
                <label class="text-sm text-muted">Print text</label>
                <input id="customText" class="mt-1 w-full rounded-2xl bg-card2 border border-soft px-4 py-3 focus-ring" placeholder="e.g. WexWear" maxlength="80" />
              </div>
              <div class="grid grid-cols-2 gap-3">
                <div>
                  <label class="text-sm text-muted">Text color</label>
                  <input id="customColor" type="color" class="mt-1 h-12 w-full rounded-2xl border border-soft bg-surface" value="#ffffff" />
                </div>
                <div>
                  <label class="text-sm text-muted">Font size</label>
                  <input id="customSize" type="range" min="14" max="72" value="42" class="mt-3 w-full" />
                  <div class="mt-1 text-xs text-muted"><span id="customSizeVal">42</span> px</div>
                </div>
              </div>
              <div class="flex flex-wrap gap-3">
                <label class="inline-flex items-center gap-2 text-sm text-muted"><input id="customBold" type="checkbox" checked /> Bold</label>
                <label class="inline-flex items-center gap-2 text-sm text-muted"><input id="customItalic" type="checkbox" /> Italic</label>
              </div>
              <div class="pt-2 border-t border-soft flex flex-col gap-2">
                <button class="w-full btn-accent rounded-2xl px-4 py-3 font-semibold">Save & Add to Cart</button>
                <button type="button" data-action="custom-close" class="w-full rounded-2xl px-4 py-3 border border-soft hover:bg-card2">Cancel</button>
              </div>
              <div class="text-xs text-muted">
                Tip: Cart ⁄©€í ÿßŸÜÿØÿ± ÿ®⁄æ€å "Customize" ÿ≥€í ÿ¢Ÿæ design update ⁄©ÿ± ÿ≥⁄©ÿ™€í €Å€å⁄∫€î
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ADMIN ORDER DETAILS MODAL -->
  <div id="orderOverlay" class="fixed inset-0 z-[90] hidden">
    <div class="absolute inset-0 modal-backdrop" data-action="order-close"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="w-full max-w-4xl bg-surface border border-soft shadow-soft rounded-3xl overflow-hidden">
        <div class="p-5 border-b border-soft flex items-start justify-between gap-4">
          <div>
            <div id="orderModalTitle" class="text-xl font-bold">Order</div>
            <div id="orderModalSub" class="text-sm text-muted">Details</div>
          </div>
          <button data-action="order-close" class="px-3 py-2 rounded-xl border border-soft hover:bg-card2">‚úï</button>
        </div>
        <div class="p-5 grid md:grid-cols-2 gap-4">
          <div class="glass rounded-2xl p-4 border border-soft">
            <div class="font-semibold">Customer</div>
            <div id="orderCustomer" class="mt-2 text-sm text-muted"></div>
            <div class="mt-4 font-semibold">Delivery</div>
            <div id="orderDelivery" class="mt-2 text-sm text-muted"></div>
            <div class="mt-4 font-semibold">Actions</div>
            <div class="mt-2 flex flex-wrap gap-2">
              <button data-action="order-status" data-status="Pending" class="px-3 py-2 rounded-xl border border-soft hover:bg-card2">Mark Pending</button>
              <button data-action="order-status" data-status="Delivered" class="px-3 py-2 rounded-xl bg-accent text-white">Mark Delivered</button>
              <button data-action="order-status" data-status="Cancelled" class="px-3 py-2 rounded-xl border border-soft hover:bg-card2">Cancel</button>
              <button data-action="order-open-wa" class="px-3 py-2 rounded-xl border border-soft hover:bg-card2">Open WhatsApp</button>
            </div>
          </div>
          <div class="glass rounded-2xl p-4 border border-soft">
            <div class="font-semibold">Items</div>
            <div id="orderItems" class="mt-3 space-y-3"></div>
            <div class="mt-4 pt-4 border-t border-soft space-y-2">
              <div class="flex items-center justify-between"><span class="text-sm text-muted">Subtotal</span><span id="orderSubtotal" class="font-semibold"></span></div>
              <div class="flex items-center justify-between"><span class="text-sm text-muted">Discount</span><span id="orderDiscount" class="font-semibold"></span></div>
              <div class="flex items-center justify-between text-lg"><span class="font-semibold">Total</span><span id="orderTotal" class="font-extrabold"></span></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    (()=>{
      const LS_KEY = 'wexwear_state_v1';
      const LS_CART = 'wexwear_cart_v1';
      const SS_ADMIN = 'wexwear_admin_authed_v1';

      const THEMES = {
        emerald: { name:'Emerald', accent:'#10b981', accent2:'#064e3b' },
        indigo:  { name:'Indigo',  accent:'#6366f1', accent2:'#312e81' },
        rose:    { name:'Rose',    accent:'#f43f5e', accent2:'#881337' },
        amber:   { name:'Amber',   accent:'#f59e0b', accent2:'#78350f' },
        sky:     { name:'Sky',     accent:'#0ea5e9', accent2:'#0c4a6e' },
        violet:  { name:'Violet',  accent:'#8b5cf6', accent2:'#4c1d95' },
      };

      const DEFAULT_STATE = {
        version: 1,
        updatedAt: 0, // used for cloud sync conflict resolution
        settings: {
          storeName: 'WexWear.PK',
          whatsappNumber: '923102155721',
          announcement: 'WexWear.PK ‚Äî Print-on-Demand | WhatsApp Orders (Demo)',
          heroTitle: 'WexWear.PK ‚Äî Your Text, Your Style',
          heroSubtitle: 'T-shirts, hoodies, mugs aur caps par apna custom text print karwayein. Order WhatsApp par bhejein.',
          currencyLabel: 'Rs',
          coupon: { enabled: true, code: 'WEX10', percent: 10 },
          mode: 'dark',
          themeId: 'violet',
          customAccent: '',
          logoDataUrl: '',
          showFloatingWhatsApp: true,
          headerLinks: [
            { label:'Home', href:'#home' },
            { label:'Products', href:'#products' },
            { label:'How it works', href:'#how' },
          ],
          footerLinks: [
            { label:'Shipping', href:'#how' },
            { label:'Returns', href:'#how' },
            { label:'Contact', href:'#footer' },
          ],
          footerText: '¬© ' + new Date().getFullYear() + ' WexWear.PK. All rights reserved.',

          // NEW
          security: {
            passwordHash: ''
          },
          backend: {
            // Cloud sync (optional). Works even if you only run this HTML file.
            // provider:
            //  - 'firebase'  => Firebase Realtime Database URL (no server)
            //  - 'jsonblob'  => https://jsonblob.com blob URL (public)
            provider: 'firebase',
            enabled: false,
            baseUrl: '',
            token: '',
            path: 'wexwear_state_v1',
            autoSync: false,
          },
          design: {
            backgroundDataUrl: '',
            fontScale: 1,
            heroTitleSize: 56,
            heroSubtitleSize: 18,
            heroTitleColor: '',
            heroSubtitleColor: '',
            heroTitleBold: true,
            heroTitleItalic: false,
            heroSubtitleItalic: false,
          }
        },
        products: [
          {
            id:'p_tshirt',
            title:'Custom T‚ÄëShirt (Unisex)',
            price: 1299,
            compareAt: 1599,
            inStock: true,
            badge: 'Best Seller',
            emoji: 'üëï',
            imageDataUrl: '',
            description: 'Add your text, choose color & styling. (Demo)',
            customizable: true,
          },
          {
            id:'p_hoodie',
            title:'Premium Hoodie',
            price: 2599,
            compareAt: 2999,
            inStock: true,
            badge: 'Winter',
            emoji: 'üß•',
            imageDataUrl: '',
            description: 'Warm hoodie with custom front print text. (Demo)',
            customizable: true,
          },
          {
            id:'p_mug',
            title:'Ceramic Mug (11oz)',
            price: 799,
            compareAt: 999,
            inStock: true,
            badge: 'Gift',
            emoji: '‚òï',
            imageDataUrl: '',
            description: 'Custom text print for your coffee mug. (Demo)',
            customizable: true,
          },
          {
            id:'p_cap',
            title:'Cap / Hat',
            price: 699,
            compareAt: 899,
            inStock: true,
            badge: 'New',
            emoji: 'üß¢',
            imageDataUrl: '',
            description: 'Minimal cap with custom text embroidery print (demo).',
            customizable: true,
          },
          {
            id:'p_totebag',
            title:'Tote Bag',
            price: 899,
            compareAt: 1099,
            inStock: true,
            badge: 'Eco',
            emoji: 'üëú',
            imageDataUrl: '',
            description: 'Carry style with your own quote/text (demo).',
            customizable: true,
          },
          {
            id:'p_sticker',
            title:'Sticker Pack',
            price: 399,
            compareAt: 499,
            inStock: true,
            badge: 'Value',
            emoji: 'üè∑Ô∏è',
            imageDataUrl: '',
            description: 'A fun sticker pack for laptop & phone (demo).',
            customizable: false,
          },
        ],
        orders: []
      };

      const ui = {
        adminTab: 'dashboard',
        editingProductId: null,
        viewingOrderId: null,
        addImageDraft: '',
        editImageDraft: '',
        logoDraft: '',
        bgDraft: '',
        couponApplied: null,

        _showAddProduct: false,
        adminAuthed: sessionStorage.getItem(SS_ADMIN) === '1',

        customDraft: null, // { productId, mode:'add'|'edit', text,color,size,bold,italic }
      };

      const $ = (sel, root=document)=>root.querySelector(sel);
      const $$ = (sel, root=document)=>Array.from(root.querySelectorAll(sel));

      function safeParse(json, fallback){
        try{ return JSON.parse(json); } catch{ return fallback; }
      }

      function migrateLoaded(parsed){
        // merge with defaults
        const merged = {
          ...structuredClone(DEFAULT_STATE),
          ...parsed,
          settings: { ...structuredClone(DEFAULT_STATE.settings), ...(parsed.settings||{}) },
          products: Array.isArray(parsed.products) ? parsed.products : structuredClone(DEFAULT_STATE.products),
          orders: Array.isArray(parsed.orders) ? parsed.orders : [],
        };

        // ensure nested
        merged.settings.security = { ...structuredClone(DEFAULT_STATE.settings.security), ...(merged.settings.security||{}) };
        merged.settings.design = { ...structuredClone(DEFAULT_STATE.settings.design), ...(merged.settings.design||{}) };
        merged.settings.backend = { ...structuredClone(DEFAULT_STATE.settings.backend), ...(merged.settings.backend||{}) };

        // ensure product fields
        merged.products = merged.products.map(p=>({
          customizable: false,
          ...p,
        }));

        // updatedAt fallback for sync conflict resolution
        merged.updatedAt = Number(merged.updatedAt||0) || 0;

        return merged;
      }

      function loadState(){
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return structuredClone(DEFAULT_STATE);
        const parsed = safeParse(raw, null);
        if(!parsed || typeof parsed !== 'object') return structuredClone(DEFAULT_STATE);
        return migrateLoaded(parsed);
      }
      function saveState(opts={}){
        const touch = opts.touch !== false;
        const sync = opts.sync !== false;
        if(touch) state.updatedAt = Date.now();
        localStorage.setItem(LS_KEY, JSON.stringify(state));
        if(sync) backendMaybeAutoSync();
      }

      function backendCfg(){
        const b = state.settings.backend || {};
        const cleanBase = String(b.baseUrl||'').trim().replace(/\/+$/,'');
        const cleanPath = String(b.path||'wexwear_state_v1').trim().replace(/^\/+|\/+$/g,'');
        return {
          provider: String(b.provider||'firebase'),
          enabled: !!b.enabled,
          baseUrl: cleanBase,
          token: String(b.token||'').trim(),
          path: cleanPath,
          autoSync: !!b.autoSync,
        };
      }

      function backendEnabled(){
        const c = backendCfg();
        return c.enabled && !!c.baseUrl;
      }

      function backendStateUrl(){
        const c = backendCfg();
        if(c.provider === 'firebase'){
          const auth = c.token ? `?auth=${encodeURIComponent(c.token)}` : '';
          const p = c.path ? `/${c.path}` : '';
          return `${c.baseUrl}${p}.json${auth}`;
        }
        if(c.provider === 'jsonblob'){
          // Expect full API URL like: https://jsonblob.com/api/jsonBlob/<id>
          return c.baseUrl;
        }
        throw new Error('Unknown cloud provider.');
      }

      async function backendTest(){
        if(!backendEnabled()) { toast('Cloud sync not configured (enable + base URL).', 'Cloud Sync'); return; }
        const url = backendStateUrl();
        const res = await fetch(url, { method:'GET', headers:{'Accept':'application/json'} });
        if(!res.ok) throw new Error(`Connection failed (HTTP ${res.status}).`);
        toast('Connection OK', 'Cloud Sync');
      }

      async function backendPull(opts={}){
        const force = !!opts.force;
        if(!backendEnabled()) { toast('Cloud sync not configured (enable + base URL).', 'Cloud Sync'); return; }
        const url = backendStateUrl();
        const res = await fetch(url, { method:'GET', headers:{'Accept':'application/json'} });
        if(!res.ok) throw new Error(`Pull failed (HTTP ${res.status}).`);
        const data = await res.json();
        if(!data){ toast('No cloud data found.', 'Cloud Sync'); return; }
        const remote = migrateLoaded(data);
        const localAt = Number(state.updatedAt||0) || 0;
        const remoteAt = Number(remote.updatedAt||0) || 0;
        if(!force && localAt && remoteAt && remoteAt < localAt){
          const ok = confirm('Cloud data is older than local data. Overwrite local anyway?');
          if(!ok) return;
        }
        state = remote;
        saveState({ touch:false, sync:false });
        applyTheme();
        route();
        toast('Pulled from cloud', 'Cloud Sync');
      }

      async function backendPush(){
        if(!backendEnabled()) { toast('Cloud sync not configured (enable + base URL).', 'Cloud Sync'); return; }
        const url = backendStateUrl();
        const payload = structuredClone(state);
        payload.updatedAt = Date.now();
        const res = await fetch(url, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        if(!res.ok) throw new Error(`Push failed (HTTP ${res.status}).`);
        state.updatedAt = payload.updatedAt;
        saveState({ touch:false, sync:false });
        toast('Pushed to cloud', 'Cloud Sync');
      }

      function backendMaybeAutoSync(){
        const c = backendCfg();
        if(!c.enabled || !c.autoSync || !c.baseUrl) return;
        clearTimeout(backendMaybeAutoSync._t);
        backendMaybeAutoSync._t = setTimeout(()=>{
          backendPush().catch(err=>toast(err.message || 'Sync failed', 'Cloud Sync'));
        }, 900);
      }

      function loadCart(){
        const raw = localStorage.getItem(LS_CART);
        const parsed = raw ? safeParse(raw, null) : null;
        if(!parsed || !Array.isArray(parsed.items)) return { items: [] };
        return {
          items: parsed.items
            .filter(it=>it && it.productId && Number.isFinite(it.qty))
            .map(it=>({
              productId: String(it.productId||''),
              qty: Math.max(1, Math.min(99, Number(it.qty)||1)),
              custom: (it.custom && typeof it.custom === 'object') ? {
                text: String(it.custom.text||'').slice(0,80),
                color: String(it.custom.color||'#ffffff'),
                size: Math.max(10, Math.min(120, Number(it.custom.size||42)||42)),
                bold: !!it.custom.bold,
                italic: !!it.custom.italic,
              } : null
            }))
        };
      }
      function saveCart(){ localStorage.setItem(LS_CART, JSON.stringify(cart)); }

      function escapeHtml(str){
        return String(str ?? '')
          .replaceAll('&','&amp;')
          .replaceAll('<','&lt;')
          .replaceAll('>','&gt;')
          .replaceAll('"','&quot;')
          .replaceAll("'",'&#039;');
      }

      function money(n){
        const num = Number(n||0);
        return `${state.settings.currencyLabel} ${Math.round(num).toLocaleString('en-PK')}`;
      }

      function uid(prefix='WEX'){
        const rand = Math.random().toString(16).slice(2,6).toUpperCase();
        const t = Date.now().toString(36).toUpperCase();
        return `${prefix}-${rand}-${t}`;
      }

      function normalizeWaNumber(num){
        return String(num||'').replaceAll('+','').replaceAll(' ','').replaceAll('-','');
      }

      async function sha256Hex(str){
        const enc = new TextEncoder();
        const buf = await crypto.subtle.digest('SHA-256', enc.encode(String(str||'')));
        return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
      }

      function toast(msg, title='Done'){
        $('#toastTitle').textContent = title;
        $('#toastMsg').textContent = msg;
        $('#toast').classList.remove('hidden');
        clearTimeout(toast._t);
        toast._t = setTimeout(()=>$('#toast').classList.add('hidden'), 3300);
      }

      function setAdminAuthed(v){
        ui.adminAuthed = !!v;
        if(ui.adminAuthed) sessionStorage.setItem(SS_ADMIN, '1');
        else sessionStorage.removeItem(SS_ADMIN);
      }

      function applyTheme(){
        const s = state.settings;
        const t = THEMES[s.themeId] || THEMES.emerald;
        const accent = (s.customAccent && /^#([0-9a-fA-F]{3}){1,2}$/.test(s.customAccent)) ? s.customAccent : t.accent;
        document.documentElement.style.setProperty('--accent', accent);
        document.documentElement.style.setProperty('--accent2', t.accent2);

        if(s.mode === 'light') document.documentElement.classList.add('light');
        else document.documentElement.classList.remove('light');

        const d = s.design || {};
        const hasBg = !!d.backgroundDataUrl;
        document.documentElement.style.setProperty('--bgImage', hasBg ? `url(${d.backgroundDataUrl})` : 'none');
        document.documentElement.style.setProperty('--bgOverlayColor', hasBg ? (s.mode==='light' ? 'rgba(248,250,252,.72)' : 'rgba(2,6,23,.74)') : 'rgba(0,0,0,0)');

        const fontScale = Number(d.fontScale||1);
        document.documentElement.style.setProperty('--fontScale', String(Math.max(0.85, Math.min(1.25, fontScale))));

        const heroTitleSize = Number(d.heroTitleSize||56);
        const heroSubtitleSize = Number(d.heroSubtitleSize||18);
        document.documentElement.style.setProperty('--heroTitleSize', `${Math.max(30, Math.min(90, heroTitleSize))}px`);
        document.documentElement.style.setProperty('--heroSubtitleSize', `${Math.max(12, Math.min(40, heroSubtitleSize))}px`);

        document.documentElement.style.setProperty('--heroTitleColor', d.heroTitleColor || 'var(--text)');
        document.documentElement.style.setProperty('--heroSubtitleColor', d.heroSubtitleColor || 'var(--muted)');
        document.documentElement.style.setProperty('--heroTitleWeight', d.heroTitleBold ? '900' : '800');
        document.documentElement.style.setProperty('--heroTitleStyle', d.heroTitleItalic ? 'italic' : 'normal');
        document.documentElement.style.setProperty('--heroSubtitleStyle', d.heroSubtitleItalic ? 'italic' : 'normal');
      }

      function productById(id){ return state.products.find(p=>p.id===id); }

      function cartCount(){ return cart.items.reduce((a,it)=>a+it.qty,0); }
      function cartSubtotal(){
        return cart.items.reduce((sum, it)=>{
          const p = productById(it.productId);
          if(!p) return sum;
          return sum + (Number(p.price)||0) * it.qty;
        }, 0);
      }

      function calcDiscount(subtotal, coupon){
        if(!coupon) return 0;
        const pct = Number(coupon.percent||0);
        if(!pct) return 0;
        return Math.round((subtotal * pct)/100);
      }

      function validateCoupon(input){
        const s = state.settings;
        if(!s.coupon?.enabled) return null;
        const code = String(input||'').trim();
        if(!code) return null;
        if(code.toUpperCase() !== String(s.coupon.code||'').trim().toUpperCase()) return null;
        return { code: s.coupon.code, percent: Number(s.coupon.percent||10) || 10 };
      }

      function ensureCustomizerDefault(productId){
        const cartItem = cart.items.find(x=>x.productId===productId);
        const existing = cartItem?.custom;
        return {
          productId,
          text: existing?.text || '',
          color: existing?.color || '#ffffff',
          size: existing?.size || 42,
          bold: existing?.bold ?? true,
          italic: existing?.italic ?? false,
        };
      }

      function openCustomizer(productId, mode='add'){
        const p = productById(productId);
        if(!p) return;
        ui.customDraft = { ...ensureCustomizerDefault(productId), mode };
        $('#customSub').textContent = `${p.title} ‚Äî customize text & styling`;

        // set UI controls
        $('#customText').value = ui.customDraft.text;
        $('#customColor').value = ui.customDraft.color;
        $('#customSize').value = String(ui.customDraft.size);
        $('#customSizeVal').textContent = String(ui.customDraft.size);
        $('#customBold').checked = !!ui.customDraft.bold;
        $('#customItalic').checked = !!ui.customDraft.italic;

        renderCustomizerPreview();
        $('#customOverlay').classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
        setTimeout(()=>$('#customText')?.focus(), 0);
      }

      function closeCustomizer(){
        $('#customOverlay').classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
        ui.customDraft = null;
      }

      function renderCustomizerPreview(){
        const draft = ui.customDraft;
        if(!draft) return;
        const p = productById(draft.productId);
        if(!p) return;

        const bg = p.imageDataUrl
          ? `<img src="${p.imageDataUrl}" alt="${escapeHtml(p.title)}" class="absolute inset-0 h-full w-full object-cover" />`
          : `<div class="absolute inset-0" style="background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.10), transparent 60%), linear-gradient(135deg, rgba(255,255,255,.06), rgba(255,255,255,.02));"></div>
             <div class="absolute inset-0 opacity-60" style="background: radial-gradient(circle at 30% 30%, var(--accent), transparent 55%);"></div>
             <div class="absolute inset-0 flex items-center justify-center text-6xl">${escapeHtml(p.emoji||'üé®')}</div>`;

        const textSafe = escapeHtml(draft.text || '');
        const fontWeight = draft.bold ? 900 : 700;
        const fontStyle = draft.italic ? 'italic' : 'normal';

        $('#customPreview').innerHTML = `
          <div class="absolute inset-0">
            ${bg}
            <div class="absolute inset-0" style="background: linear-gradient(180deg, rgba(0,0,0,.10), rgba(0,0,0,.10));"></div>
            <div class="absolute inset-0 flex items-center justify-center p-6">
              <div class="text-center break-words" style="
                color: ${escapeHtml(draft.color)};
                font-size: ${Number(draft.size)||42}px;
                font-weight: ${fontWeight};
                font-style: ${fontStyle};
                text-shadow: 0 10px 24px rgba(0,0,0,.35);
                line-height: 1.05;
              ">${textSafe || '<span style="opacity:.55">Your text</span>'}</div>
            </div>
          </div>
        `;
      }

      function addToCart(productId, qty=1, custom=null){
        const p = productById(productId);
        if(!p) return;
        if(!p.inStock){ toast('This item is out of stock.', 'Out of stock'); return; }

        if(p.customizable && !custom){
          openCustomizer(productId, 'add');
          return;
        }

        const item = cart.items.find(i=>i.productId===productId);
        if(item){
          item.qty += qty;
          if(custom) item.custom = custom;
        } else {
          cart.items.push({ productId, qty, custom: custom || null });
        }
        saveCart();
        renderStoreHeaderBadge();
        toast('Added to cart', p.title);
      }

      function setCartCustom(productId, custom){
        const item = cart.items.find(i=>i.productId===productId);
        if(!item) return;
        item.custom = custom;
        saveCart();
        renderCart();
        renderCheckoutSummary();
        toast('Design updated', 'Customization');
      }

      function setQty(productId, qty){
        const item = cart.items.find(i=>i.productId===productId);
        if(!item) return;
        item.qty = Math.max(1, Math.min(99, Number(qty)||1));
        saveCart();
        renderCart();
        renderCheckoutSummary();
        renderStoreHeaderBadge();
      }

      function removeFromCart(productId){
        cart.items = cart.items.filter(i=>i.productId!==productId);
        saveCart();
        renderCart();
        renderCheckoutSummary();
        renderStoreHeaderBadge();
      }

      function clearCart(){
        cart.items = [];
        ui.couponApplied = null;
        saveCart();
        renderCart();
        renderCheckoutSummary();
        renderStoreHeaderBadge();
      }

      function openCart(){
        renderCart();
        $('#cartOverlay').classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
      }
      function closeCart(){
        $('#cartOverlay').classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
      }

      function openCheckout(){
        if(cart.items.length===0){ toast('Cart is empty.', 'Checkout'); return; }
        renderCheckoutSummary();
        $('#checkoutOverlay').classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
        $('#couponStatus').textContent = ui.couponApplied ? `Applied: ${ui.couponApplied.code} (${ui.couponApplied.percent}% off)` : '';
        $('#couponInput').value = ui.couponApplied?.code || '';
      }
      function closeCheckout(){
        $('#checkoutOverlay').classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
      }

      function waMessageForOrder(order){
        const s = state.settings;
        const lines = [];
        lines.push(`*${s.storeName} ‚Äî New Print Order*`);
        lines.push(`Order ID: *${order.id}*`);
        lines.push(`Date: ${new Date(order.createdAt).toLocaleString()}`);
        lines.push('');
        lines.push('*Customer*');
        lines.push(`Name: ${order.customer.name}`);
        lines.push(`Phone: ${order.customer.phone}`);
        lines.push(`City: ${order.customer.city}`);
        lines.push(`Address: ${order.customer.address}`);
        if(order.customer.deliveryNote) lines.push(`Delivery: ${order.customer.deliveryNote}`);
        if(order.customer.notes) lines.push(`Notes: ${order.customer.notes}`);
        lines.push('');
        lines.push('*Items*');
        (order.items||[]).forEach((it, idx)=>{
          lines.push(`${idx+1}) ${it.title} ‚Äî ${money(it.price)} x ${it.qty} = ${money(it.price*it.qty)}`);
          if(it.custom?.text){
            lines.push(`   ‚Ä¢ Print text: "${it.custom.text}"`);
            lines.push(`   ‚Ä¢ Style: ${it.custom.size}px, ${it.custom.color}${it.custom.bold?' bold':''}${it.custom.italic?' italic':''}`);
          }
        });
        lines.push('');
        lines.push(`Subtotal: ${money(order.subtotal)}`);
        if(order.coupon){
          lines.push(`Discount (${order.coupon.code} -${order.coupon.percent}%): -${money(order.discount)}`);
        }
        lines.push(`Total: *${money(order.total)}*`);
        lines.push('');
        lines.push('Please confirm print details & delivery time.');
        return lines.join('\n');
      }

      function openWhatsAppWithText(text){
        const wa = normalizeWaNumber(state.settings.whatsappNumber);
        const url = `https://wa.me/${wa}?text=${encodeURIComponent(text)}`;
        window.open(url, '_blank', 'noopener,noreferrer');
      }

      function placeOrder(form){
        const fd = new FormData(form);
        const customer = {
          name: String(fd.get('name')||'').trim(),
          phone: String(fd.get('phone')||'').trim(),
          city: String(fd.get('city')||'').trim(),
          address: String(fd.get('address')||'').trim(),
          deliveryNote: String(fd.get('deliveryNote')||'').trim(),
          notes: String(fd.get('notes')||'').trim(),
        };
        if(!customer.name || !customer.phone || !customer.city || !customer.address){
          toast('Please fill all required fields.', 'Checkout');
          return;
        }

        const items = cart.items.map(it=>{
          const p = productById(it.productId);
          return {
            productId: it.productId,
            title: p?.title || it.productId,
            price: Number(p?.price||0),
            qty: it.qty,
            custom: it.custom || null,
          };
        }).filter(it=>it.title);

        const subtotal = cartSubtotal();
        const applied = ui.couponApplied;
        const discount = calcDiscount(subtotal, applied);
        const total = Math.max(0, subtotal - discount);

        const order = {
          id: uid('WEX'),
          createdAt: Date.now(),
          status: 'Pending',
          customer,
          items,
          subtotal,
          discount,
          total,
          coupon: applied,
        };

        state.orders.unshift(order);
        saveState();

        const msg = waMessageForOrder(order);
        closeCheckout();
        clearCart();

        toast(`Order created: ${order.id}`, 'Success');
        openWhatsAppWithText(msg);

        if(location.hash==='#admin' && ui.adminAuthed){
          renderAdmin();
          wireAdminOrdersFilter();
        }
      }

      function renderStore(){
        const s = state.settings;
        const store = $('#storeApp');

        store.innerHTML = `
          <div id="home" class="relative">
            <div class="absolute inset-0 pointer-events-none">
              <div class="absolute -top-24 -left-24 h-72 w-72 rounded-full blur-3xl opacity-30" style="background: radial-gradient(circle at 30% 30%, var(--accent), transparent 60%);"></div>
              <div class="absolute -bottom-28 -right-24 h-80 w-80 rounded-full blur-3xl opacity-25" style="background: radial-gradient(circle at 30% 30%, var(--accent2), transparent 60%);"></div>
            </div>

            ${s.announcement ? `
              <div class="relative z-10 border-b border-soft bg-card2">
                <div class="mx-auto max-w-6xl px-4 py-2 text-sm text-muted flex items-center justify-between gap-3">
                  <div class="truncate">${escapeHtml(s.announcement)}</div>
                  <a class="text-accent hover:underline text-sm" href="#products">Shop now</a>
                </div>
              </div>
            `:''}

            <header class="relative z-10">
              <div class="mx-auto max-w-6xl px-4 py-4 flex items-center justify-between gap-3">
                <div class="flex items-center gap-3">
                  <a href="#home" class="flex items-center gap-3">
                    ${s.logoDataUrl ? `<img src="${s.logoDataUrl}" alt="logo" class="h-10 w-10 rounded-2xl object-cover border border-soft"/>` : `
                      <div class="h-10 w-10 rounded-2xl bg-accent text-white flex items-center justify-center font-black">WW</div>
                    `}
                    <div>
                      <div class="font-extrabold tracking-tight text-lg">${escapeHtml(s.storeName)}</div>
                      <div class="text-xs text-muted -mt-0.5">Print‚Äëon‚ÄëDemand ‚Ä¢ WhatsApp Orders</div>
                    </div>
                  </a>
                </div>

                <nav class="hidden md:flex items-center gap-2">
                  ${(s.headerLinks||[]).map(l=>`
                    <a class="px-3 py-2 rounded-xl hover:bg-card2 text-sm" href="${escapeHtml(l.href)}">${escapeHtml(l.label)}</a>
                  `).join('')}
                  <a class="px-3 py-2 rounded-xl hover:bg-card2 text-sm" href="#admin" title="Admin">Admin</a>
                </nav>

                <div class="flex items-center gap-2">
                  <button data-action="toggle-mode" class="hidden sm:inline-flex px-3 py-2 rounded-xl border border-soft hover:bg-card2 text-sm" title="Toggle light/dark">
                    <span class="text-muted">${s.mode==='light' ? 'Light' : 'Dark'}</span>
                  </button>
                  <button data-action="cart-open" class="relative px-4 py-2 rounded-2xl border border-soft hover:bg-card2">
                    <span class="font-semibold">Cart</span>
                    <span id="cartBadge" class="absolute -top-2 -right-2 h-6 min-w-6 px-2 rounded-full bg-accent text-white text-xs flex items-center justify-center">0</span>
                  </button>
                  <button class="md:hidden px-3 py-2 rounded-xl border border-soft hover:bg-card2" data-action="mobile-menu">‚ò∞</button>
                </div>
              </div>

              <div id="mobileMenu" class="md:hidden hidden border-t border-soft bg-surface">
                <div class="mx-auto max-w-6xl px-4 py-3 flex flex-col gap-2">
                  ${(s.headerLinks||[]).map(l=>`
                    <a class="px-3 py-2 rounded-xl hover:bg-card2 text-sm" href="${escapeHtml(l.href)}">${escapeHtml(l.label)}</a>
                  `).join('')}
                  <a class="px-3 py-2 rounded-xl hover:bg-card2 text-sm" href="#admin">Admin Dashboard</a>
                </div>
              </div>
            </header>

            <section class="relative z-10">
              <div class="mx-auto max-w-6xl px-4 pt-10 pb-8">
                <div class="grid lg:grid-cols-2 gap-8 items-center">
                  <div>
                    <div class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full border border-soft bg-card2 text-sm text-muted">
                      <span class="h-2 w-2 rounded-full bg-accent"></span>
                      Custom Print Text Enabled
                    </div>
                    <h1 class="mt-4 hero-title">${escapeHtml(s.heroTitle)}</h1>
                    <p class="mt-4 hero-subtitle">${escapeHtml(s.heroSubtitle)}</p>
                    <div class="mt-6 flex flex-col sm:flex-row gap-3">
                      <a href="#products" class="btn-accent rounded-2xl px-5 py-3 font-semibold inline-flex items-center justify-center">Browse Products</a>
                      <button data-action="open-whatsapp" class="rounded-2xl px-5 py-3 border border-soft hover:bg-card2 font-semibold inline-flex items-center justify-center">Chat on WhatsApp</button>
                    </div>
                    <div class="mt-6 grid grid-cols-3 gap-3">
                      <div class="glass rounded-2xl p-3">
                        <div class="text-sm text-muted">Coupon</div>
                        <div class="font-bold">${s.coupon?.enabled ? (escapeHtml(s.coupon.code) + ` (-${Number(s.coupon.percent||10)}%)`) : 'Disabled'}</div>
                      </div>
                      <div class="glass rounded-2xl p-3">
                        <div class="text-sm text-muted">Print</div>
                        <div class="font-bold">Text Styling</div>
                      </div>
                      <div class="glass rounded-2xl p-3">
                        <div class="text-sm text-muted">Admin</div>
                        <div class="font-bold">Password</div>
                      </div>
                    </div>
                  </div>

                  <div class="relative">
                    <div class="glass rounded-3xl p-4 border border-soft shadow-soft">
                      <div class="flex items-center justify-between">
                        <div>
                          <div class="font-bold">Featured</div>
                          <div class="text-sm text-muted">Popular picks from ${escapeHtml(s.storeName)}</div>
                        </div>
                        <span class="text-xs px-2 py-1 rounded-full border border-soft text-muted">Live preview</span>
                      </div>
                      <div class="mt-4 grid grid-cols-2 gap-3">
                        ${state.products.slice(0,4).map(p=>featuredCard(p)).join('')}
                      </div>
                    </div>
                    <div class="absolute -z-10 -bottom-10 -left-10 h-40 w-40 blur-3xl opacity-30" style="background: radial-gradient(circle at 30% 30%, var(--accent), transparent 60%);"></div>
                  </div>
                </div>
              </div>
            </section>
          </div>

          <section id="products" class="relative">
            <div class="mx-auto max-w-6xl px-4 py-10">
              <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3">
                <div>
                  <div class="text-sm text-muted">Print Shop</div>
                  <h2 class="text-2xl sm:text-3xl font-extrabold">Products</h2>
                </div>
                <div class="flex gap-2">
                  <div class="relative">
                    <input id="productSearch" class="w-full sm:w-72 rounded-2xl bg-card2 border border-soft px-4 py-3 focus-ring" placeholder="Search products..." />
                  </div>
                  <button data-action="refresh-store" class="px-4 py-3 rounded-2xl border border-soft hover:bg-card2">Refresh</button>
                </div>
              </div>

              <div id="productGrid" class="mt-6 grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
                ${state.products.map(p=>productCard(p)).join('')}
              </div>
            </div>
          </section>

          <section id="how" class="relative">
            <div class="mx-auto max-w-6xl px-4 py-10">
              <div class="glass rounded-3xl p-6 border border-soft">
                <div class="grid md:grid-cols-3 gap-4">
                  <div class="p-4 rounded-2xl bg-card2 border border-soft">
                    <div class="font-bold">1) Customize</div>
                    <div class="text-sm text-muted mt-1">Apna text likhein, color/size/bold/italic select karein.</div>
                  </div>
                  <div class="p-4 rounded-2xl bg-card2 border border-soft">
                    <div class="font-bold">2) Add to cart</div>
                    <div class="text-sm text-muted mt-1">Cart banayein aur coupon (optional) apply karein.</div>
                  </div>
                  <div class="p-4 rounded-2xl bg-card2 border border-soft">
                    <div class="font-bold">3) WhatsApp order</div>
                    <div class="text-sm text-muted mt-1">Checkout par click karte hi order WhatsApp me open hojayega.</div>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <footer id="footer" class="border-t border-soft">
            <div class="mx-auto max-w-6xl px-4 py-10">
              <div class="grid md:grid-cols-3 gap-6">
                <div>
                  <div class="font-extrabold text-xl">${escapeHtml(s.storeName)}</div>
                  <div class="text-sm text-muted mt-2">Order direct WhatsApp: <span class="text-accent">+${escapeHtml(s.whatsappNumber)}</span></div>
                  <div class="mt-4 flex gap-2">
                    <button data-action="open-whatsapp" class="px-4 py-2 rounded-2xl btn-accent font-semibold">WhatsApp</button>
                    <a href="#admin" class="px-4 py-2 rounded-2xl border border-soft hover:bg-card2 font-semibold">Admin</a>
                  </div>
                </div>
                <div>
                  <div class="font-semibold">Links</div>
                  <div class="mt-3 flex flex-col gap-2">
                    ${(s.footerLinks||[]).map(l=>`<a class="text-sm text-muted hover:text-accent" href="${escapeHtml(l.href)}">${escapeHtml(l.label)}</a>`).join('')}
                  </div>
                </div>
                <div>
                  <div class="font-semibold">Trust</div>
                  <div class="mt-3 grid grid-cols-2 gap-2">
                    <div class="p-3 rounded-2xl bg-card2 border border-soft text-sm text-muted">Custom Print</div>
                    <div class="p-3 rounded-2xl bg-card2 border border-soft text-sm text-muted">Quality Material</div>
                    <div class="p-3 rounded-2xl bg-card2 border border-soft text-sm text-muted">Fast Dispatch</div>
                    <div class="p-3 rounded-2xl bg-card2 border border-soft text-sm text-muted">Support</div>
                  </div>
                </div>
              </div>
              <div class="mt-8 pt-6 border-t border-soft text-sm text-muted flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
                <div>${escapeHtml(s.footerText)}</div>
                <div class="flex items-center gap-2">
                  <button data-action="reset-demo" class="px-3 py-2 rounded-xl border border-soft hover:bg-card2">Reset demo</button>
                  <button data-action="toggle-mode" class="px-3 py-2 rounded-xl border border-soft hover:bg-card2">Toggle mode</button>
                </div>
              </div>
            </div>
          </footer>

          ${s.showFloatingWhatsApp ? `
            <button data-action="open-whatsapp" class="fixed z-[70] bottom-5 right-5 btn-accent shadow-soft rounded-full px-4 py-3 font-semibold">
              WhatsApp
            </button>
          `:''}
        `;

        renderStoreHeaderBadge();
      }

      function featuredCard(p){
        const img = productImage(p, true);
        const btnLabel = p.customizable ? 'Customize' : 'Add';
        const btnAction = p.customizable ? 'customize' : 'add';
        return `
          <div class="rounded-2xl border border-soft bg-card2 overflow-hidden">
            ${img}
            <div class="p-3">
              <div class="font-semibold text-sm line-clamp-1">${escapeHtml(p.title)}</div>
              <div class="mt-1 flex items-center justify-between">
                <div class="font-extrabold">${money(p.price)}</div>
                <button data-action="${btnAction}" data-id="${escapeHtml(p.id)}" class="px-3 py-2 rounded-xl btn-accent text-sm font-semibold">${btnLabel}</button>
              </div>
            </div>
          </div>
        `;
      }

      function productImage(p, compact=false){
        if(p.imageDataUrl){
          return `<div class="${compact?'h-24':'h-44'} w-full bg-card2"><img class="h-full w-full object-cover" src="${p.imageDataUrl}" alt="${escapeHtml(p.title)}" /></div>`;
        }
        const em = escapeHtml(p.emoji || 'üõçÔ∏è');
        return `
          <div class="${compact?'h-24':'h-44'} w-full relative overflow-hidden" style="background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.12), transparent 60%), linear-gradient(135deg, rgba(255,255,255,.06), rgba(255,255,255,.02));">
            <div class="absolute inset-0 opacity-60" style="background: radial-gradient(circle at 30% 30%, var(--accent), transparent 55%);"></div>
            <div class="absolute inset-0 flex items-center justify-center text-4xl">${em}</div>
          </div>
        `;
      }

      function productCard(p){
        const badge = p.badge ? `<span class="absolute top-3 left-3 text-xs px-2 py-1 rounded-full bg-surface border border-soft">${escapeHtml(p.badge)}</span>` : '';
        const stock = p.inStock ? `<span class="text-xs px-2 py-1 rounded-full border border-soft text-muted">In stock</span>` : `<span class="text-xs px-2 py-1 rounded-full border border-soft text-muted">Out of stock</span>`;
        const compare = p.compareAt && p.compareAt > p.price ? `<span class="text-sm text-muted line-through">${money(p.compareAt)}</span>` : '';

        const primaryLabel = p.customizable ? 'Customize' : 'Add';
        const primaryAction = p.customizable ? 'customize' : 'add';

        return `
          <div class="group rounded-3xl border border-soft bg-card overflow-hidden shadow-soft">
            <div class="relative">
              ${productImage(p)}
              ${badge}
              ${p.customizable ? `<span class="absolute bottom-3 left-3 text-xs px-2 py-1 rounded-full bg-surface border border-soft">Custom text</span>` : ''}
            </div>
            <div class="p-4">
              <div>
                <div class="font-bold text-lg leading-snug">${escapeHtml(p.title)}</div>
                <div class="mt-1 text-sm text-muted line-clamp-2">${escapeHtml(p.description||'')}</div>
              </div>

              <div class="mt-4 flex items-center justify-between">
                <div>
                  <div class="font-extrabold text-xl">${money(p.price)}</div>
                  <div class="mt-1 flex items-center gap-2">${compare}${stock}</div>
                </div>
                <div class="flex flex-col gap-2">
                  <button data-action="${primaryAction}" data-id="${escapeHtml(p.id)}" class="px-4 py-2.5 rounded-2xl btn-accent font-semibold disabled:opacity-50" ${p.inStock? '' : 'disabled'}>
                    ${primaryLabel}
                  </button>
                  <button data-action="buy-wa" data-id="${escapeHtml(p.id)}" class="px-4 py-2.5 rounded-2xl border border-soft hover:bg-card2 font-semibold">
                    WhatsApp
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      function renderStoreHeaderBadge(){
        const el = $('#cartBadge');
        if(!el) return;
        el.textContent = String(cartCount());
        el.style.display = cartCount() ? 'flex' : 'none';
      }

      function renderCart(){
        const root = $('#cartItems');
        if(!root) return;
        if(cart.items.length===0){
          root.innerHTML = `
            <div class="p-6 rounded-3xl border border-soft bg-card2 text-center">
              <div class="text-4xl">üõí</div>
              <div class="mt-2 font-bold">Cart is empty</div>
              <div class="mt-1 text-sm text-muted">Customize a product to continue.</div>
              <button data-action="cart-close" class="mt-4 px-4 py-3 rounded-2xl border border-soft hover:bg-card2">Browse products</button>
            </div>
          `;
          $('#cartSubtotal').textContent = money(0);
          return;
        }

        root.innerHTML = cart.items.map(it=>{
          const p = productById(it.productId);
          if(!p) return '';

          const customLine = it.custom?.text ? `
            <div class="mt-1 text-xs text-muted">Print: <span class="text-accent font-semibold">${escapeHtml(it.custom.text)}</span> ‚Ä¢ ${escapeHtml(it.custom.color)} ‚Ä¢ ${it.custom.size}px${it.custom.bold?' ‚Ä¢ bold':''}${it.custom.italic?' ‚Ä¢ italic':''}</div>
          ` : (p.customizable ? `<div class="mt-1 text-xs text-muted">No custom text set</div>` : '');

          return `
            <div class="flex gap-3 p-3 rounded-2xl border border-soft bg-card2">
              <div class="h-16 w-16 rounded-2xl overflow-hidden border border-soft shrink-0">
                ${p.imageDataUrl ? `<img src="${p.imageDataUrl}" class="h-full w-full object-cover" alt="${escapeHtml(p.title)}"/>` : `<div class="h-full w-full flex items-center justify-center" style="background: radial-gradient(circle at 30% 30%, var(--accent), transparent 65%), linear-gradient(135deg, rgba(255,255,255,.06), rgba(255,255,255,.02));">${escapeHtml(p.emoji||'üõçÔ∏è')}</div>`}
              </div>
              <div class="flex-1">
                <div class="flex items-start justify-between gap-2">
                  <div>
                    <div class="font-semibold">${escapeHtml(p.title)}</div>
                    <div class="text-sm text-muted">${money(p.price)}</div>
                    ${customLine}
                  </div>
                  <button data-action="remove" data-id="${escapeHtml(p.id)}" class="px-3 py-1.5 rounded-xl border border-soft hover:bg-card">Remove</button>
                </div>

                <div class="mt-3 flex items-center justify-between">
                  <div class="flex items-center gap-2">
                    <div class="inline-flex items-center gap-2 rounded-2xl border border-soft bg-card px-2 py-1">
                      <button data-action="qty" data-id="${escapeHtml(p.id)}" data-delta="-1" class="h-8 w-8 rounded-xl hover:bg-card2">‚àí</button>
                      <span class="min-w-8 text-center font-semibold">${it.qty}</span>
                      <button data-action="qty" data-id="${escapeHtml(p.id)}" data-delta="1" class="h-8 w-8 rounded-xl hover:bg-card2">+</button>
                    </div>
                    ${p.customizable ? `<button data-action="customize-edit" data-id="${escapeHtml(p.id)}" class="px-3 py-2 rounded-xl border border-soft hover:bg-card">Customize</button>` : ''}
                  </div>
                  <div class="font-extrabold">${money(p.price*it.qty)}</div>
                </div>
              </div>
            </div>
          `;
        }).join('');

        $('#cartSubtotal').textContent = money(cartSubtotal());
      }

      function renderCheckoutSummary(){
        const sumRoot = $('#checkoutSummary');
        if(!sumRoot) return;

        const itemsHtml = cart.items.map(it=>{
          const p = productById(it.productId);
          if(!p) return '';
          const custom = it.custom?.text ? `<div class="text-xs text-muted mt-0.5">Print: <span class="text-accent font-semibold">${escapeHtml(it.custom.text)}</span> ‚Ä¢ ${escapeHtml(it.custom.color)} ‚Ä¢ ${it.custom.size}px${it.custom.bold?' ‚Ä¢ bold':''}${it.custom.italic?' ‚Ä¢ italic':''}</div>` : '';
          return `
            <div class="p-3 rounded-2xl border border-soft bg-card2">
              <div class="flex items-start justify-between gap-3">
                <div class="flex items-center gap-3 min-w-0">
                  <div class="h-12 w-12 rounded-2xl overflow-hidden border border-soft shrink-0">
                    ${p.imageDataUrl ? `<img src="${p.imageDataUrl}" class="h-full w-full object-cover" alt="${escapeHtml(p.title)}"/>` : `<div class="h-full w-full flex items-center justify-center" style="background: radial-gradient(circle at 30% 30%, var(--accent), transparent 65%), linear-gradient(135deg, rgba(255,255,255,.06), rgba(255,255,255,.02));">${escapeHtml(p.emoji||'üõçÔ∏è')}</div>`}
                  </div>
                  <div class="min-w-0">
                    <div class="font-semibold truncate">${escapeHtml(p.title)}</div>
                    <div class="text-sm text-muted">${money(p.price)} √ó ${it.qty}</div>
                    ${custom}
                  </div>
                </div>
                <div class="font-extrabold">${money(p.price*it.qty)}</div>
              </div>
            </div>
          `;
        }).join('');

        sumRoot.innerHTML = itemsHtml || '<div class="text-sm text-muted">No items</div>';

        const subtotal = cartSubtotal();
        const discount = calcDiscount(subtotal, ui.couponApplied);
        const total = Math.max(0, subtotal - discount);

        $('#sumSubtotal').textContent = money(subtotal);
        $('#sumDiscount').textContent = `- ${money(discount)}`;
        $('#sumTotal').textContent = money(total);
      }

      // ---------- ADMIN GATE (LOGIN/SETUP) ----------
      function renderAdminLogin(){
        const s = state.settings;
        const root = $('#adminApp');
        root.innerHTML = `
          <div class="min-h-screen flex items-center justify-center p-4">
            <div class="w-full max-w-lg bg-surface border border-soft shadow-soft rounded-3xl overflow-hidden">
              <div class="p-6 border-b border-soft">
                <div class="flex items-center gap-3">
                  ${s.logoDataUrl ? `<img src="${s.logoDataUrl}" alt="logo" class="h-11 w-11 rounded-2xl object-cover border border-soft"/>` : `<div class="h-11 w-11 rounded-2xl bg-accent text-white flex items-center justify-center font-black">WW</div>`}
                  <div>
                    <div class="text-xl font-extrabold">Admin Login</div>
                    <div class="text-sm text-muted">${escapeHtml(s.storeName)} ‚Ä¢ Password protected</div>
                  </div>
                </div>
              </div>
              <div class="p-6">
                <form data-form="admin-login" class="space-y-4">
                  <div>
                    <label class="text-sm text-muted">Password</label>
                    <input required type="password" name="password" class="mt-1 w-full rounded-2xl bg-card2 border border-soft px-4 py-3 focus-ring" placeholder="Enter admin password" />
                  </div>
                  <button class="w-full btn-accent rounded-2xl px-4 py-3 font-semibold">Login</button>
                  <a href="#home" class="block text-center text-sm text-muted hover:text-accent">‚Üê Back to Store</a>
                </form>
                <div class="mt-4 text-xs text-muted">
                  Note: This is a client-side demo lock (localStorage). For real security, backend auth is required.
                </div>
              </div>
            </div>
          </div>
        `;
      }

      function renderAdminSetup(){
        const s = state.settings;
        const root = $('#adminApp');
        root.innerHTML = `
          <div class="min-h-screen flex items-center justify-center p-4">
            <div class="w-full max-w-lg bg-surface border border-soft shadow-soft rounded-3xl overflow-hidden">
              <div class="p-6 border-b border-soft">
                <div class="flex items-center gap-3">
                  ${s.logoDataUrl ? `<img src="${s.logoDataUrl}" alt="logo" class="h-11 w-11 rounded-2xl object-cover border border-soft"/>` : `<div class="h-11 w-11 rounded-2xl bg-accent text-white flex items-center justify-center font-black">WW</div>`}
                  <div>
                    <div class="text-xl font-extrabold">Setup Admin Password</div>
                    <div class="text-sm text-muted">First time security setup for ${escapeHtml(s.storeName)}</div>
                  </div>
                </div>
              </div>
              <div class="p-6">
                <form data-form="admin-setup" class="space-y-4">
                  <div>
                    <label class="text-sm text-muted">New password</label>
                    <input required type="password" name="newPassword" class="mt-1 w-full rounded-2xl bg-card2 border border-soft px-4 py-3 focus-ring" placeholder="Set a strong password" />
                  </div>
                  <div>
                    <label class="text-sm text-muted">Confirm password</label>
                    <input required type="password" name="confirmPassword" class="mt-1 w-full rounded-2xl bg-card2 border border-soft px-4 py-3 focus-ring" placeholder="Re-enter password" />
                  </div>
                  <button class="w-full btn-accent rounded-2xl px-4 py-3 font-semibold">Save & Continue</button>
                  <a href="#home" class="block text-center text-sm text-muted hover:text-accent">‚Üê Back to Store</a>
                </form>
                <div class="mt-4 text-xs text-muted">
                  Note: This password is stored locally in your browser (hashed). For real security + multi-user access, backend auth is required.
                </div>
              </div>
            </div>
          </div>
        `;
      }

      function renderAdminGate(){
        const hasPw = !!state.settings.security?.passwordHash;
        if(!hasPw) return renderAdminSetup();
        if(!ui.adminAuthed) return renderAdminLogin();
        renderAdmin();
      }

      // ---------- ADMIN ----------
      function renderAdmin(){
        const s = state.settings;
        const root = $('#adminApp');

        const stats = orderStats();

        root.innerHTML = `
          <div class="min-h-screen">
            <div class="border-b border-soft bg-surface">
              <div class="mx-auto max-w-7xl px-4 py-4 flex items-center justify-between gap-3">
                <div class="flex items-center gap-3">
                  ${s.logoDataUrl ? `<img src="${s.logoDataUrl}" alt="logo" class="h-10 w-10 rounded-2xl object-cover border border-soft"/>` : `<div class="h-10 w-10 rounded-2xl bg-accent text-white flex items-center justify-center font-black">WW</div>`}
                  <div>
                    <div class="font-extrabold text-lg">Admin Dashboard</div>
                    <div class="text-sm text-muted">${escapeHtml(s.storeName)} ‚Ä¢ localStorage</div>
                  </div>
                </div>
                <div class="flex items-center gap-2">
                  <button data-action="toggle-mode" class="px-3 py-2 rounded-xl border border-soft hover:bg-card2">Toggle mode</button>
                  <button data-action="admin-logout" class="px-3 py-2 rounded-xl border border-soft hover:bg-card2">Logout</button>
                  <a href="#home" class="px-4 py-2 rounded-2xl btn-accent font-semibold">‚Üê Back to Store</a>
                </div>
              </div>
            </div>

            <div class="mx-auto max-w-7xl px-4 py-6 grid lg:grid-cols-[260px_1fr] gap-4">
              <aside class="bg-surface border border-soft rounded-3xl p-3 h-fit lg:sticky lg:top-4">
                <div class="px-3 py-2 text-xs text-muted">MENU</div>
                ${adminNavItem('dashboard','Dashboard')}
                ${adminNavItem('products','Products')}
                ${adminNavItem('orders','Orders')}
                ${adminNavItem('header','Header & Footer')}
                ${adminNavItem('theme','Theme')}
                ${adminNavItem('design','Design & Typography')}
                ${adminNavItem('coupon','Coupon')}
                ${adminNavItem('security','Security')}
                ${adminNavItem('data','Backup / Reset')}

                <div class="mt-3 p-3 rounded-2xl bg-card2 border border-soft">
                  <div class="text-sm text-muted">Quick stats</div>
                  <div class="mt-1 font-extrabold">${stats.total} Orders</div>
                  <div class="mt-1 text-sm text-muted">Pending: ${stats.pending} ‚Ä¢ Delivered: ${stats.delivered}</div>
                </div>
              </aside>

              <main class="space-y-4">
                ${renderAdminPanel()}
              </main>
            </div>
          </div>
        `;
      }

      function adminNavItem(key, label){
        const active = ui.adminTab === key;
        return `
          <button data-action="admin-tab" data-tab="${key}" class="w-full flex items-center justify-between px-3 py-2.5 rounded-2xl ${active ? 'bg-card2 border border-soft' : 'hover:bg-card2'}">
            <span class="font-semibold">${label}</span>
            <span class="text-xs text-muted">‚Üí</span>
          </button>
        `;
      }

      function orderStats(){
        const orders = state.orders || [];
        const stats = { total: orders.length, pending:0, delivered:0, cancelled:0, revenueDelivered:0, revenueAll:0 };
        for(const o of orders){
          const st = String(o.status||'Pending');
          if(st==='Delivered') { stats.delivered++; stats.revenueDelivered += Number(o.total||0); }
          else if(st==='Cancelled') stats.cancelled++;
          else stats.pending++;
          stats.revenueAll += Number(o.total||0);
        }
        return stats;
      }

      function renderAdminPanel(){
        switch(ui.adminTab){
          case 'products': return adminProductsPanel();
          case 'orders': return adminOrdersPanel();
          case 'header': return adminHeaderFooterPanel();
          case 'theme': return adminThemePanel();
          case 'design': return adminDesignPanel();
          case 'coupon': return adminCouponPanel();
          case 'security': return adminSecurityPanel();
          case 'data': return adminDataPanel();
          default: return adminDashboardPanel();
        }
      }

      function adminDashboardPanel(){
        const stats = orderStats();
        return `
          <section class="grid md:grid-cols-2 lg:grid-cols-4 gap-4">
            ${statCard('Total Orders', stats.total)}
            ${statCard('Pending', stats.pending)}
            ${statCard('Delivered', stats.delivered)}
            ${statCard('Delivered Revenue', money(stats.revenueDelivered))}
          </section>

          <section class="bg-surface border border-soft rounded-3xl p-5">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="text-xl font-extrabold">Quick Actions</div>
                <div class="text-sm text-muted">Manage products, coupon, theme, background, and typography.</div>
              </div>
              <div class="flex gap-2">
                <button data-action="admin-tab" data-tab="products" class="px-4 py-2 rounded-2xl btn-accent font-semibold">Manage Products</button>
                <button data-action="admin-tab" data-tab="orders" class="px-4 py-2 rounded-2xl border border-soft hover:bg-card2 font-semibold">View Orders</button>
              </div>
            </div>
            <div class="mt-4 grid md:grid-cols-2 gap-4">
              <div class="p-4 rounded-2xl bg-card2 border border-soft">
                <div class="font-semibold">WhatsApp number</div>
                <div class="text-sm text-muted mt-1">+${escapeHtml(state.settings.whatsappNumber)}</div>
                <button data-action="admin-tab" data-tab="header" class="mt-3 px-4 py-2 rounded-2xl border border-soft hover:bg-card font-semibold">Edit store settings</button>
              </div>
              <div class="p-4 rounded-2xl bg-card2 border border-soft">
                <div class="font-semibold">Coupon</div>
                <div class="text-sm text-muted mt-1">${state.settings.coupon?.enabled ? `Code: ${escapeHtml(state.settings.coupon.code)} (${Number(state.settings.coupon.percent||10)}% off)` : 'Disabled'}</div>
                <button data-action="admin-tab" data-tab="coupon" class="mt-3 px-4 py-2 rounded-2xl border border-soft hover:bg-card font-semibold">Change coupon</button>
              </div>
            </div>

            <div class="mt-4 p-4 rounded-2xl bg-card2 border border-soft text-sm text-muted">
              <b>Note:</b> Admin portal password lock is client-side (localStorage). Production use ke liye backend auth recommended hai.
            </div>
          </section>
        `;
      }

      function statCard(label, value){
        return `
          <div class="bg-surface border border-soft rounded-3xl p-5">
            <div class="text-sm text-muted">${escapeHtml(label)}</div>
            <div class="mt-2 text-2xl font-extrabold">${escapeHtml(value)}</div>
          </div>
        `;
      }

      function adminProductsPanel(){
        const editing = ui.editingProductId ? productById(ui.editingProductId) : null;
        return `
          <section class="bg-surface border border-soft rounded-3xl p-5">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="text-xl font-extrabold">Products</div>
                <div class="text-sm text-muted">Direct image upload supported (no URL needed). Mark products as customizable for print text.</div>
              </div>
              <button data-action="product-add-toggle" class="px-4 py-2 rounded-2xl btn-accent font-semibold">Add product</button>
            </div>

            <div id="addProductBox" class="mt-4 ${ui._showAddProduct ? '' : 'hidden'}">
              <div class="p-4 rounded-2xl bg-card2 border border-soft">
                <form data-form="add-product" class="grid md:grid-cols-2 gap-4">
                  <div class="space-y-3">
                    <div>
                      <label class="text-sm text-muted">Title</label>
                      <input required name="title" class="mt-1 w-full rounded-2xl bg-surface border border-soft px-4 py-3 focus-ring" placeholder="Product name" />
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                      <div>
                        <label class="text-sm text-muted">Price (Rs)</label>
                        <input required name="price" type="number" class="mt-1 w-full rounded-2xl bg-surface border border-soft px-4 py-3 focus-ring" placeholder="1299" />
                      </div>
                      <div>
                        <label class="text-sm text-muted">Compare at (optional)</label>
                        <input name="compareAt" type="number" class="mt-1 w-full rounded-2xl bg-surface border border-soft px-4 py-3 focus-ring" placeholder="1599" />
                      </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                      <div>
                        <label class="text-sm text-muted">Badge (optional)</label>
                        <input name="badge" class="mt-1 w-full rounded-2xl bg-surface border border-soft px-4 py-3 focus-ring" placeholder="Best Seller" />
                      </div>
                      <div>
                        <label class="text-sm text-muted">Emoji (optional)</label>
                        <input name="emoji" class="mt-1 w-full rounded-2xl bg-surface border border-soft px-4 py-3 focus-ring" placeholder="üëï" />
                      </div>
                    </div>
                    <div class="flex flex-col gap-2">
                      <label class="inline-flex items-center gap-2 text-sm text-muted">
                        <input name="inStock" type="checkbox" checked /> In stock
                      </label>
                      <label class="inline-flex items-center gap-2 text-sm text-muted">
                        <input name="customizable" type="checkbox" checked /> Print text customizable
                      </label>
                    </div>
                    <div>
                      <label class="text-sm text-muted">Description</label>
                      <textarea name="description" rows="3" class="mt-1 w-full rounded-2xl bg-surface border border-soft px-4 py-3 focus-ring" placeholder="Short description"></textarea>
                    </div>
                  </div>
                  <div class="space-y-3">
                    <div>
                      <label class="text-sm text-muted">Product Image (Upload)</label>
                      <input id="addProductImage" type="file" accept="image/*" class="mt-2 w-full" />
                      <div class="mt-3 rounded-2xl border border-soft bg-surface overflow-hidden">
                        ${ui.addImageDraft ? `<img src="${ui.addImageDraft}" class="h-44 w-full object-cover" alt="preview"/>` : `<div class="h-44 flex items-center justify-center text-muted">No image selected</div>`}
                      </div>
                      <div class="mt-2 text-xs text-muted">Image will be saved in browser storage.</div>
                    </div>
                    <button class="w-full btn-accent rounded-2xl px-4 py-3 font-semibold">Save product</button>
                    <button type="button" data-action="product-add-cancel" class="w-full rounded-2xl px-4 py-3 border border-soft hover:bg-card">Cancel</button>
                  </div>
                </form>
              </div>
            </div>

            ${editing ? `
              <div class="mt-4">
                <div class="p-4 rounded-2xl bg-card2 border border-soft">
                  <div class="flex items-start justify-between gap-3">
                    <div>
                      <div class="font-extrabold">Edit: ${escapeHtml(editing.title)}</div>
                      <div class="text-sm text-muted">Update product & image</div>
                    </div>
                    <button data-action="product-edit-cancel" class="px-3 py-2 rounded-xl border border-soft hover:bg-card">Close</button>
                  </div>

                  <form data-form="edit-product" data-id="${escapeHtml(editing.id)}" class="mt-4 grid md:grid-cols-2 gap-4">
                    <div class="space-y-3">
                      <div>
                        <label class="text-sm text-muted">Title</label>
                        <input required name="title" value="${escapeHtml(editing.title)}" class="mt-1 w-full rounded-2xl bg-surface border border-soft px-4 py-3 focus-ring" />
                      </div>
                      <div class="grid grid-cols-2 gap-3">
                        <div>
                          <label class="text-sm text-muted">Price (Rs)</label>
                          <input required name="price" type="number" value="${escapeHtml(editing.price)}" class="mt-1 w-full rounded-2xl bg-surface border border-soft px-4 py-3 focus-ring" />
                        </div>
                        <div>
                          <label class="text-sm text-muted">Compare at</label>
                          <input name="compareAt" type="number" value="${escapeHtml(editing.compareAt||'')}" class="mt-1 w-full rounded-2xl bg-surface border border-soft px-4 py-3 focus-ring" />
                        </div>
                      </div>
                      <div class="grid grid-cols-2 gap-3">
                        <div>
                          <label class="text-sm text-muted">Badge</label>
                          <input name="badge" value="${escapeHtml(editing.badge||'')}" class="mt-1 w-full rounded-2xl bg-surface border border-soft px-4 py-3 focus-ring" />
                        </div>
                        <div>
                          <label class="text-sm text-muted">Emoji</label>
                          <input name="emoji" value="${escapeHtml(editing.emoji||'')}" class="mt-1 w-full rounded-2xl bg-surface border border-soft px-4 py-3 focus-ring" />
                        </div>
                      </div>
                      <div class="flex flex-col gap-2">
                        <label class="inline-flex items-center gap-2 text-sm text-muted">
                          <input name="inStock" type="checkbox" ${editing.inStock ? 'checked' : ''} /> In stock
                        </label>
                        <label class="inline-flex items-center gap-2 text-sm text-muted">
                          <input name="customizable" type="checkbox" ${editing.customizable ? 'checked' : ''} /> Print text customizable
                        </label>
                      </div>
                      <div>
                        <label class="text-sm text-muted">Description</label>
                        <textarea name="description" rows="3" class="mt-1 w-full rounded-2xl bg-surface border border-soft px-4 py-3 focus-ring">${escapeHtml(editing.description||'')}</textarea>
                      </div>
                    </div>
                    <div class="space-y-3">
                      <div>
                        <label class="text-sm text-muted">Replace Image (Upload)</label>
                        <input id="editProductImage" type="file" accept="image/*" class="mt-2 w-full" />
                        <div class="mt-3 rounded-2xl border border-soft bg-surface overflow-hidden">
                          ${(ui.editImageDraft || editing.imageDataUrl) ? `<img src="${ui.editImageDraft || editing.imageDataUrl}" class="h-44 w-full object-cover" alt="preview"/>` : `<div class="h-44 flex items-center justify-center text-muted">No image</div>`}
                        </div>
                      </div>
                      <button class="w-full btn-accent rounded-2xl px-4 py-3 font-semibold">Save changes</button>
                      <button type="button" data-action="product-delete" data-id="${escapeHtml(editing.id)}" class="w-full rounded-2xl px-4 py-3 border border-soft hover:bg-card">Delete product</button>
                    </div>
                  </form>
                </div>
              </div>
            `:''}

            <div class="mt-5 overflow-x-auto">
              <table class="w-full text-sm">
                <thead>
                  <tr class="text-left text-muted">
                    <th class="py-2">Product</th>
                    <th class="py-2">Price</th>
                    <th class="py-2">Custom</th>
                    <th class="py-2">Stock</th>
                    <th class="py-2">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  ${state.products.map(p=>`
                    <tr class="border-t border-soft">
                      <td class="py-3">
                        <div class="flex items-center gap-3">
                          <div class="h-10 w-10 rounded-2xl overflow-hidden border border-soft bg-card2 shrink-0">
                            ${p.imageDataUrl ? `<img src="${p.imageDataUrl}" class="h-full w-full object-cover" alt="${escapeHtml(p.title)}"/>` : `<div class="h-full w-full flex items-center justify-center">${escapeHtml(p.emoji||'üõçÔ∏è')}</div>`}
                          </div>
                          <div>
                            <div class="font-semibold">${escapeHtml(p.title)}</div>
                            <div class="text-xs text-muted">ID: ${escapeHtml(p.id)}</div>
                          </div>
                        </div>
                      </td>
                      <td class="py-3 font-semibold">${money(p.price)}</td>
                      <td class="py-3"><span class="px-2 py-1 rounded-full border border-soft ${p.customizable ? '' : 'opacity-60'}">${p.customizable ? 'Yes' : 'No'}</span></td>
                      <td class="py-3"><span class="px-2 py-1 rounded-full border border-soft ${p.inStock ? '' : 'opacity-60'}">${p.inStock ? 'In stock' : 'Out'}</span></td>
                      <td class="py-3">
                        <div class="flex gap-2">
                          <button data-action="product-edit" data-id="${escapeHtml(p.id)}" class="px-3 py-2 rounded-xl border border-soft hover:bg-card2">Edit</button>
                          <button data-action="product-duplicate" data-id="${escapeHtml(p.id)}" class="px-3 py-2 rounded-xl border border-soft hover:bg-card2">Duplicate</button>
                        </div>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </section>
        `;
      }

      function adminOrdersPanel(){
        const stats = orderStats();
        const orders = state.orders || [];
        return `
          <section class="grid md:grid-cols-4 gap-4">
            ${statCard('Total', stats.total)}
            ${statCard('Pending', stats.pending)}
            ${statCard('Delivered', stats.delivered)}
            ${statCard('Cancelled', stats.cancelled)}
          </section>

          <section class="bg-surface border border-soft rounded-3xl p-5">
            <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-3">
              <div>
                <div class="text-xl font-extrabold">Orders</div>
                <div class="text-sm text-muted">View, mark delivered, and open WhatsApp message.</div>
              </div>
              <div class="flex flex-col sm:flex-row gap-2">
                <input id="adminOrderSearch" class="rounded-2xl bg-card2 border border-soft px-4 py-3 focus-ring" placeholder="Search by ID / name / phone" />
                <select id="adminOrderFilter" class="rounded-2xl bg-card2 border border-soft px-4 py-3 focus-ring">
                  <option value="">All</option>
                  <option value="Pending">Pending</option>
                  <option value="Delivered">Delivered</option>
                  <option value="Cancelled">Cancelled</option>
                </select>
                <button data-action="orders-export" class="px-4 py-3 rounded-2xl border border-soft hover:bg-card2">Export CSV</button>
              </div>
            </div>

            <div class="mt-4 overflow-x-auto">
              <table class="w-full text-sm">
                <thead>
                  <tr class="text-left text-muted">
                    <th class="py-2">Order</th>
                    <th class="py-2">Customer</th>
                    <th class="py-2">Total</th>
                    <th class="py-2">Status</th>
                    <th class="py-2">Action</th>
                  </tr>
                </thead>
                <tbody id="ordersTableBody">
                  ${orders.length ? orders.map(o=>orderRow(o)).join('') : `
                    <tr class="border-t border-soft">
                      <td class="py-6 text-muted" colspan="5">No orders yet. Place one from storefront to test.</td>
                    </tr>
                  `}
                </tbody>
              </table>
            </div>

            <div class="mt-4 flex flex-wrap gap-2">
              <button data-action="orders-clear" class="px-4 py-2 rounded-2xl border border-soft hover:bg-card2">Clear all orders</button>
              <button data-action="refresh-admin" class="px-4 py-2 rounded-2xl btn-accent font-semibold">Refresh</button>
            </div>
          </section>
        `;
      }

      function orderRow(o){
        const date = new Date(o.createdAt).toLocaleString();
        const statusPill = statusBadge(o.status);
        return `
          <tr class="border-t border-soft" data-order-row="1" data-id="${escapeHtml(o.id)}">
            <td class="py-3">
              <div class="font-semibold">${escapeHtml(o.id)}</div>
              <div class="text-xs text-muted">${escapeHtml(date)}</div>
            </td>
            <td class="py-3">
              <div class="font-semibold">${escapeHtml(o.customer?.name||'')}</div>
              <div class="text-xs text-muted">${escapeHtml(o.customer?.phone||'')}</div>
            </td>
            <td class="py-3 font-extrabold">${money(o.total||0)}</td>
            <td class="py-3">${statusPill}</td>
            <td class="py-3">
              <div class="flex gap-2">
                <button data-action="order-view" data-id="${escapeHtml(o.id)}" class="px-3 py-2 rounded-xl border border-soft hover:bg-card2">View</button>
                <button data-action="order-quick" data-id="${escapeHtml(o.id)}" data-status="Delivered" class="px-3 py-2 rounded-xl btn-accent font-semibold">Delivered</button>
              </div>
            </td>
          </tr>
        `;
      }

      function statusBadge(status){
        const st = String(status||'Pending');
        const map = {
          Pending: 'border-soft text-muted',
          Delivered: 'bg-accent text-white border-transparent',
          Cancelled: 'border-soft text-muted opacity-70',
        };
        const cls = map[st] || map.Pending;
        return `<span class="inline-flex items-center px-2 py-1 rounded-full border ${cls}">${escapeHtml(st)}</span>`;
      }

      function adminHeaderFooterPanel(){
        const s = state.settings;
        return `
          <section class="bg-surface border border-soft rounded-3xl p-5">
            <div class="text-xl font-extrabold">Header & Footer / Store Settings</div>
            <div class="text-sm text-muted mt-1">Logo upload, store name, WhatsApp, links, and texts.</div>

            <form data-form="store-settings" class="mt-5 grid lg:grid-cols-2 gap-4">
              <div class="space-y-3">
                <div class="grid sm:grid-cols-2 gap-3">
                  <div>
                    <label class="text-sm text-muted">Store Name</label>
                    <input name="storeName" value="${escapeHtml(s.storeName)}" class="mt-1 w-full rounded-2xl bg-card2 border border-soft px-4 py-3 focus-ring" />
                  </div>
                  <div>
                    <label class="text-sm text-muted">WhatsApp Number</label>
                    <input name="whatsappNumber" value="${escapeHtml(s.whatsappNumber)}" class="mt-1 w-full rounded-2xl bg-card2 border border-soft px-4 py-3 focus-ring" placeholder="923..." />
                  </div>
                </div>

                <div>
                  <label class="text-sm text-muted">Announcement bar text</label>
                  <input name="announcement" value="${escapeHtml(s.announcement)}" class="mt-1 w-full rounded-2xl bg-card2 border border-soft px-4 py-3 focus-ring" />
                </div>

                <div>
                  <label class="text-sm text-muted">Hero Title</label>
                  <input name="heroTitle" value="${escapeHtml(s.heroTitle)}" class="mt-1 w-full rounded-2xl bg-card2 border border-soft px-4 py-3 focus-ring" />
                </div>

                <div>
                  <label class="text-sm text-muted">Hero Subtitle</label>
                  <textarea name="heroSubtitle" rows="3" class="mt-1 w-full rounded-2xl bg-card2 border border-soft px-4 py-3 focus-ring">${escapeHtml(s.heroSubtitle)}</textarea>
                </div>

                <label class="inline-flex items-center gap-2 text-sm text-muted">
                  <input type="checkbox" name="showFloatingWhatsApp" ${s.showFloatingWhatsApp ? 'checked' : ''} /> Show floating WhatsApp button
                </label>
              </div>

              <div class="space-y-4">
                <div class="p-4 rounded-2xl bg-card2 border border-soft">
                  <div class="font-semibold">Logo (Upload)</div>
                  <input id="logoUpload" type="file" accept="image/*" class="mt-2 w-full" />
                  <div class="mt-3 rounded-2xl border border-soft bg-surface overflow-hidden">
                    ${(ui.logoDraft || s.logoDataUrl) ? `<img src="${ui.logoDraft || s.logoDataUrl}" class="h-32 w-full object-cover" alt="logo preview"/>` : `<div class="h-32 flex items-center justify-center text-muted">No logo</div>`}
                  </div>
                  <div class="mt-2 flex gap-2">
                    <button type="button" data-action="logo-clear" class="px-4 py-2 rounded-2xl border border-soft hover:bg-card">Remove logo</button>
                    <button type="button" data-action="logo-use-draft" class="px-4 py-2 rounded-2xl btn-accent font-semibold">Use uploaded</button>
                  </div>
                </div>

                <div class="p-4 rounded-2xl bg-card2 border border-soft">
                  <div class="flex items-center justify-between">
                    <div class="font-semibold">Header links</div>
                    <button type="button" data-action="link-add" data-kind="header" class="px-3 py-2 rounded-xl border border-soft hover:bg-card">+ Add</button>
                  </div>
                  <div class="mt-3 space-y-2" id="headerLinksEditor">
                    ${(s.headerLinks||[]).map((l,i)=>linkRow('header', i, l)).join('')}
                  </div>
                </div>

                <div class="p-4 rounded-2xl bg-card2 border border-soft">
                  <div class="flex items-center justify-between">
                    <div class="font-semibold">Footer links</div>
                    <button type="button" data-action="link-add" data-kind="footer" class="px-3 py-2 rounded-xl border border-soft hover:bg-card">+ Add</button>
                  </div>
                  <div class="mt-3 space-y-2" id="footerLinksEditor">
                    ${(s.footerLinks||[]).map((l,i)=>linkRow('footer', i, l)).join('')}
                  </div>
                </div>

                <div>
                  <label class="text-sm text-muted">Footer text</label>
                  <input name="footerText" value="${escapeHtml(s.footerText)}" class="mt-1 w-full rounded-2xl bg-card2 border border-soft px-4 py-3 focus-ring" />
                </div>

                <button class="w-full btn-accent rounded-2xl px-4 py-3 font-semibold">Save settings</button>
              </div>
            </form>
          </section>
        `;
      }

      function linkRow(kind, i, l){
        const label = escapeHtml(l?.label||'');
        const href = escapeHtml(l?.href||'');
        return `
          <div class="grid grid-cols-12 gap-2" data-link-row="${kind}" data-index="${i}">
            <input class="col-span-5 rounded-2xl bg-surface border border-soft px-3 py-2 focus-ring" placeholder="Label" value="${label}" data-field="label" />
            <input class="col-span-6 rounded-2xl bg-surface border border-soft px-3 py-2 focus-ring" placeholder="#section €åÿß https://" value="${href}" data-field="href" />
            <button type="button" data-action="link-remove" data-kind="${kind}" data-index="${i}" class="col-span-1 rounded-2xl border border-soft hover:bg-card">‚úï</button>
          </div>
        `;
      }

      function adminThemePanel(){
        const s = state.settings;
        const themeCards = Object.entries(THEMES).map(([id,t])=>{
          const active = s.themeId === id;
          return `
            <button data-action="theme-set" data-id="${id}" class="text-left p-4 rounded-3xl border ${active ? 'border-transparent bg-card2 ring-2 ring-[color:var(--ring)]' : 'border-soft bg-surface hover:bg-card2'}">
              <div class="flex items-center justify-between">
                <div class="font-extrabold">${escapeHtml(t.name)}</div>
                ${active ? `<span class="text-xs px-2 py-1 rounded-full bg-accent text-white">Active</span>` : `<span class="text-xs px-2 py-1 rounded-full border border-soft text-muted">Select</span>`}
              </div>
              <div class="mt-3 flex gap-2">
                <span class="h-8 w-8 rounded-2xl" style="background:${t.accent}"></span>
                <span class="h-8 w-8 rounded-2xl" style="background:${t.accent2}"></span>
              </div>
            </button>
          `;
        }).join('');

        return `
          <section class="bg-surface border border-soft rounded-3xl p-5">
            <div class="text-xl font-extrabold">Theme</div>
            <div class="text-sm text-muted mt-1">Change store look instantly.</div>

            <div class="mt-4 grid md:grid-cols-2 xl:grid-cols-3 gap-4">
              ${themeCards}
            </div>

            <div class="mt-6 grid lg:grid-cols-2 gap-4">
              <div class="p-4 rounded-2xl bg-card2 border border-soft">
                <div class="font-semibold">Mode</div>
                <div class="mt-3 flex gap-2">
                  <button data-action="mode-set" data-mode="dark" class="px-4 py-2 rounded-2xl ${s.mode==='dark'?'btn-accent':'border border-soft hover:bg-card'}">Dark</button>
                  <button data-action="mode-set" data-mode="light" class="px-4 py-2 rounded-2xl ${s.mode==='light'?'btn-accent':'border border-soft hover:bg-card'}">Light</button>
                </div>
                <div class="mt-3 text-xs text-muted">Tip: Light mode works great for catalogs.</div>
              </div>

              <div class="p-4 rounded-2xl bg-card2 border border-soft">
                <div class="font-semibold">Custom Accent (optional)</div>
                <div class="text-sm text-muted mt-1">Set your own primary color</div>
                <div class="mt-3 flex items-center gap-3">
                  <input id="customAccent" type="color" value="${escapeHtml(state.settings.customAccent || (THEMES[state.settings.themeId]?.accent || '#10b981'))}" class="h-12 w-16 rounded-2xl border border-soft bg-surface" />
                  <button data-action="custom-accent-use" class="px-4 py-2 rounded-2xl btn-accent font-semibold">Use</button>
                  <button data-action="custom-accent-clear" class="px-4 py-2 rounded-2xl border border-soft hover:bg-card">Reset</button>
                </div>
              </div>
            </div>
          </section>
        `;
      }

      function adminDesignPanel(){
        const d = state.settings.design || structuredClone(DEFAULT_STATE.settings.design);
        const bgPreview = ui.bgDraft || d.backgroundDataUrl;

        return `
          <section class="bg-surface border border-soft rounded-3xl p-5">
            <div class="text-xl font-extrabold">Design & Typography</div>
            <div class="text-sm text-muted mt-1">Background image upload + hero text styling (size/bold/italic/color) + overall font scale.</div>

            <form data-form="design" class="mt-5 grid lg:grid-cols-2 gap-4">
              <div class="space-y-4">
                <div class="p-4 rounded-2xl bg-card2 border border-soft">
                  <div class="font-semibold">Background Image (Upload)</div>
                  <input id="bgUpload" type="file" accept="image/*" class="mt-2 w-full" />
                  <div class="mt-3 rounded-2xl border border-soft bg-surface overflow-hidden">
                    ${bgPreview ? `<img src="${bgPreview}" class="h-40 w-full object-cover" alt="bg preview"/>` : `<div class="h-40 flex items-center justify-center text-muted">No background image</div>`}
                  </div>
                  <div class="mt-2 flex flex-wrap gap-2">
                    <button type="button" data-action="bg-use-draft" class="px-4 py-2 rounded-2xl btn-accent font-semibold">Use uploaded</button>
                    <button type="button" data-action="bg-clear" class="px-4 py-2 rounded-2xl border border-soft hover:bg-card">Remove background</button>
                  </div>
                  <div class="mt-2 text-xs text-muted">Background is saved locally in browser storage.</div>
                </div>

                <div class="p-4 rounded-2xl bg-card2 border border-soft">
                  <div class="font-semibold">Overall text size (Font Scale)</div>
                  <div class="mt-3">
                    <input type="range" name="fontScale" min="0.85" max="1.25" step="0.05" value="${escapeHtml(d.fontScale||1)}" class="w-full" />
                    <div class="mt-1 text-xs text-muted">Current: <b>${escapeHtml(String(d.fontScale||1))}</b></div>
                  </div>
                </div>
              </div>

              <div class="space-y-4">
                <div class="p-4 rounded-2xl bg-card2 border border-soft">
                  <div class="font-semibold">Hero Title Styling</div>
                  <div class="mt-3 grid sm:grid-cols-2 gap-3">
                    <div>
                      <label class="text-sm text-muted">Title size</label>
                      <input class="mt-2 w-full" type="range" name="heroTitleSize" min="30" max="90" step="1" value="${escapeHtml(d.heroTitleSize||56)}" />
                      <div class="mt-1 text-xs text-muted">${escapeHtml(d.heroTitleSize||56)} px</div>
                    </div>
                    <div>
                      <label class="text-sm text-muted">Title color</label>
                      <input class="mt-2 h-12 w-full rounded-2xl border border-soft bg-surface" type="color" name="heroTitleColor" value="${escapeHtml(d.heroTitleColor || (state.settings.mode==='light' ? '#0f172a' : '#e5e7eb'))}" />
                    </div>
                  </div>
                  <div class="mt-3 flex flex-wrap gap-4">
                    <label class="inline-flex items-center gap-2 text-sm text-muted">
                      <input type="checkbox" name="heroTitleBold" ${d.heroTitleBold ? 'checked' : ''} /> Bold
                    </label>
                    <label class="inline-flex items-center gap-2 text-sm text-muted">
                      <input type="checkbox" name="heroTitleItalic" ${d.heroTitleItalic ? 'checked' : ''} /> Italic
                    </label>
                  </div>
                </div>

                <div class="p-4 rounded-2xl bg-card2 border border-soft">
                  <div class="font-semibold">Hero Subtitle Styling</div>
                  <div class="mt-3 grid sm:grid-cols-2 gap-3">
                    <div>
                      <label class="text-sm text-muted">Subtitle size</label>
                      <input class="mt-2 w-full" type="range" name="heroSubtitleSize" min="12" max="40" step="1" value="${escapeHtml(d.heroSubtitleSize||18)}" />
                      <div class="mt-1 text-xs text-muted">${escapeHtml(d.heroSubtitleSize||18)} px</div>
                    </div>
                    <div>
                      <label class="text-sm text-muted">Subtitle color</label>
                      <input class="mt-2 h-12 w-full rounded-2xl border border-soft bg-surface" type="color" name="heroSubtitleColor" value="${escapeHtml(d.heroSubtitleColor || (state.settings.mode==='light' ? '#475569' : '#94a3b8'))}" />
                    </div>
                  </div>
                  <div class="mt-3 flex flex-wrap gap-4">
                    <label class="inline-flex items-center gap-2 text-sm text-muted">
                      <input type="checkbox" name="heroSubtitleItalic" ${d.heroSubtitleItalic ? 'checked' : ''} /> Italic
                    </label>
                  </div>
                </div>

                <button class="w-full btn-accent rounded-2xl px-4 py-3 font-semibold">Save design settings</button>
              </div>
            </form>
          </section>
        `;
      }

      function adminCouponPanel(){
        const c = state.settings.coupon || { enabled:true, code:'WEX10', percent:10 };
        return `
          <section class="bg-surface border border-soft rounded-3xl p-5">
            <div class="text-xl font-extrabold">Coupon</div>
            <div class="text-sm text-muted mt-1">Set coupon code and discount percent.</div>

            <form data-form="coupon" class="mt-5 grid lg:grid-cols-2 gap-4">
              <div class="p-4 rounded-2xl bg-card2 border border-soft space-y-3">
                <label class="inline-flex items-center gap-2 text-sm text-muted">
                  <input type="checkbox" name="enabled" ${c.enabled ? 'checked' : ''} /> Enable coupon
                </label>
                <div>
                  <label class="text-sm text-muted">Coupon Code</label>
                  <input required name="code" value="${escapeHtml(c.code)}" class="mt-1 w-full rounded-2xl bg-surface border border-soft px-4 py-3 focus-ring" />
                </div>
                <div>
                  <label class="text-sm text-muted">Discount Percent</label>
                  <input required name="percent" type="number" min="1" max="90" value="${escapeHtml(c.percent)}" class="mt-1 w-full rounded-2xl bg-surface border border-soft px-4 py-3 focus-ring" />
                </div>
                <button class="w-full btn-accent rounded-2xl px-4 py-3 font-semibold">Save coupon</button>
              </div>

              <div class="p-4 rounded-2xl bg-card2 border border-soft">
                <div class="font-semibold">Preview</div>
                <div class="mt-2 text-sm text-muted">
                  Customer checkout par code <b>${escapeHtml(c.code)}</b> dalega to <b>${Number(c.percent||10)}%</b> discount apply ho ga.
                </div>
                <div class="mt-4 p-4 rounded-2xl bg-surface border border-soft">
                  <div class="text-sm text-muted">Example subtotal</div>
                  <div class="mt-1 text-2xl font-extrabold">${money(5000)}</div>
                  <div class="mt-2 text-sm text-muted">Discount (${Number(c.percent||10)}%)</div>
                  <div class="mt-1 font-bold">-${money(Math.round(5000*(Number(c.percent||10))/100))}</div>
                </div>
              </div>
            </form>
          </section>
        `;
      }

      function adminSecurityPanel(){
        return `
          <section class="bg-surface border border-soft rounded-3xl p-5">
            <div class="text-xl font-extrabold">Security</div>
            <div class="text-sm text-muted mt-1">Change admin password & logout.</div>

            <div class="mt-5 grid lg:grid-cols-2 gap-4">
              <div class="p-4 rounded-2xl bg-card2 border border-soft">
                <div class="font-semibold">Change password</div>
                <form data-form="admin-password" class="mt-4 space-y-3">
                  <div>
                    <label class="text-sm text-muted">Current password</label>
                    <input required type="password" name="currentPassword" class="mt-1 w-full rounded-2xl bg-surface border border-soft px-4 py-3 focus-ring" placeholder="Current password" />
                  </div>
                  <div>
                    <label class="text-sm text-muted">New password</label>
                    <input required type="password" name="newPassword" class="mt-1 w-full rounded-2xl bg-surface border border-soft px-4 py-3 focus-ring" placeholder="New password" />
                  </div>
                  <div>
                    <label class="text-sm text-muted">Confirm new password</label>
                    <input required type="password" name="confirmPassword" class="mt-1 w-full rounded-2xl bg-surface border border-soft px-4 py-3 focus-ring" placeholder="Confirm" />
                  </div>
                  <button class="w-full btn-accent rounded-2xl px-4 py-3 font-semibold">Update password</button>
                </form>
              </div>

              <div class="p-4 rounded-2xl bg-card2 border border-soft">
                <div class="font-semibold">Session</div>
                <div class="mt-2 text-sm text-muted">Logout will close admin access until you login again.</div>
                <button data-action="admin-logout" class="mt-4 w-full px-4 py-3 rounded-2xl border border-soft hover:bg-card font-semibold">Logout</button>
                <div class="mt-4 text-xs text-muted">
                  Security note: This is a local demo lock. For real deployments, implement server-side authentication.
                </div>
              </div>
            </div>
          </section>
        `;
      }

      function adminDataPanel(){
        const b = backendCfg();
        const localUpdated = state.updatedAt ? new Date(state.updatedAt).toLocaleString() : '‚Äî';
        return `
          <section class="bg-surface border border-soft rounded-3xl p-5">
            <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3">
              <div>
                <div class="text-xl font-extrabold">Cloud Sync (Firebase)</div>
                <div class="text-sm text-muted mt-1">Sirf HTML file se multiple devices par products/orders/settings sync karne ke liye Firebase Realtime Database use karein.</div>
              </div>
              <div class="text-xs text-muted">Local updated: <span class="font-semibold">${escapeHtml(localUpdated)}</span></div>
            </div>

            <form data-form="backend" class="mt-5 grid lg:grid-cols-2 gap-4">
              <div class="p-4 rounded-2xl bg-card2 border border-soft space-y-3">
                <input type="hidden" name="provider" value="firebase" />

                <label class="inline-flex items-center gap-2 text-sm text-muted">
                  <input type="checkbox" name="enabled" ${b.enabled ? 'checked' : ''} /> Enable cloud sync
                </label>

                <div>
                  <label class="text-sm text-muted">Firebase Database URL (base)</label>
                  <input name="baseUrl" value="${escapeHtml(b.baseUrl)}" class="mt-1 w-full rounded-2xl bg-surface border border-soft px-4 py-3 focus-ring" placeholder="https://YOUR-PROJECT-default-rtdb.firebaseio.com" />
                  <div class="mt-1 text-xs text-muted">Firebase Console ‚Üí Realtime Database ‚Üí copy database URL. (Trailing / mat lagayen.)</div>
                </div>

                <div class="grid sm:grid-cols-2 gap-3">
                  <div>
                    <label class="text-sm text-muted">Path (node)</label>
                    <input name="path" value="${escapeHtml(b.path)}" class="mt-1 w-full rounded-2xl bg-surface border border-soft px-4 py-3 focus-ring" placeholder="wexwear_state_v1" />
                    <div class="mt-1 text-xs text-muted">Example: <code class="px-1.5 py-0.5 rounded bg-card border border-soft">wexwear_state_v1</code></div>
                  </div>
                  <div>
                    <label class="text-sm text-muted">Auth token (optional)</label>
                    <input name="token" value="${escapeHtml(b.token)}" class="mt-1 w-full rounded-2xl bg-surface border border-soft px-4 py-3 focus-ring" placeholder="Database secret / auth token" />
                    <div class="mt-1 text-xs text-muted">Agar rules public hain to blank rehne dein.</div>
                  </div>
                </div>

                <label class="inline-flex items-center gap-2 text-sm text-muted">
                  <input type="checkbox" name="autoSync" ${b.autoSync ? 'checked' : ''} /> Auto push on changes
                </label>

                <button class="w-full btn-accent rounded-2xl px-4 py-3 font-semibold">Save cloud settings</button>
              </div>

              <div class="p-4 rounded-2xl bg-card2 border border-soft">
                <div class="font-semibold">Actions</div>
                <div class="mt-3 flex flex-wrap gap-2">
                  <button type="button" data-action="cloud-test" class="px-4 py-2 rounded-2xl border border-soft hover:bg-card">Test</button>
                  <button type="button" data-action="cloud-pull" class="px-4 py-2 rounded-2xl border border-soft hover:bg-card">Pull</button>
                  <button type="button" data-action="cloud-pull-force" class="px-4 py-2 rounded-2xl border border-soft hover:bg-card">Force Pull</button>
                  <button type="button" data-action="cloud-push" class="px-4 py-2 rounded-2xl btn-accent font-semibold">Push</button>
                </div>

                <div class="mt-4 text-sm text-muted">
                  <div class="font-semibold text-[color:var(--text)]">Firebase setup (quick)</div>
                  <ol class="list-decimal pl-5 mt-2 space-y-1">
                    <li>Firebase Console ‚Üí Build ‚Üí Realtime Database ‚Üí <b>Create Database</b></li>
                    <li><b>Rules (demo only)</b>: <code class="px-1.5 py-0.5 rounded bg-card border border-soft">{"rules":{ ".read":true, ".write":true }}</code></li>
                    <li>Database URL copy kar ke upar paste karein.</li>
                    <li>Save ‚Üí phir <b>Push</b> (apna local data cloud par bhejne ke liye) €åÿß <b>Pull</b> (cloud se local overwrite).</li>
                  </ol>
                  <div class="mt-3 text-xs">
                    Security note: Public rules production ke liye safe nahi. Real deployment me Firebase Auth + rules required.
                  </div>
                </div>
              </div>
            </form>
          </section>

          <section class="bg-surface border border-soft rounded-3xl p-5">
            <div class="text-xl font-extrabold">Backup / Reset</div>
            <div class="text-sm text-muted mt-1">Export state as JSON, restore, or reset everything.</div>

            <div class="mt-5 grid lg:grid-cols-2 gap-4">
              <div class="p-4 rounded-2xl bg-card2 border border-soft">
                <div class="font-semibold">Backup (JSON)</div>
                <textarea id="backupJson" class="mt-3 w-full h-56 rounded-2xl bg-surface border border-soft px-4 py-3 focus-ring text-xs" spellcheck="false">${escapeHtml(JSON.stringify(state, null, 2))}</textarea>
                <div class="mt-3 flex flex-wrap gap-2">
                  <button data-action="backup-copy" class="px-4 py-2 rounded-2xl btn-accent font-semibold">Copy</button>
                  <button data-action="backup-download" class="px-4 py-2 rounded-2xl border border-soft hover:bg-card">Download</button>
                  <button data-action="refresh-admin" class="px-4 py-2 rounded-2xl border border-soft hover:bg-card">Refresh</button>
                </div>
              </div>
              <div class="p-4 rounded-2xl bg-card2 border border-soft">
                <div class="font-semibold">Restore</div>
                <div class="text-sm text-muted mt-1">Paste JSON and restore (overwrites current).</div>
                <textarea id="restoreJson" class="mt-3 w-full h-40 rounded-2xl bg-surface border border-soft px-4 py-3 focus-ring text-xs" spellcheck="false" placeholder="Paste JSON here..."></textarea>
                <div class="mt-3 flex flex-wrap gap-2">
                  <button data-action="restore" class="px-4 py-2 rounded-2xl btn-accent font-semibold">Restore</button>
                  <button data-action="reset-all" class="px-4 py-2 rounded-2xl border border-soft hover:bg-card">Reset to default</button>
                  <button data-action="cart-reset" class="px-4 py-2 rounded-2xl border border-soft hover:bg-card">Clear cart</button>
                </div>
              </div>
            </div>
          </section>
        `;
      }

      // ---------- ROUTER ----------
      function route(){
        const isAdmin = location.hash === '#admin';
        $('#storeApp').classList.toggle('hidden', isAdmin);
        $('#adminApp').classList.toggle('hidden', !isAdmin);
        if(isAdmin) renderAdminGate();
        else renderStore();
      }

      // ---------- ORDER MODAL ----------
      function openOrderModal(orderId){
        const o = state.orders.find(x=>x.id===orderId);
        if(!o){ toast('Order not found', 'Orders'); return; }
        ui.viewingOrderId = orderId;
        $('#orderModalTitle').textContent = `Order: ${o.id}`;
        $('#orderModalSub').textContent = `${new Date(o.createdAt).toLocaleString()} ‚Ä¢ ${o.status}`;
        $('#orderCustomer').innerHTML = `
          <div><b>Name:</b> ${escapeHtml(o.customer?.name||'')}</div>
          <div><b>Phone:</b> ${escapeHtml(o.customer?.phone||'')}</div>
          <div><b>City:</b> ${escapeHtml(o.customer?.city||'')}</div>
        `;
        $('#orderDelivery').innerHTML = `
          <div><b>Address:</b> ${escapeHtml(o.customer?.address||'')}</div>
          ${o.customer?.deliveryNote ? `<div><b>Delivery:</b> ${escapeHtml(o.customer.deliveryNote)}</div>`:''}
          ${o.customer?.notes ? `<div><b>Notes:</b> ${escapeHtml(o.customer.notes)}</div>`:''}
          <div class="mt-2"><b>Status:</b> ${escapeHtml(o.status)}</div>
        `;

        $('#orderItems').innerHTML = (o.items||[]).map(it=>{
          const custom = it.custom?.text ? `
            <div class="text-xs text-muted mt-0.5">Print: <span class="text-accent font-semibold">${escapeHtml(it.custom.text)}</span> ‚Ä¢ ${escapeHtml(it.custom.color)} ‚Ä¢ ${it.custom.size}px${it.custom.bold?' ‚Ä¢ bold':''}${it.custom.italic?' ‚Ä¢ italic':''}</div>
          ` : '';
          return `
            <div class="p-3 rounded-2xl border border-soft bg-card2">
              <div class="flex items-start justify-between gap-3">
                <div>
                  <div class="font-semibold">${escapeHtml(it.title)}</div>
                  <div class="text-sm text-muted">${money(it.price)} √ó ${it.qty}</div>
                  ${custom}
                </div>
                <div class="font-extrabold">${money(Number(it.price||0)*Number(it.qty||0))}</div>
              </div>
            </div>
          `;
        }).join('');

        $('#orderSubtotal').textContent = money(o.subtotal||0);
        $('#orderDiscount').textContent = `- ${money(o.discount||0)}`;
        $('#orderTotal').textContent = money(o.total||0);

        $('#orderOverlay').classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
      }

      function closeOrderModal(){
        $('#orderOverlay').classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
        ui.viewingOrderId = null;
      }

      function updateOrderStatus(orderId, status){
        const o = state.orders.find(x=>x.id===orderId);
        if(!o) return;
        o.status = status;
        saveState();
        toast(`Order ${orderId} ‚Üí ${status}`, 'Updated');
        if(location.hash==='#admin' && ui.adminAuthed){
          renderAdmin();
          wireAdminOrdersFilter();
        }
        if($('#orderOverlay') && !$('#orderOverlay').classList.contains('hidden')) openOrderModal(orderId);
      }

      // ---------- FILE HELPERS ----------
      function fileToDataUrl(file){
        return new Promise((resolve, reject)=>{
          const reader = new FileReader();
          reader.onload = ()=> resolve(reader.result);
          reader.onerror = ()=> reject(new Error('File read failed'));
          reader.readAsDataURL(file);
        });
      }

      // ---------- SEARCH/FILTER ----------
      function wireStoreSearch(){
        const inp = $('#productSearch');
        if(!inp) return;
        inp.addEventListener('input', ()=>{
          const q = inp.value.trim().toLowerCase();
          const grid = $('#productGrid');
          if(!grid) return;
          const cards = $$('#productGrid > div');
          cards.forEach(card=>{
            const title = (card.querySelector('.font-bold')?.textContent || '').toLowerCase();
            card.style.display = title.includes(q) ? '' : 'none';
          });
        });
      }

      function wireAdminOrdersFilter(){
        const search = $('#adminOrderSearch');
        const filter = $('#adminOrderFilter');
        const body = $('#ordersTableBody');
        if(!search || !filter || !body) return;

        function apply(){
          const q = search.value.trim().toLowerCase();
          const st = filter.value;
          const rows = $$('[data-order-row="1"]', body);
          rows.forEach(r=>{
            const id = (r.querySelector('td:nth-child(1) .font-semibold')?.textContent || '').toLowerCase();
            const name = (r.querySelector('td:nth-child(2) .font-semibold')?.textContent || '').toLowerCase();
            const phone = (r.querySelector('td:nth-child(2) .text-xs')?.textContent || '').toLowerCase();
            const status = (r.querySelector('td:nth-child(4) span')?.textContent || '').trim();
            const okQ = !q || id.includes(q) || name.includes(q) || phone.includes(q);
            const okS = !st || status === st;
            r.style.display = (okQ && okS) ? '' : 'none';
          });
        }
        search.addEventListener('input', apply);
        filter.addEventListener('change', apply);
      }

      // ---------- EXPORT ----------
      function exportOrdersCsv(){
        const rows = [['id','date','status','name','phone','city','address','subtotal','discount','total','coupon']];
        for(const o of (state.orders||[])){
          rows.push([
            o.id,
            new Date(o.createdAt).toISOString(),
            o.status,
            o.customer?.name||'',
            o.customer?.phone||'',
            o.customer?.city||'',
            (o.customer?.address||'').replaceAll('\n',' '),
            o.subtotal||0,
            o.discount||0,
            o.total||0,
            o.coupon?.code||''
          ]);
        }
        const csv = rows.map(r=>r.map(v=>{
          const s = String(v ?? '');
          return /[",\n]/.test(s) ? `"${s.replaceAll('"','""')}"` : s;
        }).join(',')).join('\n');

        const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `wexwear-orders-${new Date().toISOString().slice(0,10)}.csv`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      // ---------- EVENTS (DELEGATION) ----------
      document.addEventListener('click', async (e)=>{
        const btn = e.target.closest('[data-action]');
        if(!btn) return;
        const action = btn.dataset.action;

        if(action === 'toast-close') $('#toast').classList.add('hidden');

        if(action === 'mobile-menu') $('#mobileMenu')?.classList.toggle('hidden');

        // Cart
        if(action === 'cart-open') openCart();
        if(action === 'cart-close') closeCart();
        if(action === 'cart-clear') { clearCart(); toast('Cart cleared'); }

        // Product actions
        if(action === 'add') addToCart(btn.dataset.id);
        if(action === 'customize') openCustomizer(btn.dataset.id, 'add');
        if(action === 'customize-edit') openCustomizer(btn.dataset.id, 'edit');

        if(action === 'remove') removeFromCart(btn.dataset.id);
        if(action === 'qty') setQty(btn.dataset.id, (cart.items.find(i=>i.productId===btn.dataset.id)?.qty||1) + Number(btn.dataset.delta||0));

        // Custom modal
        if(action === 'custom-close') closeCustomizer();

        // Checkout
        if(action === 'checkout-open') { closeCart(); openCheckout(); }
        if(action === 'checkout-close') closeCheckout();

        if(action === 'coupon-apply'){
          const code = $('#couponInput')?.value || '';
          const c = validateCoupon(code);
          if(!code.trim()){
            ui.couponApplied = null;
            $('#couponStatus').textContent = 'Coupon cleared.';
          } else if(!c){
            ui.couponApplied = null;
            $('#couponStatus').textContent = 'Invalid coupon code.';
          } else {
            ui.couponApplied = c;
            $('#couponStatus').textContent = `Applied: ${c.code} (${c.percent}% off)`;
          }
          renderCheckoutSummary();
        }

        if(action === 'open-whatsapp'){
          const s = state.settings;
          openWhatsAppWithText(`Assalam o Alaikum! I want to print a custom product from ${s.storeName}. Please guide.`);
        }

        if(action === 'buy-wa'){
          const p = productById(btn.dataset.id);
          if(!p) return;
          const s = state.settings;
          const msg = `*${s.storeName}*\nI want to order: *${p.title}*\nPrice: ${money(p.price)}\n\nPlease confirm print options & delivery time.`;
          openWhatsAppWithText(msg);
        }

        if(action === 'refresh-store') { renderStore(); wireStoreSearch(); toast('Store refreshed'); }
        if(action === 'refresh-admin') { renderAdmin(); wireAdminOrdersFilter(); toast('Admin refreshed'); }

        if(action === 'toggle-mode'){
          state.settings.mode = state.settings.mode === 'light' ? 'dark' : 'light';
          saveState();
          applyTheme();
          route();
        }

        if(action === 'reset-demo'){
          if(!confirm('Reset demo data? (products, orders, settings, cart)')) return;
          localStorage.removeItem(LS_KEY);
          localStorage.removeItem(LS_CART);
          sessionStorage.removeItem(SS_ADMIN);
          state = loadState();
          cart = loadCart();
          ui.adminTab = 'dashboard';
          ui.editingProductId = null;
          ui.viewingOrderId = null;
          ui.addImageDraft = '';
          ui.editImageDraft = '';
          ui.logoDraft = '';
          ui.bgDraft = '';
          ui.couponApplied = null;
          ui._showAddProduct = false;
          setAdminAuthed(false);
          applyTheme();
          route();
          toast('Demo reset');
        }

        // Admin navigation
        if(action === 'admin-tab'){
          ui.adminTab = btn.dataset.tab;
          renderAdmin();
          wireAdminOrdersFilter();
        }

        if(action === 'admin-logout'){
          setAdminAuthed(false);
          toast('Logged out', 'Admin');
          renderAdminGate();
        }

        // Products
        if(action === 'product-add-toggle'){
          ui._showAddProduct = !ui._showAddProduct;
          ui.addImageDraft = '';
          renderAdmin();
        }
        if(action === 'product-add-cancel'){
          ui._showAddProduct = false;
          ui.addImageDraft = '';
          renderAdmin();
        }
        if(action === 'product-edit'){
          ui.editingProductId = btn.dataset.id;
          ui.editImageDraft = '';
          renderAdmin();
        }
        if(action === 'product-edit-cancel'){
          ui.editingProductId = null;
          ui.editImageDraft = '';
          renderAdmin();
        }
        if(action === 'product-delete'){
          const id = btn.dataset.id;
          if(!confirm('Delete this product?')) return;
          state.products = state.products.filter(p=>p.id!==id);
          saveState();
          ui.editingProductId = null;
          ui.editImageDraft = '';
          renderAdmin();
          toast('Product deleted');
        }
        if(action === 'product-duplicate'){
          const p = productById(btn.dataset.id);
          if(!p) return;
          const copy = structuredClone(p);
          copy.id = uid('P');
          copy.title = p.title + ' (Copy)';
          state.products.unshift(copy);
          saveState();
          renderAdmin();
          toast('Product duplicated');
        }

        // Links
        if(action === 'link-add'){
          const kind = btn.dataset.kind;
          const list = (kind==='header') ? (state.settings.headerLinks||[]) : (state.settings.footerLinks||[]);
          list.push({ label:'New link', href:'#' });
          if(kind==='header') state.settings.headerLinks = list;
          else state.settings.footerLinks = list;
          saveState();
          renderAdmin();
          toast('Link added');
        }
        if(action === 'link-remove'){
          const kind = btn.dataset.kind;
          const idx = Number(btn.dataset.index);
          const list = (kind==='header') ? (state.settings.headerLinks||[]) : (state.settings.footerLinks||[]);
          list.splice(idx,1);
          if(kind==='header') state.settings.headerLinks = list;
          else state.settings.footerLinks = list;
          saveState();
          renderAdmin();
          toast('Link removed');
        }

        // Logo
        if(action === 'logo-use-draft'){
          if(!ui.logoDraft){ toast('Please upload a logo first', 'Logo'); return; }
          state.settings.logoDataUrl = ui.logoDraft;
          ui.logoDraft = '';
          saveState();
          route();
          toast('Logo updated');
        }
        if(action === 'logo-clear'){
          state.settings.logoDataUrl = '';
          ui.logoDraft = '';
          saveState();
          route();
          toast('Logo removed');
        }

        // Background
        if(action === 'bg-use-draft'){
          if(!ui.bgDraft){ toast('Please upload a background image first', 'Background'); return; }
          state.settings.design.backgroundDataUrl = ui.bgDraft;
          ui.bgDraft = '';
          saveState();
          applyTheme();
          route();
          toast('Background updated');
        }
        if(action === 'bg-clear'){
          state.settings.design.backgroundDataUrl = '';
          ui.bgDraft = '';
          saveState();
          applyTheme();
          route();
          toast('Background removed');
        }

        // Theme
        if(action === 'theme-set'){
          state.settings.themeId = btn.dataset.id;
          state.settings.customAccent = '';
          saveState();
          applyTheme();
          route();
          toast('Theme applied');
        }
        if(action === 'mode-set'){
          state.settings.mode = btn.dataset.mode;
          saveState();
          applyTheme();
          route();
          toast('Mode updated');
        }
        if(action === 'custom-accent-use'){
          const val = $('#customAccent')?.value;
          state.settings.customAccent = val || '';
          saveState();
          applyTheme();
          route();
          toast('Custom color applied');
        }
        if(action === 'custom-accent-clear'){
          state.settings.customAccent = '';
          saveState();
          applyTheme();
          route();
          toast('Custom color reset');
        }

        // Orders
        if(action === 'order-view') openOrderModal(btn.dataset.id);
        if(action === 'order-close') closeOrderModal();
        if(action === 'order-quick') updateOrderStatus(btn.dataset.id, btn.dataset.status);
        if(action === 'order-status'){
          if(!ui.viewingOrderId) return;
          updateOrderStatus(ui.viewingOrderId, btn.dataset.status);
        }
        if(action === 'order-open-wa'){
          if(!ui.viewingOrderId) return;
          const o = state.orders.find(x=>x.id===ui.viewingOrderId);
          if(!o) return;
          openWhatsAppWithText(waMessageForOrder(o));
        }

        if(action === 'orders-clear'){
          if(!confirm('Clear ALL orders?')) return;
          state.orders = [];
          saveState();
          renderAdmin();
          toast('Orders cleared');
        }
        if(action === 'orders-export') exportOrdersCsv();

        // Cloud Sync (Firebase)
        if(action === 'cloud-test') backendTest().catch(err=>toast(err.message || 'Test failed', 'Cloud Sync'));
        if(action === 'cloud-push') backendPush().catch(err=>toast(err.message || 'Push failed', 'Cloud Sync'));
        if(action === 'cloud-pull') backendPull().catch(err=>toast(err.message || 'Pull failed', 'Cloud Sync'));
        if(action === 'cloud-pull-force') backendPull({ force:true }).catch(err=>toast(err.message || 'Pull failed', 'Cloud Sync'));

        // Data
        if(action === 'backup-copy'){
          const t = $('#backupJson');
          t.select();
          document.execCommand('copy');
          toast('Copied JSON');
        }
        if(action === 'backup-download'){
          const blob = new Blob([JSON.stringify(state, null, 2)], {type:'application/json;charset=utf-8'});
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `wexwear-backup-${new Date().toISOString().slice(0,10)}.json`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        }
        if(action === 'restore'){
          const raw = $('#restoreJson')?.value || '';
          const parsed = safeParse(raw, null);
          if(!parsed){ toast('Invalid JSON', 'Restore'); return; }
          state = migrateLoaded(parsed);
          saveState();
          applyTheme();
          route();
          toast('Restored');
        }
        if(action === 'reset-all'){
          if(!confirm('Reset EVERYTHING to default?')) return;
          state = structuredClone(DEFAULT_STATE);
          saveState();
          applyTheme();
          route();
          toast('Reset to default');
        }
        if(action === 'cart-reset'){
          localStorage.removeItem(LS_CART);
          cart = loadCart();
          toast('Cart cleared');
          route();
        }
      });

      // Live preview updates for customizer
      ['input','change'].forEach(evt=>{
        document.addEventListener(evt, (e)=>{
          if(!ui.customDraft) return;
          const t = e.target;
          if(!t) return;
          if(t.id==='customText') ui.customDraft.text = t.value;
          if(t.id==='customColor') ui.customDraft.color = t.value;
          if(t.id==='customSize') { ui.customDraft.size = Number(t.value||42); $('#customSizeVal').textContent = String(ui.customDraft.size); }
          if(t.id==='customBold') ui.customDraft.bold = t.checked;
          if(t.id==='customItalic') ui.customDraft.italic = t.checked;
          if(['customText','customColor','customSize','customBold','customItalic'].includes(t.id)) renderCustomizerPreview();
        });
      });

      document.addEventListener('submit', async (e)=>{
        const form = e.target;

        if(form.matches('[data-form="checkout"]')){
          e.preventDefault();
          placeOrder(form);
        }

        if(form.matches('[data-form="custom"]')){
          e.preventDefault();
          if(!ui.customDraft) return;
          const p = productById(ui.customDraft.productId);
          if(!p) return;
          const custom = {
            text: String(ui.customDraft.text||'').trim().slice(0,80),
            color: String(ui.customDraft.color||'#ffffff'),
            size: Math.max(10, Math.min(120, Number(ui.customDraft.size||42)||42)),
            bold: !!ui.customDraft.bold,
            italic: !!ui.customDraft.italic,
          };

          if(p.customizable && !custom.text){
            toast('Please enter print text (or add a space if you really want blank).', 'Customize');
            return;
          }

          const mode = ui.customDraft.mode;
          closeCustomizer();
          if(mode==='edit') setCartCustom(p.id, custom);
          else addToCart(p.id, 1, custom);
        }

        if(form.matches('[data-form="admin-login"]')){
          e.preventDefault();
          const fd = new FormData(form);
          const pw = String(fd.get('password')||'');
          const hash = await sha256Hex(pw);
          if(hash !== state.settings.security.passwordHash){
            toast('Wrong password', 'Admin');
            return;
          }
          setAdminAuthed(true);
          toast('Welcome back', 'Admin');
          renderAdmin();
          wireAdminOrdersFilter();
        }

        if(form.matches('[data-form="admin-setup"]')){
          e.preventDefault();
          const fd = new FormData(form);
          const a = String(fd.get('newPassword')||'');
          const b = String(fd.get('confirmPassword')||'');
          if(a.length < 4){ toast('Password must be at least 4 characters.', 'Setup'); return; }
          if(a !== b){ toast('Passwords do not match.', 'Setup'); return; }
          state.settings.security.passwordHash = await sha256Hex(a);
          saveState();
          setAdminAuthed(true);
          toast('Password set', 'Admin');
          renderAdmin();
          wireAdminOrdersFilter();
        }

        if(form.matches('[data-form="admin-password"]')){
          e.preventDefault();
          const fd = new FormData(form);
          const cur = String(fd.get('currentPassword')||'');
          const next = String(fd.get('newPassword')||'');
          const confirmPw = String(fd.get('confirmPassword')||'');

          const curHash = await sha256Hex(cur);
          if(curHash !== state.settings.security.passwordHash){
            toast('Current password is incorrect.', 'Security');
            return;
          }
          if(next.length < 4){ toast('New password must be at least 4 characters.', 'Security'); return; }
          if(next !== confirmPw){ toast('New passwords do not match.', 'Security'); return; }

          state.settings.security.passwordHash = await sha256Hex(next);
          saveState();
          toast('Password updated', 'Security');
          form.reset();
        }

        if(form.matches('[data-form="add-product"]')){
          e.preventDefault();
          const fd = new FormData(form);
          const p = {
            id: uid('P'),
            title: String(fd.get('title')||'').trim(),
            price: Number(fd.get('price')||0),
            compareAt: fd.get('compareAt') ? Number(fd.get('compareAt')||0) : 0,
            inStock: !!fd.get('inStock'),
            customizable: !!fd.get('customizable'),
            badge: String(fd.get('badge')||'').trim(),
            emoji: String(fd.get('emoji')||'').trim(),
            imageDataUrl: ui.addImageDraft || '',
            description: String(fd.get('description')||'').trim(),
          };
          if(!p.title || !(p.price>0)) { toast('Title and price required', 'Products'); return; }
          state.products.unshift(p);
          saveState();
          ui._showAddProduct = false;
          ui.addImageDraft = '';
          renderAdmin();
          toast('Product added');
        }

        if(form.matches('[data-form="edit-product"]')){
          e.preventDefault();
          const id = form.dataset.id;
          const p = productById(id);
          if(!p) return;
          const fd = new FormData(form);
          p.title = String(fd.get('title')||'').trim();
          p.price = Number(fd.get('price')||0);
          p.compareAt = fd.get('compareAt') ? Number(fd.get('compareAt')||0) : 0;
          p.badge = String(fd.get('badge')||'').trim();
          p.emoji = String(fd.get('emoji')||'').trim();
          p.inStock = !!fd.get('inStock');
          p.customizable = !!fd.get('customizable');
          p.description = String(fd.get('description')||'').trim();
          if(ui.editImageDraft) p.imageDataUrl = ui.editImageDraft;

          saveState();
          ui.editImageDraft = '';
          ui.editingProductId = null;
          renderAdmin();
          toast('Product updated');
        }

        if(form.matches('[data-form="store-settings"]')){
          e.preventDefault();
          const fd = new FormData(form);
          state.settings.storeName = String(fd.get('storeName')||'').trim() || 'WexWear.PK';
          state.settings.whatsappNumber = normalizeWaNumber(String(fd.get('whatsappNumber')||'').trim()) || '923102155721';
          state.settings.announcement = String(fd.get('announcement')||'').trim();
          state.settings.heroTitle = String(fd.get('heroTitle')||'').trim();
          state.settings.heroSubtitle = String(fd.get('heroSubtitle')||'').trim();
          state.settings.showFloatingWhatsApp = !!fd.get('showFloatingWhatsApp');

          const headerRows = $$('[data-link-row="header"]');
          state.settings.headerLinks = headerRows.map(r=>({
            label: r.querySelector('[data-field="label"]')?.value.trim() || '',
            href: r.querySelector('[data-field="href"]')?.value.trim() || '#',
          })).filter(x=>x.label);

          const footerRows = $$('[data-link-row="footer"]');
          state.settings.footerLinks = footerRows.map(r=>({
            label: r.querySelector('[data-field="label"]')?.value.trim() || '',
            href: r.querySelector('[data-field="href"]')?.value.trim() || '#',
          })).filter(x=>x.label);

          state.settings.footerText = String(fd.get('footerText')||'').trim();

          saveState();
          applyTheme();
          route();
          toast('Settings saved');
        }

        if(form.matches('[data-form="coupon"]')){
          e.preventDefault();
          const fd = new FormData(form);
          const enabled = !!fd.get('enabled');
          const code = String(fd.get('code')||'').trim() || 'WEX10';
          const percent = Math.max(1, Math.min(90, Number(fd.get('percent')||10) || 10));
          state.settings.coupon = { enabled, code, percent };
          saveState();
          toast('Coupon saved');
          renderAdmin();
        }

        if(form.matches('[data-form="design"]')){
          e.preventDefault();
          const fd = new FormData(form);
          const d = state.settings.design;
          d.fontScale = Number(fd.get('fontScale')||1) || 1;
          d.heroTitleSize = Number(fd.get('heroTitleSize')||56) || 56;
          d.heroSubtitleSize = Number(fd.get('heroSubtitleSize')||18) || 18;
          d.heroTitleColor = String(fd.get('heroTitleColor')||'');
          d.heroSubtitleColor = String(fd.get('heroSubtitleColor')||'');
          d.heroTitleBold = !!fd.get('heroTitleBold');
          d.heroTitleItalic = !!fd.get('heroTitleItalic');
          d.heroSubtitleItalic = !!fd.get('heroSubtitleItalic');
          saveState();
          applyTheme();
          route();
          toast('Design saved');
        }
      });

      document.addEventListener('change', async (e)=>{
        const el = e.target;
        if(el && el.id === 'addProductImage'){
          const file = el.files?.[0];
          if(!file) return;
          ui.addImageDraft = await fileToDataUrl(file);
          renderAdmin();
          toast('Image selected');
        }
        if(el && el.id === 'editProductImage'){
          const file = el.files?.[0];
          if(!file) return;
          ui.editImageDraft = await fileToDataUrl(file);
          renderAdmin();
          toast('New image selected');
        }
        if(el && el.id === 'logoUpload'){
          const file = el.files?.[0];
          if(!file) return;
          ui.logoDraft = await fileToDataUrl(file);
          renderAdmin();
          toast('Logo selected');
        }
        if(el && el.id === 'bgUpload'){
          const file = el.files?.[0];
          if(!file) return;
          ui.bgDraft = await fileToDataUrl(file);
          renderAdmin();
          toast('Background selected');
        }
      });

      // ---------- INIT ----------
      let state = loadState();
      let cart = loadCart();
      applyTheme();

      // if someone had old ShopHub keys, we intentionally start fresh under new brand
      route();
      wireStoreSearch();
      if(location.hash==='#admin' && ui.adminAuthed) wireAdminOrdersFilter();

      window.addEventListener('hashchange', ()=>{
        route();
        setTimeout(()=>{
          wireStoreSearch();
          if(location.hash==='#admin' && ui.adminAuthed) wireAdminOrdersFilter();
        }, 0);
      });

      renderStoreHeaderBadge();

    })();
  </script>
</body>
</html>